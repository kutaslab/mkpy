<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mkpy.mkh5viewer &mdash; mkpy  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> mkpy
          </a>
              <div class="version">
                0.2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation  (64-bit linux only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples_gallery/mkh5/mkh5_quickstart.html">mkh5 Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AS_howto.html">A. Stoermannâ€™s Gists online</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ExamplesGallery.html">Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../UserGuide.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CheatSheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Learning.html">Background reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ReleaseNotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RolesCredits.html">Roles and credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mkpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
          <li><a href="../mkpy.html">mkpy</a> &raquo;</li>
      <li>mkpy.mkh5viewer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mkpy.mkh5viewer</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>

<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">import</span> <span class="nn">tkinter.font</span> <span class="k">as</span> <span class="nn">tk_font</span>
<span class="kn">import</span> <span class="nn">tkinter.ttk</span> <span class="k">as</span> <span class="nn">ttk</span>
<span class="kn">import</span> <span class="nn">tkinter.filedialog</span> <span class="k">as</span> <span class="nn">tkfd</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="k">as</span> <span class="n">odict</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">mkh5</span>
<span class="kn">import</span> <span class="nn">pprint</span> <span class="k">as</span> <span class="nn">pp</span>

<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># import dpath, dpath.util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dpath</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">pygarv</span> <span class="k">as</span> <span class="n">pg</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">current_function</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">log_exceptions</span>

<span class="c1">## appearance</span>
<span class="c1">## Initial panel dims</span>
<span class="n">VIEW_WIDTH</span> <span class="o">=</span> <span class="mi">1200</span>
<span class="n">VIEW_HEIGHT</span> <span class="o">=</span> <span class="mi">800</span>

<span class="c1"># global styles</span>
<div class="viewcode-block" id="set_styles"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.set_styles">[docs]</a><span class="k">def</span> <span class="nf">set_styles</span><span class="p">():</span>

    <span class="c1"># Poached from tango</span>

    <span class="c1"># Butter       fce94f edd400 c4a000</span>
    <span class="c1"># Orange       fcaf3e f57900 ce5c00</span>
    <span class="c1"># Chocolate    e9b96e c17d11 8f5902</span>
    <span class="c1"># Chameleon    8ae234 73d216 4e9a06</span>
    <span class="c1"># Sky Blue     729fcf 3465a4 204a87</span>
    <span class="c1"># Plum         ad7fa8 75507b 5c3566</span>
    <span class="c1"># Scarlet Red  ef2929 cc0000 a40000</span>
    <span class="c1"># Aluminium    eeeeec d3d7cf babdb6</span>
    <span class="c1">#              888a85  555753  2e3436</span>

    <span class="c1"># Note: frame styles don&#39;t have &#39;active&#39; do have &lt;Enter&gt; bindings</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>

    <span class="c1"># generic_bgc = &#39;#eeeeec&#39; # &#39;white&#39;</span>
    <span class="n">generic_bgc</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>  <span class="c1"># &#39;#fafafa&#39; # &#39;white&#39;</span>

    <span class="c1"># &#39;helvetica&#39; # &#39;TkDefaultFont&#39; # &#39;helvetica&#39;</span>
    <span class="n">fnt_family</span> <span class="o">=</span> <span class="s2">&quot;TkDefaultFont&quot;</span>
    <span class="n">fnt_size</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="c1"># fnt_family = &#39;fixed&#39;</span>
    <span class="c1"># fnt_size = 16</span>
    <span class="n">label_pad</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Aluminium	    eeeeec  d3d7cf  babdb6  (lighter gray)</span>
    <span class="c1">#               888a85  555753  2e3436  (darker gray)</span>
    <span class="n">generic_frame_bgc</span> <span class="o">=</span> <span class="s2">&quot;#d3d7cf&quot;</span>  <span class="c1"># &#39;#babdb6&#39; # &#39;#d3d7cf&#39; # &#39;#eeeeec&#39;,</span>
    <span class="n">generic_frame_fgc</span> <span class="o">=</span> <span class="s2">&quot;#555753&quot;</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;TFrame&quot;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="n">generic_frame_bgc</span>
    <span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;TLabelframe&quot;</span><span class="p">,</span>
        <span class="c1"># background = generic_frame_bgc,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">generic_frame_fgc</span><span class="p">,</span>
        <span class="n">relief</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;TLabelframe.Label&quot;</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">label_pad</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">generic_frame_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Tabs</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;h5nav_style.TNotebook&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">generic_frame_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;h5nav_style.TNotebook.Tab&quot;</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">label_pad</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">generic_frame_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Data block text view ----------------------------------------</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;dblock_table_style.Treeview.Heading&quot;</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;dblock_table_style.Treeview&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># PyGarv Treeview --------------------------------------------------</span>
    <span class="c1"># Scarlet Red	ef2929	cc0000	a40000</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;pygarv_style.TLabelframe&quot;</span><span class="p">,</span> <span class="n">bgc</span><span class="o">=</span><span class="n">generic_frame_bgc</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;pygarv_style.TLabelframe.Label&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#babdb6&quot;</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;#555753&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">pygarv_view_fgc</span> <span class="o">=</span> <span class="s2">&quot;#ef2929&quot;</span>  <span class="c1"># &#39;#cc0000&#39; &#39;#a40000&#39;</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;pygarv_style.Treeview&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">pygarv_view_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># style.map(&#39;pygarv_style.Treeview&#39;,</span>
    <span class="c1">#           background=[(&#39;focus&#39;, pygarv_view_fgc),</span>
    <span class="c1">#                       (&#39;!focus&#39;, generic_bgc)] )</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;pygarv_style.Treeview.Heading&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">pygarv_view_fgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Header Treeview ---------------------------------------------------</span>
    <span class="c1"># Sky Blue	729fcf	3465a4	204a87</span>
    <span class="n">header_view_fgc</span> <span class="o">=</span> <span class="s2">&quot;#3465a4&quot;</span>  <span class="c1"># &#39;#204a87&#39;</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;headerview_style.Treeview&quot;</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">header_view_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">header_view_fgc</span> <span class="o">=</span> <span class="s2">&quot;#3465a4&quot;</span>  <span class="c1"># &#39;#204a87&#39;</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;headerview_style.Treeview.Heading&quot;</span><span class="p">,</span>
        <span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">header_view_fgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># H5 Navigator Tab Treeview ------------------------------------</span>
    <span class="c1"># Plum	        ad7fa8	75507b	5c3566</span>
    <span class="n">h5_view_fgc</span> <span class="o">=</span> <span class="s2">&quot;#75507b&quot;</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;h5view_style.Treeview&quot;</span><span class="p">,</span>
        <span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">generic_bgc</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="n">h5_view_fgc</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="s2">&quot;h5view_style.Treeview.Heading&quot;</span><span class="p">,</span>
        <span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="s2">&quot;#ad7fa8&quot;</span><span class="p">,</span>
        <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="n">fnt_family</span><span class="p">,</span> <span class="n">fnt_size</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">),</span>
    <span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="PyGarvView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvView">[docs]</a><span class="k">class</span> <span class="nc">PyGarvView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;thin wrapper around PyGarvEditor model-view for selecting, editing, deleting pygarv tests</span>

<span class="sd">    Fun facts</span>

<span class="sd">    - the mkh5 data file is *not* modified</span>

<span class="sd">    - View.model.pg maintains the local PyGarv() data model that tracks test results</span>

<span class="sd">    - pygarv tests are tracked and run &quot;what if&quot;</span>

<span class="sd">    - test results are are overlayed for viewing in the scope traces and table</span>
<span class="sd">      scope</span>

<span class="sd">    - test doc may be exported as yaml \*.yarf</span>

<span class="sd">        - open an editor for new/existing tests and hands them off to Model.pygarv to dry run</span>


<span class="sd">    Outline</span>

<span class="sd">    - on init ...</span>

<span class="sd">        - pygarv (comes with a built in catalog of implemented tests)</span>

<span class="sd">        - walk the dblocks and scrape data for pygarv data stream and</span>
<span class="sd">          headers for any pygarv tests</span>

<span class="sd">        - user edits create, delete, update the in-memory test specs</span>

<span class="sd">        - when input validated for type, self.model.pg attemps to run the test</span>

<span class="sd">        - success on running updates the self.pg.pg.tr_docs w/ the test and triggers</span>
<span class="sd">          a view._update() cascade</span>

<span class="sd">        - failure returns the exception for handling by the viewer</span>

<span class="sd">        - Export button dumps the .yarf YAML (= yarf_docs) for the tr_docs</span>

<span class="sd">        - mini-console shows activity and messages</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;a label frame wrapping PyGarvTestView ttk.TreeView which does the work&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pg_editor</span> <span class="o">=</span> <span class="n">PyGarvEditorView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>

    <span class="nd">@log_exceptions</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># only update editor, catalog is static</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pg_editor</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span></div>


<div class="viewcode-block" id="PyGarvEditorView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvEditorView">[docs]</a><span class="k">class</span> <span class="nc">PyGarvEditorView</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pygarv test editor UI</span>

<span class="sd">        layout:</span>

<span class="sd">        - dashboard w/ File I/O, progress bar, mini-console</span>

<span class="sd">        - pygarv catalog (ttk.Treeview)</span>

<span class="sd">        - tests for current datablock (ttk.Treeview)</span>

<span class="sd">        - the catalog and dblock test trees are subclassed from</span>
<span class="sd">          PyGarvTestView in a label frame wrapper</span>

<span class="sd">        Test parameter type validation triggers custom event &lt;&lt;IsValidTestTree&gt;&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># self.config(text=&#39;Catalog&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># dashboard for .Yarf Load, Save, Progress bar</span>
        <span class="n">dash_height</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span> <span class="o">=</span> <span class="n">PyGarvEditorDashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="n">dash_height</span><span class="p">)</span>

        <span class="c1"># pygarv catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">PyGarvCatalogView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>

        <span class="c1"># current dblock test editor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">PyGarvTestView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editor</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># initial panel layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dash_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dash_height</span> <span class="o">+</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

        <span class="c1"># request new editor pull new test from catalog</span>
        <span class="c1"># self.event_add(&#39;&lt;&lt;NewTestFromCatalog&gt;&gt;&#39;, &#39;&lt;Triple-Button&gt;&#39;)</span>


<div class="viewcode-block" id="PyGarvEditorDashboard"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvEditorDashboard">[docs]</a><span class="k">class</span> <span class="nc">PyGarvEditorDashboard</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper for Editor UI controls&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># yarf reader/writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_io</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;File (.yarf)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_io</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">import_yarf</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_io</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Import&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_import</span><span class="p">)</span>
        <span class="n">import_yarf</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">export_yarf</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_io</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Export&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_export</span><span class="p">)</span>
        <span class="n">export_yarf</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># stub to track test running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Progressbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_io</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># mini-console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_console_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;report stuff back to the user</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item : object</span>
<span class="sd">           anything with a sensible __repr__</span>
<span class="sd">        text : str</span>
<span class="sd">           anything else to include in the message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">console_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">INSERT</span><span class="p">)))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{0}</span><span class="s2">] </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">console_idx</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">INSERT</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">INSERT</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_import</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;launch tkinter file viewer to prompt for filename and location&quot;&quot;&quot;</span>
        <span class="n">yarf_f</span> <span class="o">=</span> <span class="n">tkfd</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Import .yarf YAML file tests&quot;</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s2">&quot;.yarf&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;yarf&quot;</span><span class="p">,</span> <span class="s2">&quot;*.yarf&quot;</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">yarf_f</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;importing </span><span class="si">{0}</span><span class="s2"> ... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">_update_tr_docs_from_yaml_f</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">yarf_f</span> <span class="o">=</span> <span class="n">yarf_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;import OK: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;launch tkinter file viewer to prompt for filename and location&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span> <span class="k">as</span> <span class="n">tkfd</span>

        <span class="n">yarf_f</span> <span class="o">=</span> <span class="n">tkfd</span><span class="o">.</span><span class="n">asksaveasfilename</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Export tests as .yarf YAML file&quot;</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s2">&quot;.yarf&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;yarf&quot;</span><span class="p">,</span> <span class="s2">&quot;*.yarf&quot;</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">yarf_f</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">export_yarf_docs</span><span class="p">(</span>
                    <span class="n">yarf_f</span>
                <span class="p">)</span>  <span class="c1"># write *all* yarf docs, not just this dblock</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Export .yarf failed: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Export .yarf OK: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="PyGarvCatalogView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvCatalogView">[docs]</a><span class="k">class</span> <span class="nc">PyGarvCatalogView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;viewer/chooser for available PyGarvTest tests&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parent: widget</span>
<span class="sd">        top_view : Pygarv</span>
<span class="sd">           provides op_view.model, top_view.pg</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Catalog&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span> <span class="o">=</span> <span class="n">PyGarvTreeView</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="s2">&quot;data type&quot;</span><span class="p">],</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;pygarv_style.Treeview&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="c1"># populate the tree w/ PyGarv test catalog .. one time, no need to update</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">get_catalog</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="c1"># make &lt;class &#39;str&#39;&gt; and such friendlier</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">param_types</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pt</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="s2">&quot;character&quot;</span>
                    <span class="k">elif</span> <span class="n">pt</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">pt</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="s2">&quot;numeric&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                        <span class="c1"># add the item</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pts</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># self.catalog_tree.bind(&#39;&lt;B1-Motion&gt;&#39;, self.parent.dragging_test)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_selection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_selected_test</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_selected_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request sibling test editor to pull a test form from the catalog&quot;&quot;&quot;</span>

        <span class="c1"># maybe better done with a virtual event</span>
        <span class="c1"># print(&#39;catalog is requesting new test from catalog&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">_pg_catalog_to_tree</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="c1"># self.parent.editor.event_generate(&#39;&lt;&lt;NewTestFromCatalog&gt;&gt;&#39;)</span>
        <span class="c1"># root.event_generate(&#39;&lt;&lt;NewTestFromCatalog&gt;&gt;&#39;)</span>

    <span class="k">def</span> <span class="nf">_describe_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Catalog selection tracks docstring from PyGarvTest.run&quot;&quot;&quot;</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">selection</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">test_iid</span> <span class="o">=</span> <span class="n">selections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># parameter row children describe their parent row test name</span>
        <span class="k">if</span> <span class="n">test_iid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
            <span class="n">test_iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)</span>

        <span class="c1"># lookup the pygarv docstring</span>
        <span class="n">test_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="n">pg_test</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="p">,</span> <span class="n">test_name</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">pg_test</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># first line of docstring</span>
        <span class="c1"># self.test_doc.config(text=description)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Catalog: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">description</span><span class="p">))</span></div>


<div class="viewcode-block" id="PyGarvTestView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvTestView">[docs]</a><span class="k">class</span> <span class="nc">PyGarvTestView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;viewer + parameter value editor for PyGarvTest datablock test params&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        see PyGarvTreeView</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># always False unless _validate() succeeds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span> <span class="o">=</span> <span class="n">PyGarvTreeView</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;pygarv_style.Treeview&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># self.bind(&#39;&lt;&lt;NewTestFromCatalog&gt;&gt;&#39;, self._pg_catalog_to_tree)</span>

        <span class="c1"># self.test_tree.bind(&#39;&lt;&lt;TreeviewSelect&gt;&gt;&#39;, self._select_test)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Double-Button-1&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbl_click</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Delete&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_delete_test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;BackSpace&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_delete_test</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_add</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;ValidateTestTree&gt;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;v&gt;&quot;</span><span class="p">)</span>  <span class="c1"># FIX ME -&gt; &#39;None&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_add</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;IsValidTestTree&gt;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;Triple-Button&gt;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="s2">&quot;&lt;&lt;ValidateTestTree&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span>
        <span class="p">)</span>  <span class="c1"># starts test_tree validation cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="s2">&quot;&lt;&lt;IsValidTestTree&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_valid_tree</span>
        <span class="p">)</span>  <span class="c1"># ends test_tree validation cycle</span>

        <span class="c1"># get open Entry widgets to track Treeview window/view changes ... complete mess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Configure&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Motion&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-4&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-5&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Button-4&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Button-5&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entry_widget_position_handler</span><span class="p">)</span>

        <span class="c1"># populate with model.yarf_doc tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tree_from_tr_doc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pg_catalog_to_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;key in catalog view pulls a test from pygarv catalog and</span>
<span class="sd">        appends to current test tree</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(&#39;new_test_from_catalog&#39;, e)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">selection</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>  <span class="c1"># adds must be one at a time</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">catalog_tree_iid</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">test_name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">catalog_tree_iid</span><span class="p">)[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="n">test_specs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="p">,</span> <span class="n">test_name</span><span class="p">)</span>

            <span class="n">test_iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">test_name</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># children col 1 2 are user editable param, value</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">test_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>  <span class="c1"># in [&#39;dblock_path&#39;, &#39;test&#39;]:</span>
                    <span class="n">iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                        <span class="n">test_iid</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>  <span class="c1"># block event propogation</span>

    <span class="k">def</span> <span class="nf">_tree_to_yarf_doc_test_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;scrapes the current test tree and returns a</span>
<span class="sd">        yarf_doc[&#39;tests&#39;] format list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># bail out if in process of patching up the form</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># current dblock path index</span>
        <span class="n">dbp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span>

        <span class="c1"># the tree root iids, e.g., (&#39;I001&#39;, &#39;I006&#39;) are the individual</span>
        <span class="c1"># tests this dblock</span>
        <span class="n">test_tree_iids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>

        <span class="n">test_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tt_iid</span> <span class="ow">in</span> <span class="n">test_tree_iids</span><span class="p">:</span>

            <span class="n">tt_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="n">tt_iid</span>
            <span class="p">)</span>  <span class="c1"># ith root index == ith yarf_doc[&#39;tests&#39;] test</span>
            <span class="n">tt_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)</span>  <span class="c1"># data values from the tree item</span>
            <span class="n">tt_test_name</span> <span class="o">=</span> <span class="n">tt_item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="c1"># should correspond to PyGarvTest[&#39;test&#39;]</span>

            <span class="c1"># lookup the test</span>
            <span class="n">pg_test</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="p">,</span> <span class="n">tt_test_name</span><span class="p">)</span>
            <span class="n">pg_test</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="c1"># update dblock path</span>
            <span class="n">pg_test</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">]</span>

            <span class="c1"># scrape user settable parameter values from the test_tree</span>
            <span class="k">for</span> <span class="n">param_iid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">):</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">param_iid</span><span class="p">)[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>

                <span class="c1"># test tree string value to -&gt; parameter type OK for validated data</span>
                <span class="n">pg_test</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_test</span><span class="o">.</span><span class="n">param_types</span><span class="p">[</span><span class="n">p</span><span class="p">](</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># build the yarf_doc format ordered list of {k:v} pairs</span>
            <span class="n">test_specs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">pg_test</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pg_test</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
            <span class="n">test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_specs</span><span class="p">)</span>

            <span class="c1"># awful</span>
            <span class="n">pg_test</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">test_list</span>

    <span class="k">def</span> <span class="nf">_on_valid_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;actions to take when test tree values are valid&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;on_valid_tree&#39;, e)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># cleanup windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>  <span class="c1"># update everything</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;for view._update() cascade&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tree_from_tr_doc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_test_tree_from_tr_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refresh the pygarv test tree from the current yarf_docs&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;test_tree._test_tree_from_tr_doc()&#39;)</span>

        <span class="n">test_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_pg_test_list</span><span class="p">()</span>
        <span class="c1"># load the tree or clear if no tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">test_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">test_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="c1"># print(&#39;no tests ... returning&#39;)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_list</span><span class="p">:</span>
            <span class="n">test_params</span> <span class="o">=</span> <span class="n">odict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">test_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">test_params</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">test_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>  <span class="c1">#  [&#39;test&#39;, &#39;dblock_path&#39;]:</span>
                    <span class="c1"># tagged read write</span>
                    <span class="n">iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                        <span class="n">child</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s2">&quot;rw&quot;</span>
                    <span class="p">)</span>

    <span class="c1"># UI ------------------------------------------------------------</span>
    <span class="c1"># Entry widget event handlers: note calls back to _validate()</span>

    <span class="k">def</span> <span class="nf">_dbl_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;if pointer is double clicked on a parameter value run the value editor&quot;&quot;&quot;</span>

        <span class="n">tt_iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">identify_row</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># table row has unique iid</span>
        <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">identify_column</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># param #1 value #2</span>
        <span class="c1"># only edit read-write param values</span>
        <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s2">&quot;#2&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">tag_has</span><span class="p">(</span><span class="s2">&quot;rw&quot;</span><span class="p">,</span> <span class="n">tt_iid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edit_tt_iid_value</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

    <span class="c1"># pop up an Entry widget over the value being edited</span>
    <span class="k">def</span> <span class="nf">_edit_tt_iid_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tt_iid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pop up a ttk.Entry overlay for parameter value at tt_iid&quot;&quot;&quot;</span>

        <span class="c1"># allow only one Entry widget at a time</span>
        <span class="n">ewdgts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">wdgt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wdgt</span><span class="p">,</span> <span class="s2">&quot;x_y_tt_iid&quot;</span><span class="p">):</span>
                <span class="n">ewdgts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wdgt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ewdgts</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;closing widget ...</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
            <span class="n">w</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)</span>
        <span class="n">test_iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)</span>  <span class="c1"># parent of this param</span>

        <span class="c1"># widgets scrolled out of view don&#39;t have a bbox, so count</span>
        <span class="c1"># rows and scroll test_tree to ensure test and params are</span>
        <span class="c1"># visible</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">root_iid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">root_iid</span> <span class="o">==</span> <span class="n">test_iid</span><span class="p">:</span>
                <span class="n">test_iid_row</span> <span class="o">=</span> <span class="n">nrows</span>
            <span class="n">nrows</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">child_iid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="n">root_iid</span><span class="p">):</span>
                <span class="n">nrows</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">move_to</span> <span class="o">=</span> <span class="n">test_iid_row</span> <span class="o">/</span> <span class="n">nrows</span>  <span class="c1"># scroll range is 0 - 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">yview_moveto</span><span class="p">(</span><span class="n">move_to</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># or else the bbox may not yet be known</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bbox</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>  <span class="c1"># relative to widget</span>

        <span class="c1"># overlay a ttk.Entry on the value being edited</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">x_y_tt_iid</span> <span class="o">=</span> <span class="n">tt_iid</span>  <span class="c1"># Entry knows its tt_iid</span>

        <span class="n">entry</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># fill with existing for editing</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">select_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>

        <span class="c1"># wrap tree iid (= row id), e.g., &#39;I003B&#39; in custom handlers</span>
        <span class="k">def</span> <span class="nf">_data_entry_handler</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="c1"># self._enter_data_iid(e, payload=payload)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enter_data_iid</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">tt_iid</span><span class="p">)</span>

        <span class="n">entry</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="n">_data_entry_handler</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Tab&gt;&quot;</span><span class="p">,</span> <span class="n">_data_entry_handler</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Escape&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abort_edit</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;FocusOut&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abort_edit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># force display of the entry</span>

    <span class="k">def</span> <span class="nf">_enter_data_iid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tt_iid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;move contents of the Entry into the test tree, request form validation&quot;&quot;&quot;</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">new_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># or else the tree values may not be set in time</span>
        <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="n">test_iid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">tt_iid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)</span>  <span class="c1"># go back and check ...</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>  <span class="c1"># block event propagation</span>

    <span class="k">def</span> <span class="nf">_abort_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bail of with no change to the test parameters or yarf_doc&quot;&quot;&quot;</span>
        <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tree_from_tr_doc</span><span class="p">()</span>
        <span class="c1"># self._validate()</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

    <span class="k">def</span> <span class="nf">_entry_widget_position_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;on test tree window changes look up and relocate entry widgets&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">wdgt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wdgt</span><span class="p">,</span> <span class="s2">&quot;x_y_tt_iid&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># or else the bbox may not yet be known</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">bbox</span><span class="p">(</span><span class="n">wdgt</span><span class="o">.</span><span class="n">x_y_tt_iid</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="n">wdgt</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># lest the display lags ... ??</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

    <span class="c1"># Backspace/Del delete test handler</span>
    <span class="k">def</span> <span class="nf">_tree_delete_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete the selected test from the current yarf_doc tests&quot;&quot;&quot;</span>
        <span class="n">iids</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">selection</span><span class="p">()</span>

        <span class="c1"># tests are root children so widget.index(iid) == index in current test list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">iids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
            <span class="n">test_name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">iids</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="n">test_idx</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">_delete_tr_docs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_tree_from_tr_doc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;IsValidTestTree&gt;&gt;&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Deleted </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

    <span class="c1"># test tree CRUD utils ------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_iid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check parameter values are of the correct type *AND* dry run test(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_iid : str</span>
<span class="sd">          tk.Treeview root iid of the test item to validate.</span>


<span class="sd">        test_tree.index(test_iid) == test_idx of updating tr_doc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;validating ...&#39;)</span>

        <span class="c1"># cleanup stray Entry widgets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>

        <span class="c1"># form validation False on the way in, set True on the way out if nothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># from the Model</span>
        <span class="c1"># current dblock path index</span>
        <span class="n">dbp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span>

        <span class="c1"># current tr_doc</span>
        <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>

        <span class="c1"># from the Treeview</span>
        <span class="c1"># fetch tree root ids, e.g., (&#39;I001&#39;, &#39;I006&#39;)</span>
        <span class="n">tt_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)</span>  <span class="c1"># data values from the tree item</span>
        <span class="n">tt_test_name</span> <span class="o">=</span> <span class="n">tt_item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>  <span class="c1"># should correspond to PyGarvTest[&#39;test&#39;]</span>

        <span class="c1"># for dblock dbp_idx, ith tree root index == ith tr_doc[&#39;tests&#39;] test</span>
        <span class="n">test_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">test_iid</span><span class="p">)</span>

        <span class="c1"># FIX ME this should not be in the validator</span>
        <span class="c1"># fetch a copy test_specs for to dry run. If updating fetch from tr_docs,</span>
        <span class="c1"># if appending start fresh w/ None from pygarv</span>
        <span class="k">if</span> <span class="n">test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]):</span>
            <span class="c1"># update existing specs</span>
            <span class="n">test_specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pv</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">][</span><span class="n">test_idx</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">test_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]):</span>
            <span class="c1"># test tree has one more entry than tr_docs so we are appending</span>
            <span class="c1"># a new test. init test_specs w/ None&#39;s and let form validation prompt</span>
            <span class="c1"># for values</span>
            <span class="n">test_specs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="p">,</span> <span class="n">tt_test_name</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="n">test_specs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">tt_test_name</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test_specs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># can only update existing or append one more test ...</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test tree test index &gt; len(tr_doc[&quot;</span> <span class="s2">&quot;tests&quot;</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># test tree form validation</span>
        <span class="c1">#</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># tt_idx = self.test_tree.index(test_iid)</span>

        <span class="c1"># lookup the PyGarv test and specs</span>
        <span class="n">pg_test</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="p">,</span> <span class="n">tt_test_name</span><span class="p">)</span>  <span class="c1"># test object</span>

        <span class="c1"># loop thru the param-value types and verify</span>
        <span class="n">tt_param_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
            <span class="n">test_iid</span>
        <span class="p">)</span>  <span class="c1"># child ids, e.g., (&#39;I002&#39;, &#39;I003&#39;)</span>

        <span class="k">for</span> <span class="n">tt_pid</span> <span class="ow">in</span> <span class="n">tt_param_ids</span><span class="p">:</span>

            <span class="c1"># ttk.Treeview values are text fields so *strings*</span>
            <span class="n">tt_p</span><span class="p">,</span> <span class="n">tt_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">tt_pid</span><span class="p">)[</span>
                <span class="s2">&quot;values&quot;</span>
            <span class="p">]</span>  <span class="c1"># e.g., [&#39;stream&#39;, &#39;MiPa&#39;]</span>

            <span class="n">pg_param_type</span> <span class="o">=</span> <span class="n">pg_test</span><span class="o">.</span><span class="n">param_types</span><span class="p">[</span>
                <span class="n">tt_p</span>
            <span class="p">]</span>  <span class="c1"># e.g., &lt;class &#39;str&#39;&gt; or &lt;class &#39;float&#39;&gt;</span>

            <span class="c1"># if string cannot be coerced to correct type or &#39;None&#39; force an edit Entry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pg_param_type</span><span class="p">(</span><span class="n">tt_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tt_v</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># don&#39;t report errors for routine parameter entry</span>
                <span class="k">if</span> <span class="n">tt_v</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># block test runs until problem is fixed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_edit_tt_iid_value</span><span class="p">(</span><span class="n">tt_pid</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># tree value is right type so scrape it into the dry run test specs</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_specs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tt_p</span> <span class="o">==</span> <span class="p">[</span><span class="o">*</span><span class="n">pv</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">test_specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tt_p</span><span class="p">:</span> <span class="n">pg_param_type</span><span class="p">(</span><span class="n">tt_v</span><span class="p">)}</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># model update ... does the test actually run?</span>
        <span class="c1">#</span>
        <span class="c1"># typos in stream labels and such can throw exceptions</span>
        <span class="c1">#</span>
        <span class="c1"># so hand off to pygarv to dry run the test and manage its</span>
        <span class="c1"># the tr_docs.</span>
        <span class="c1">#</span>
        <span class="c1"># the tr_doc is only updated if dry run goes thru.</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">_update_tr_docs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">test_specs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># report exception ... tr_doc manager leaves tr_doc unchanged</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;_update_tr_docs failed: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tt_test_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;update_tr_docs OK: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tt_test_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_console_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># tr_docs are changed or not, either way the tree view must be current.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tree_from_tr_doc</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tree</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;IsValidTestTree&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_update_yarf_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;scrapes test tree and hands the list off to Model for safe keeping&quot;&quot;&quot;</span>
        <span class="n">test_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_to_yarf_doc_test_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_pg_test_list</span><span class="p">(</span><span class="n">test_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="PyGarvTreeView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.PyGarvTreeView">[docs]</a><span class="k">class</span> <span class="nc">PyGarvTreeView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;common container and styling wrapper for PyGarv catalog and dblock test views&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parent : tk[k].Widget</span>
<span class="sd">            container for this treee</span>
<span class="sd">        model : reference to a Model class instance</span>
<span class="sd">           provides current dblock_idx, dblock_path, and actual data</span>
<span class="sd">        pg : PyGarv class instance</span>
<span class="sd">           has current yarf_docs</span>
<span class="sd">        columns : list of str</span>
<span class="sd">           column headings, e.g., [&#39;test&#39;, &#39;parameter&#39;, &#39;value&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># in yarf_doc ...</span>
        <span class="c1"># test_dict.keys() == dict_keys([&#39;name&#39;, &#39;dblock_path&#39;, &#39;tests&#39;])</span>

        <span class="n">this_style</span> <span class="o">=</span> <span class="s2">&quot;pygarv_style.Treeview&quot;</span>
        <span class="n">font_name</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">this_style</span><span class="p">,</span> <span class="s2">&quot;font&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">selectmode</span><span class="o">=</span><span class="s2">&quot;browse&quot;</span>
        <span class="p">)</span>  <span class="c1"># one selection at at time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STUB&quot;</span><span class="p">]</span>  <span class="c1"># insist on a column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)])</span>  <span class="c1"># start after #0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span>
            <span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">tk_font</span><span class="o">.</span><span class="n">Font</span><span class="p">()</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>  <span class="c1"># doesn&#39;t work that well</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">tk_font</span><span class="o">.</span><span class="n">Font</span><span class="p">()</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">title</span><span class="p">()))</span></div>


<span class="c1"># data I/O class interface to mkh5</span>
<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;data model for the views</span>

<span class="sd">    This is the Model in the mkh5viewer Model-View architecture</span>

<span class="sd">    `dblock_paths` and `epoch_tables` are set once upon init when the</span>
<span class="sd">    `mkh5` file is read.</span>

<span class="sd">    The rest track datablock and index pointers, updated in response</span>
<span class="sd">    to UI events.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_f : string</span>
<span class="sd">       file path to current mkpy.mkh5 hdf5 format data file</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    `~mkh5.mkh5.mkh5` : object</span>
<span class="sd">      :py:class:`~mkpy.mkh5.mkh5` instance that exposes the hdf5 data and methods</span>
<span class="sd">    dblock_paths : list of str</span>
<span class="sd">      catalogue of all hdf5 slashpaths to mkh5 dblocks</span>
<span class="sd">    epoch_tables : list of str</span>
<span class="sd">      each string is a slash path &#39;_epoch_tables/\*&#39; to an mkh5 epoch table dataset</span>

<span class="sd">    dbp_idx : uint</span>
<span class="sd">       index of model&#39;s current dblock_path</span>

<span class="sd">    dblock_path : string</span>
<span class="sd">       slash path to the active mkpy.mkh5 data set, e.g.,</span>
<span class="sd">       `sub01/dblock_0` or `exp1/S07/dblock_7`.</span>

<span class="sd">    dblock : np.ndarray</span>
<span class="sd">       current dblock data streams</span>

<span class="sd">    header : dict</span>
<span class="sd">       current dblock header</span>

<span class="sd">    pg : PyGarv()</span>

<span class="sd">    pg.yarf_docs : list</span>
<span class="sd">       item at pg.yarf_docs[idx] is a list of tests to run on dblock at dblock_paths[idx]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmp_yarf_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span> <span class="o">=</span> <span class="n">mkh5_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pg</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PyGarv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">)</span>  <span class="c1"># general pg init</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># FIX ME ... pg.tr_docs are already computed on pg.__init__</span>
                <span class="c1"># why don&#39;t they show up in the viewer without another update?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">_update_tr_docs_from_mkh5</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;uh oh ... could not read stored pygarv tests&quot;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># default list of h5 slashpaths is all dblock datasets in mkh5_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span>

            <span class="c1"># list (possibly empty) of h5 slashpaths to epoch table</span>
            <span class="c1"># datasets in mkh5_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_epochs_table_names</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">yarf_io</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PyYarf</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fail</span><span class="p">,</span> <span class="n">fail</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># current lookup pointers ... init to first dblock path</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;found no mkh5.dblocks in &quot;</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> ... not mkh5 format or empty?&quot;</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>

        <span class="c1"># from tempfile.NamedTemporaryFile().name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_yarf_f</span> <span class="o">=</span> <span class="n">tmp_yarf_f</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

<div class="viewcode-block" id="Model.update_model"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Model.update_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refresh index, path, and header, dblock data, and pygarv results</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dbp : str</span>
<span class="sd">            slashpath to dblock dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIX ME sanity check the input</span>
        <span class="k">assert</span> <span class="s2">&quot;dblock_&quot;</span> <span class="ow">in</span> <span class="n">dblock_path</span>

        <span class="c1"># refresh the data if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span> <span class="o">==</span> <span class="n">dblock_path</span><span class="p">:</span>
            <span class="c1"># debugging</span>
            <span class="c1"># print(&#39;shortcut dblock update&#39;)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise update indices and reload the buffer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># print(&#39;updating Model.dblock_path&#39;, dblock_path)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span> <span class="o">=</span> <span class="n">dblock_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> failed on </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">(),</span> <span class="n">dblock_path</span><span class="p">)</span>
                <span class="n">err</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># repaint the Model dblock[&#39;pygarv&#39;] with the current test result pygarv</span>
        <span class="c1"># print(&#39;repainting volatile dblock[&#39;&#39;pygarv&#39;&#39;]&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span>

        <span class="c1"># update the tmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_yarf_docs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_yarf_f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.export_yarf_docs"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Model.export_yarf_docs">[docs]</a>    <span class="k">def</span> <span class="nf">export_yarf_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;scrape yarf doc test info from tr_docs and dump to YAML .yarf file&quot;&quot;&quot;</span>

        <span class="c1"># refresh tmp.yarf</span>
        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">_get_yarf_docs_from_tr_docs</span><span class="p">()</span>
        <span class="n">as_yaml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yarf_io</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">yarf_docs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yfid</span><span class="p">:</span>
                <span class="n">yfid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">as_yaml</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># elaborate on the failure a bit ...</span>
            <span class="n">status_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">status_msg</span> <span class="o">+=</span> <span class="s2">&quot;yarf export failed: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="n">status_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_pg_test_list"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Model.get_pg_test_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_pg_test_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return this dblock&#39;s tr_doc test list, e.g., for populating a UI test tree&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.next_event"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Model.next_event">[docs]</a>    <span class="k">def</span> <span class="nf">next_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">from_idx</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">pygarv_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;log_evcodes&quot;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return index of next or previous event in current</span>
<span class="sd">            dblock model w/ pygarv type</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        from_idx : unint</span>
<span class="sd">           index in current data block to start from</span>
<span class="sd">        direction : int</span>
<span class="sd">           1 looks right, -1 looks left</span>
<span class="sd">        pygarv_type : str (None, &#39;good&#39;  &#39;bad&#39;)</span>
<span class="sd">           None (default) ignores pygarv column, &#39;good&#39; searches for</span>
<span class="sd">           pygarv == 0, bad searches pygarv &gt; 0</span>
<span class="sd">        event_col : str (&#39;log_evcodes&#39;)</span>
<span class="sd">           name dblock column to search for events. usually default,</span>
<span class="sd">           perhaps &#39;crw_evcodes&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">           index of next event satisfying the criteria or from_idx if None are found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad next_event direction: &quot;</span> <span class="o">+</span> <span class="n">direction</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pygarv_type</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad pygarv_type &quot;</span> <span class="o">+</span> <span class="n">pygarv_type</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">from_idx</span> <span class="o">+</span> <span class="n">direction</span>
        <span class="c1"># print(&#39;Model.next_event scanning at&#39;, idx, &#39;pygarv_type&#39;, pygarv_type)</span>
        <span class="k">while</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="n">event_col</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pygarv_type</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># print(&#39;found good event&#39;)</span>
                    <span class="k">return</span> <span class="n">idx</span>
                <span class="k">elif</span> <span class="n">pygarv_type</span> <span class="o">==</span> <span class="s2">&quot;bad&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># print(&#39;found bad event&#39;)</span>
                    <span class="k">return</span> <span class="n">idx</span>
                <span class="k">elif</span> <span class="n">pygarv_type</span> <span class="o">==</span> <span class="s2">&quot;events&quot;</span> <span class="ow">or</span> <span class="n">pygarv_type</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># print(&#39;found any event&#39;)</span>
                    <span class="k">return</span> <span class="n">idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">direction</span>

        <span class="c1"># print(&#39;nothing found&#39;)</span>
        <span class="k">return</span> <span class="n">from_idx</span></div></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># View classes</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># class View(ttk.PanedWindow):</span>
<div class="viewcode-block" id="View"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.View">[docs]</a><span class="k">class</span> <span class="nc">View</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;top_level view/controller, horizontal paned window with DataView, DashboardView</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent : tk.object</span>
<span class="sd">    model : mkh5viewer.Model instance</span>
<span class="sd">      see Model for details</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># load the views w/ data</span>

        <span class="c1"># DataView ... header, traces, dblock text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DataView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">))</span>  <span class="c1"># ,</span>
        <span class="c1">#                          model=self.model))</span>

        <span class="c1"># Dashboard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">heigh</span><span class="o">=</span><span class="mi">200</span><span class="p">))</span>  <span class="c1"># ,</span>
        <span class="c1">#                           model=self.model))</span>

        <span class="c1"># position sash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>

        <span class="c1"># master call to refresh the subview</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;triggers children to consult Model for possible changes with their own _update().</span>
<span class="sd">        This is *not* tk.update()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;View._update()&#39;)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># print(&#39;Begin View _update() child {0}: {1}&#39;.format(k, v))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
                <span class="c1"># print(&#39;End View _update() child {0}: {1}&#39;.format(k, v))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">fail</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.DataView">[docs]</a><span class="k">class</span> <span class="nc">DataView</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper around pygarv editor, traces and dblock datatable&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_DV_widgets</span><span class="p">()</span>

<div class="viewcode-block" id="DataView.layout_DV_widgets"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.DataView.layout_DV_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">layout_DV_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;note: dims controlled in appearance spec globals&quot;&quot;&quot;</span>

        <span class="c1"># PyGarv Frame on the left</span>
        <span class="n">pygarv_frame</span> <span class="o">=</span> <span class="n">PyGarvView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Artifact Tests&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pygarv&quot;</span><span class="p">)</span>
        <span class="n">pygarv_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="c1"># limit shrinkage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pygarv_frame</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Data streams ... shows status dashboard,</span>
        <span class="c1"># traces canvas and dblock data table</span>
        <span class="n">streams_panel</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;streams&quot;</span><span class="p">)</span>
        <span class="n">streams_panel</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="n">streams_panel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TraceView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;traces&quot;</span><span class="p">))</span>
        <span class="n">streams_panel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DBlockView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dblock_table&quot;</span><span class="p">))</span>
        <span class="n">streams_panel</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">450</span><span class="p">)</span>

        <span class="c1"># bound shrinkage and set sash position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">streams_panel</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

        <span class="c1"># self._update()</span>

    <span class="k">def</span> <span class="nf">_update_streams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">,</span> <span class="s2">&quot;dblock_table&quot;</span><span class="p">]:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_pygarv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refresh pygarv test edit tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refresh traces and dblock streams&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pygarv</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_streams</span><span class="p">()</span></div>


<span class="c1"># class Dashboard(ttk.PanedWindow): # LabelFrame):</span>
<div class="viewcode-block" id="Dashboard"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Dashboard">[docs]</a><span class="k">class</span> <span class="nc">Dashboard</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">):</span>  <span class="c1"># LabelFrame):</span>
    <span class="sd">&quot;&quot;&quot;wrapper around HeaderView, H5Nav&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_dashboard_widgets</span><span class="p">()</span>
        <span class="c1"># self._update()</span>

<div class="viewcode-block" id="Dashboard.layout_dashboard_widgets"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Dashboard.layout_dashboard_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">layout_dashboard_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;note: dims controlled in appearance spec globals&quot;&quot;&quot;</span>

        <span class="c1"># headinfo in left panel</span>
        <span class="n">header_view</span> <span class="o">=</span> <span class="n">HeaderView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>  <span class="c1"># , height=20)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">header_view</span><span class="p">)</span>

        <span class="c1"># h5 navigator w/ tabs for Data Blocks and Epochs (if any )</span>
        <span class="n">h5_nav</span> <span class="o">=</span> <span class="n">H5Nav</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">h5_nav</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h5_nav</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sash_place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># print(&#39;Dashboard calling child {0}: {1}._update()&#39;.format(k, v), end=&#39; &#39;)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">fail</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="H5Nav"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.H5Nav">[docs]</a><span class="k">class</span> <span class="nc">H5Nav</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Notebook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tab 1 (default) is dblocks, other tabs are epochs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;h5nav_style.TNotebook&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># always have default dblock tab</span>
        <span class="n">h5_view</span> <span class="o">=</span> <span class="n">H5View</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;dblock&quot;</span><span class="p">)</span>
        <span class="n">h5_view</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h5_view</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Data Blocks&quot;</span><span class="p">)</span>

        <span class="c1"># load up epochs tables if any</span>
        <span class="k">for</span> <span class="n">epoch_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">epoch_tables</span><span class="p">:</span>
            <span class="n">h5_view</span> <span class="o">=</span> <span class="n">H5View</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">epoch_table</span><span class="p">)</span>
            <span class="n">h5_view</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h5_view</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">epoch_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;NotebookTabChanged&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_model_dblock_paths</span><span class="p">)</span>

<div class="viewcode-block" id="H5Nav.update_model_dblock_paths"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.H5Nav.update_model_dblock_paths">[docs]</a>    <span class="k">def</span> <span class="nf">update_model_dblock_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>

        <span class="c1"># h5_view = root.nametowidget(self.select())</span>

        <span class="c1"># fire an update cascade and set viewport to first row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
        <span class="n">trace_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view.!dataview.traces&quot;</span><span class="p">)</span>
        <span class="c1"># trace_view.set_vp_from_idx(0)</span>
        <span class="n">trace_view</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">vp_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># warnings.warn(&#39;Not Implemented H5Nav._update() &#39;)</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="EventView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.EventView">[docs]</a><span class="k">class</span> <span class="nc">EventView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;lightweight wrapper for regular expression event finding, same</span>
<span class="sd">    search mechanism as mkh5.event_table()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># layout the text entry widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="s2">&quot;dblock&quot;</span>  <span class="c1"># dataset, h5file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regexp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">reg_exp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper around mkh5._find_evcodes() ... works per dblock&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="H5View"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.H5View">[docs]</a><span class="k">class</span> <span class="nc">H5View</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;unified tabular viewer for data block (= a long epoch), events</span>
<span class="sd">    (a single sample epoch) and epoch tables&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="c1"># switch on the type of data to initialize w/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;dblock&quot;</span><span class="p">:</span>
            <span class="c1"># for the data block view</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># default = single row == first sample of the datablock</span>
            <span class="c1"># self.h5view_df[&#39;dblock_ticks&#39;] = 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># epochs table already has db_idx == match_code tick</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_epochs_table</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="c1"># fill the tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span><span class="p">)</span>

        <span class="c1"># UI bindings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_model_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper to refresh widget with new data&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># pull the columns out of whatever table we have</span>
        <span class="n">db_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;h5view_style.Treeview&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">db_columns</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">db_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># load the tree view w/ table data</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5view_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

<div class="viewcode-block" id="H5View.update_model_view"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.H5View.update_model_view">[docs]</a>    <span class="k">def</span> <span class="nf">update_model_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;handles clicks on H5view row.</span>

<span class="sd">        Each row of self.h5view_df has a dblock_path and match_ticks column.</span>

<span class="sd">        Selecting by mouse click or arrowing</span>

<span class="sd">          * update the main model to use the dblock at dblock_path</span>
<span class="sd">          * move the viewport to the relevant tick</span>
<span class="sd">          * switch the dashboard into event scroll mode and notify</span>
<span class="sd">            of the new event data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># the selected table row</span>
        <span class="n">h5view_df_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">())</span>

        <span class="c1"># dblock paths may change arbitrarily when clicking around in</span>
        <span class="c1"># a tree, sofetch the selected dblock path and refresh the Model</span>

        <span class="c1"># slice the dblock path string and dblock tick integer the selected table row</span>

        <span class="n">this_dblock_path</span> <span class="o">=</span> <span class="n">h5view_df_row</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">this_dblock_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">this_dblock_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">h5view_df_row</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;match_tick&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">this_dblock_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># inform dashboard of the new anchor event</span>
        <span class="n">trace_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view.!dataview.traces&quot;</span><span class="p">)</span>
        <span class="n">trace_view</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">set_scroll_by</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
        <span class="n">trace_view</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">set_anchor</span><span class="p">(</span><span class="n">this_dblock_idx</span><span class="p">)</span>

        <span class="c1"># update the viewport and refresh</span>
        <span class="n">idx_offset</span> <span class="o">=</span> <span class="n">trace_view</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">anchor_vp_offset</span>
        <span class="n">trace_view</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">this_dblock_idx</span> <span class="o">-</span> <span class="n">idx_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.!view&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span></div></div>


<span class="c1"># class HeaderView(ttk.Treeview):</span>
<div class="viewcode-block" id="HeaderView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.HeaderView">[docs]</a><span class="k">class</span> <span class="nc">HeaderView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># for label frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Header&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_label</span> <span class="o">=</span> <span class="s2">&quot;Header&quot;</span>

        <span class="c1"># not working?</span>
        <span class="c1"># self.frame_label = tk.StringVar()</span>
        <span class="c1"># self.frame_label.set(self.model.dblock_path)</span>

        <span class="c1"># actual tree view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;headerview_style.Treeview&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="HeaderView.dict_to_tree"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.HeaderView.dict_to_tree">[docs]</a>    <span class="k">def</span> <span class="nf">dict_to_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tree_item</span><span class="p">):</span>
        <span class="c1"># coerce lists to dict</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;[</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">)])</span>

        <span class="c1"># recurse or bottom out</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># print(&#39;recursing on&#39;, k)</span>
                <span class="n">new_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">tree_item</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">k</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_tree</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">tree_item</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print(&#39;updating header view&#39;)</span>
        <span class="c1"># self.config(text=self.model.dblock_path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_tree</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DBlockView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.DBlockView">[docs]</a><span class="k">class</span> <span class="nc">DBlockView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Treeview</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;populate with model and info from the trace view&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vp_info</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
            <span class="n">selectmode</span><span class="o">=</span><span class="s2">&quot;browse&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dblock_table_style.Treeview&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;#0&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1">#        self.column(&#39;#0&#39;, width=tk_font.Font().measure(&#39;#0&#39;.title()))</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
            <span class="c1"># print(h.title(), round(2.0* tk_font.Font().measure(h.title())))</span>
            <span class="n">minwidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tk_font</span><span class="o">.</span><span class="n">Font</span><span class="p">()</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="s2">&quot;-0000.000&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="n">minwidth</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">minwidth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

        <span class="c1"># self.bind(&#39;&lt;ButtonRelease-1&gt;&#39;, self.set_vp_cursor)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_vp_cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># track cursor/selection row</span>

<div class="viewcode-block" id="DBlockView.set_vp_cursor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.DBlockView.set_vp_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">set_vp_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;vp cursor tracks dblock focus item, i.e., dblock row</span>

<span class="sd">        Responds to DblockView cursor selection virtual events, also</span>
<span class="sd">        called by TraceView cursor mouse dragging</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this_selection = self.focus()</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">()</span>  <span class="c1"># should be unique in &#39;browse&#39; mode</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">this_selection</span> <span class="o">=</span> <span class="n">selections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">this_selection</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># print(&#39;vp_cursor_selection&#39;, self.selection())</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;VirtualEvent&quot;</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;35&quot;</span><span class="p">:</span>
            <span class="c1"># handle keyboard browsing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># print(&#39;turning cursor on&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">=</span> <span class="n">this_selection</span>  <span class="c1"># turn it on</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">!=</span> <span class="n">this_selection</span><span class="p">:</span>
                <span class="c1"># print(&#39;moving cursor&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">=</span> <span class="n">this_selection</span>  <span class="c1"># turn it on</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">(</span><span class="n">this_selection</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">==</span> <span class="n">this_selection</span><span class="p">:</span>
                <span class="c1"># print(&#39;turning cursor off&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selection_toggle</span><span class="p">(</span><span class="n">this_selection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">focus</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;uh oh ... TreeViewSelect trouble in &quot;</span> <span class="s2">&quot;DBlockView.set_vp_cursor&quot;</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># set viewport cursor sample index or None from cursor_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">vp_cursor_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># first value is dblock_tick which == row index in dblock</span>
            <span class="n">vp_cursor_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor_id</span><span class="p">)[</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># print(&#39;vp_cursor_idx&#39;, vp_cursor_idx)</span>
        <span class="c1"># render the cursor on trace view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">render_vp_cursor</span><span class="p">(</span><span class="n">vp_cursor_idx</span><span class="p">)</span></div>

        <span class="c1"># return &#39;break&#39;</span>

    <span class="k">def</span> <span class="nf">_set_vp_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;go up a frame and fetch the traces viewport&quot;&quot;&quot;</span>
        <span class="c1"># viewport data from the traceview</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vp_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vp_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vp_xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vp_ys</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;refill tree view with dblock columns&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;DBlockView._update()&#39;)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">is_event_view</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">anchor_event_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yview_moveto</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yview_scroll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">anchor_vp_offset</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_vp_info</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="c1"># use row index for iid</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__index__&quot;</span><span class="p">):</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;6d}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;6.1f}</span><span class="s2">&quot;</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="c1"># self.insert(&#39;&#39;, i, iid=str(i), values = [fmt.format(x) for x in data[i]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span></div>


<span class="c1"># class TraceView(ttk.LabelFrame):</span>
<div class="viewcode-block" id="TraceView"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView">[docs]</a><span class="k">class</span> <span class="nc">TraceView</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;trace view of data drawn on tk.Canvas wrapped in a tk.Label frame&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TraceView.TraceDashboard"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard">[docs]</a>    <span class="k">class</span> <span class="nc">TraceDashboard</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Status and UI controls for continuous vs. event/epoch scrolling</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parent :</span>
<span class="sd">        model :</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

            <span class="c1"># state variables set/reset by UI events ----------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_units</span> <span class="o">=</span> <span class="s2">&quot;samples&quot;</span>  <span class="c1"># vs. 0.000 seconds</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;samples&quot;</span><span class="p">)</span>  <span class="c1"># default</span>

            <span class="c1"># epoch info in dblock and vp index units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;anchor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vp_offset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;event_data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;prestim&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vp_offset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;poststim&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vp_offset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="p">}</span>

            <span class="c1"># ------------------------------------------------------------</span>
            <span class="c1"># Widgets</span>
            <span class="c1"># ------------------------------------------------------------</span>

            <span class="c1"># dblock and viewport info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dash_status_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># scroll by radio button group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Scroll by&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">by_samps_rb</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Radiobutton</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rb_select</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span>
                <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">by_events_rb</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Radiobutton</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;events&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rb_select</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;events&quot;</span><span class="p">,</span>
                <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">by_good_rb</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Radiobutton</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;good&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rb_select</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;good&quot;</span><span class="p">,</span>
                <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">by_bad_rb</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Radiobutton</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rb_select</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span>
                <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># epoch widgets</span>

            <span class="c1"># ms text labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;prestim_label&quot;</span><span class="p">)</span>
            <span class="c1">#            self.anchor_label = ttk.Label(self, name=&#39;anchor_label&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;poststim_label&quot;</span><span class="p">)</span>

            <span class="c1"># epoch scale controls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;prestim&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;poststim&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="p">]:</span>
                <span class="c1"># sc.config(command=self._update_from_scale)</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;ButtonRelease&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_release_scale</span><span class="p">)</span>

            <span class="c1"># init epoch to centered anchor, no pre or post stim</span>
            <span class="c1"># these are *durations*</span>
            <span class="n">half_vp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># self.prestim_sc.config(from_ = 0, to=half_vp)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_val</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">IntVar</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="n">half_vp</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">half_vp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">half_vp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">half_vp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">half_vp</span><span class="p">)</span>

            <span class="c1"># fit epoch to window</span>
            <span class="c1"># self._is_epoch_view = tk.IntVar()</span>
            <span class="c1"># self.epoch_view_cbt = ttk.Checkbutton(self, text=&#39;Fit to window&#39;,</span>
            <span class="c1">#                                       command = self._epoch_view,</span>
            <span class="c1">#                                       variable=self._is_epoch_view)</span>

            <span class="c1"># layout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dash_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

            <span class="n">rb_objs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">by_samps_rb</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">by_events_rb</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">by_good_rb</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">by_bad_rb</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">rb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rb_objs</span><span class="p">):</span>
                <span class="n">rb</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="c1">#            self.anchor_label.grid(row=3, column=1,  sticky=tk.N+tk.W+tk.E)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="n">tk</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="c1"># self.epoch_view_cbt.grid(row=3, column=4, sticky=tk.N+tk.W+tk.E)</span>

        <span class="c1"># Callbacks ----------------------------------------</span>

        <span class="c1"># def _epoch_view(self):</span>
        <span class="c1">#     &#39;&#39;&#39; toggle to rescales viewport so prestim and post stim boundaries</span>
        <span class="c1">#     are at the edge of visible window and lock or release epoch scale widget&#39;&#39;&#39;</span>

        <span class="c1">#     if not self.is_event_view:</span>
        <span class="c1">#         return</span>

        <span class="c1">#     if self.is_epoch_view:</span>
        <span class="c1">#         # toggle on -&gt; off re-enables the scale sliders</span>
        <span class="c1">#         self._enable_epoch_scales()</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         self._disable_epoch_scales()</span>
        <span class="c1">#         self.parent._on_configure(None)</span>
        <span class="c1">#         epoch_len = (self.poststim[&#39;dblock_idx&#39;] - self.prestim[&#39;dblock_idx&#39;]) + 1</span>
        <span class="c1">#         x_scale = self.parent.vp_winfo_width / epoch_len</span>
        <span class="c1">#         self.parent.x_scale = x_scale</span>
        <span class="c1">#         self.parent._update_vp(self.prestim[&#39;dblock_idx&#39;])</span>
        <span class="c1">#         self.parent._update()</span>

        <span class="c1"># def _enable_epoch_scales(self):</span>
        <span class="c1">#     for scale in [self.prestim_sc, self.anchor_sc, self.poststim_sc]:</span>
        <span class="c1">#         scale.config(state=tk.NORMAL)</span>

        <span class="c1"># def _disable_epoch_scales(self):</span>
        <span class="c1">#     for scale in [self.prestim_sc, self.anchor_sc, self.poststim_sc]:</span>
        <span class="c1">#         scale.config(state=tk.DISABLED)</span>

        <span class="c1"># radio button group</span>
        <span class="k">def</span> <span class="nf">_rb_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;reset event data and refresh&quot;&quot;&quot;</span>

            <span class="c1"># FIX ME LOGIC? changing event types may or may not invalidate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_anchor_event_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_anchor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_on_release_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;update controls, minimodel, and traceview when a scale slider is dropped&quot;&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">_name</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_config_scale_limits_on_change</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_data_from_scale</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_config_scale_limits_on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;adjust pre and poststim epoch boundary scale limits for anchor</span>
<span class="sd">            moves and anchor scale limits for epoch boundary scale</span>
<span class="sd">            moves</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">,</span> <span class="s2">&quot;poststim&quot;</span><span class="p">]:</span>
                <span class="c1"># moving a boundary so reconfigure anchor scale limits between</span>
                <span class="c1"># the current prestim and poststim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                    <span class="n">from_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                    <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;anchor&quot;</span><span class="p">]:</span>
                <span class="c1"># moving the anchor so reconfigure boundary scale limits</span>
                <span class="c1"># self.prestim_sc.config(from_ = 0, to = val)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">-</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown scale label&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_set_data_from_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;update the dashboard._data{} dblock_idx and vp_offset for the scale</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            name : str {&#39;anchor&#39;, &#39;prestim&#39;, &#39;poststim&#39;)</span>
<span class="sd">               name of the epoch scale to set</span>
<span class="sd">            val : uint</span>
<span class="sd">               viewport index</span>


<span class="sd">            The ._data[&#39;name&#39;][`vp_offset`] is set from the `val`, the</span>
<span class="sd">            `dblock_idx` is calculated from val and the current `vp_idx`</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># print(&#39;set_data_from_scale({0},{1})&#39;.format(name, val))</span>

            <span class="c1"># moving a boundary scale changes the marker but not the anchor/view port</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;prestim&quot;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;poststim&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_anchor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_dblock_idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">()</span>

            <span class="c1"># moving the anchor changes the viewport but not the boundary markers</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>  <span class="c1"># this is read from scale</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_event_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># print(&#39;no anchor event ... not moving the viewport&#39;)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(&#39;moving anchor event ... old vp_idx&#39;, self.parent.vp_idx, &#39; &#39;, end=&#39;&#39;)</span>
                    <span class="c1"># move the viewport with anchor</span>
                    <span class="n">event_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_event_data</span><span class="p">[</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">]</span>
                    <span class="n">new_vp_idx</span> <span class="o">=</span> <span class="n">event_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vp_offset</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">vp_idx</span><span class="o">=</span><span class="n">new_vp_idx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_anchor</span><span class="p">(</span><span class="n">event_idx</span><span class="p">)</span>
                    <span class="c1"># self.anchor[&#39;dblock_idx&#39;] = self.parent.vp_idx + val</span>
                    <span class="c1"># print(&#39;new vp_idx&#39;, self.parent.vp_idx)</span>

        <span class="c1"># backend --------------------------------------------</span>
        <span class="k">def</span> <span class="nf">_get_dblock_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;returns dblock_idx for named epoch param&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)[</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_dash_scale_to_vp_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dash_scale</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;read the dash_scale, return *index/position* in vp samples&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">dash_scale</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">:</span>
                <span class="c1"># anchor scale gives *position* = vp_offset</span>
                <span class="n">vp_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">dash_scale</span> <span class="o">==</span> <span class="s2">&quot;prestim&quot;</span><span class="p">:</span>
                <span class="c1"># prestim scale gives *duration*, convert to offset</span>
                <span class="n">vp_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">dash_scale</span> <span class="o">==</span> <span class="s2">&quot;poststim&quot;</span><span class="p">:</span>
                <span class="c1"># prestim gives *duration*, convert to offset</span>
                <span class="n">vp_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">return</span> <span class="n">vp_offset</span>

        <span class="c1"># public-ish API</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">is_event_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;boolean True if scrolling by one of the event modes&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;samples&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># @property</span>
        <span class="c1"># def is_epoch_view(self):</span>
        <span class="c1">#     &#39;&#39;&#39; boolean True if epoch view checkbutton is set &#39;&#39;&#39;</span>
        <span class="c1">#     return self._is_epoch_view.get()</span>

        <span class="c1">#  prestim --------------------------------------------------</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">prestim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">prestim_vp_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">][</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">prestim_dblock_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dblock_idx</span><span class="p">(</span><span class="s2">&quot;prestim&quot;</span><span class="p">)</span>

        <span class="c1"># poststim --------------------------------------------------</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">poststim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;poststim&quot;</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">poststim_vp_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;poststim&quot;</span><span class="p">][</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">poststim_dblock_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dblock_idx</span><span class="p">(</span><span class="s2">&quot;poststim&quot;</span><span class="p">)</span>

        <span class="c1"># anchor ------------------------------------------------------------</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;anchor&quot;</span><span class="p">]</span>  <span class="c1"># expose as read only</span>

        <span class="c1"># dblock_idx for current vp data for Trace.x in TraceView</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">anchor_dblock_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dblock_idx</span><span class="p">(</span><span class="s2">&quot;anchor&quot;</span><span class="p">)</span>  <span class="c1"># self.anchor[&#39;dblock_idx&#39;]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">anchor_vp_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">anchor_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;event_data&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="TraceView.TraceDashboard.set_anchor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.set_anchor">[docs]</a>        <span class="k">def</span> <span class="nf">set_anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dblock_idx</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;anchor at dblock index idx, update prestim and poststim from scales&quot;&quot;&quot;</span>
            <span class="c1"># print(&#39;set_anchor({0})&#39;.format(dblock_idx))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dblock_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;event_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="n">dblock_idx</span><span class="p">]</span>

            <span class="c1"># refresh the epoch boundaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prestim</span><span class="p">[</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anchor_dblock_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestim</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">poststim</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim</span><span class="p">[</span><span class="s2">&quot;dblock_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anchor_dblock_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim</span><span class="p">[</span><span class="s2">&quot;vp_offset&quot;</span><span class="p">]</span>
            <span class="p">)</span></div>
            <span class="c1"># print(&#39;leaving set_anchor with self_data:&#39;, self._data)</span>

        <span class="k">def</span> <span class="nf">_clear_anchor_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;event_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># event finder for event and artifact browsing -----------------------</span>
<div class="viewcode-block" id="TraceView.TraceDashboard.find_next_anchor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.find_next_anchor">[docs]</a>        <span class="k">def</span> <span class="nf">find_next_anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;look left or right for next event of current pygarv type</span>

<span class="sd">            This calls Model.next_event() according to the dashboard</span>
<span class="sd">            settings.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            direction: int</span>
<span class="sd">               -1 searches left, 1 searches right</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            new_vp_idx : uint</span>
<span class="sd">                viewport left-edge index to view the found event after</span>
<span class="sd">                taking the anchor offset into account.</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># start search at the anchor index</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_dblock_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_dblock_idx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_idx</span>

            <span class="n">scroll_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scroll_by</span><span class="p">()</span>

            <span class="c1"># model.next_event returns idx if nothing found</span>
            <span class="n">next_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">next_event</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">pygarv_type</span><span class="o">=</span><span class="n">scroll_by</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">next_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># found something new, update the dash data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_anchor</span><span class="p">(</span><span class="n">next_idx</span><span class="p">)</span>

            <span class="n">new_vp_idx</span> <span class="o">=</span> <span class="n">next_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_vp_offset</span>
            <span class="k">return</span> <span class="n">new_vp_idx</span></div>

        <span class="c1"># scroll mode ----------------------------------------------------</span>
<div class="viewcode-block" id="TraceView.TraceDashboard.get_scroll_by"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.get_scroll_by">[docs]</a>        <span class="k">def</span> <span class="nf">get_scroll_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.TraceDashboard.set_scroll_by"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.set_scroll_by">[docs]</a>        <span class="k">def</span> <span class="nf">set_scroll_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scroll_by</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">scroll_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_by_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scroll_by</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span></div>

        <span class="c1"># status bar --------------------------------------------------</span>
<div class="viewcode-block" id="TraceView.TraceDashboard.set_dash_status_text"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.set_dash_status_text">[docs]</a>        <span class="k">def</span> <span class="nf">set_dash_status_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;refresh the status report text</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            units : str (&#39;samples&#39;, &#39;seconds&#39;)</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">vp_idx0</span><span class="p">,</span> <span class="n">vp_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">viewport</span>
            <span class="n">vp_idx1</span> <span class="o">=</span> <span class="n">vp_idx0</span> <span class="o">+</span> <span class="n">vp_len</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">db_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span>

            <span class="c1"># status bar</span>
            <span class="n">status_specs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">srate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vp_idx0</span><span class="p">,</span> <span class="n">vp_idx1</span><span class="p">,</span> <span class="n">db_len</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;10.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_samp2ms</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">srate</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">n</span>
                <span class="n">status_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1:10s}</span><span class="s2"> - </span><span class="si">{2:10s}</span><span class="s2"> of </span><span class="si">{3:10s}</span><span class="s2"> </span><span class="si">{4}</span><span class="s2">:10s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">,</span> <span class="o">*</span><span class="n">status_specs</span><span class="p">,</span> <span class="n">units</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;event:&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_event_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; None&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">,</span> <span class="s2">&quot;crw_ticks&quot;</span><span class="p">,</span> <span class="s2">&quot;log_evcodes&quot;</span><span class="p">]:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_event_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dash_status_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="TraceView.TraceDashboard.set_epoch_labels_text"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceDashboard.set_epoch_labels_text">[docs]</a>        <span class="k">def</span> <span class="nf">set_epoch_labels_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;synch epoch text labels w/ scale settings&quot;&quot;&quot;</span>

            <span class="n">srate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prestim</span> <span class="o">=</span> <span class="s2">&quot;prestim: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_samp2ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prestim_vp_offset</span><span class="p">,</span> <span class="n">srate</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1">#                anchor = &#39;{0}&#39;.format(mkh5.mkh5._samp2ms(self.anchor_vp_offset, srate))</span>
                <span class="n">poststim</span> <span class="o">=</span> <span class="s2">&quot;poststim: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_samp2ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poststim_vp_offset</span><span class="p">,</span> <span class="n">srate</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">prestim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">anchor</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">poststim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prestim_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prestim</span><span class="p">)</span>
            <span class="c1">#            self.anchor_label.config(text=anchor)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poststim_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">poststim</span><span class="p">)</span></div>

        <span class="c1"># sync dashboard view and its data for a TraceView reset and render</span>
        <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;update dashboard for trace view&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dash_status_text</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_epoch_labels_text</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.Trace"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.Trace">[docs]</a>    <span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;scalable x,y tk.Canvas grobs</span>

<span class="sd">        The x and y are the 1-1 unscaled data, stretched into canvas_pts according</span>
<span class="sd">        to parent.x_scale, parent.x_scale</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">           parent : TraceView object</span>
<span class="sd">              Assumed to have parent.x_scale, parent.y_scale, parent.canvas</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">           canvas_id : int (None)</span>
<span class="sd">              canvas item index if Trace is currently rendered, else None.</span>


<span class="sd">        * Construct:</span>

<span class="sd">            my_line = Trace(parent_trace_view) # container only</span>
<span class="sd">            my_line = Trace(parent_trace_view, x=x_data, y=ydata) # ready to render</span>
<span class="sd">            my_rect = Trace(parent_trace_view, x=(x0,x1), y=(y0,y1)) # ready to render</span>

<span class="sd">        * Update, optionally with new x,y data</span>

<span class="sd">            my_line.update() # rescale only</span>
<span class="sd">            my_line.update(x=x_data, y=y_data) # set x,y data and rescale</span>

<span class="sd">        * To render a Trace grob on a tk.canvas</span>

<span class="sd">            my_line.canvas_id = canvas.create_line(my_trace.canvas_pts, ...)</span>
<span class="sd">            my_rect.canvas_id = canvas.create_rectangle(my_trace.canvas_pts, ...)</span>

<span class="sd">        * To delete a Trace grob from a tk.canvas</span>

<span class="sd">            canvas.delete(my_trace.canvas_id)</span>
<span class="sd">            my_trace.canvas_id = None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_allowed_attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;canvas_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fill&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">_trace_label_font</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;TkDefaultFont&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">parent</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">x_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">y_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">canvas_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

            <span class="c1"># print(&#39;init trace &#39;, label)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">fill</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">x_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">y_offset</span>

            <span class="c1"># None or canvas item index if rendered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_id</span> <span class="o">=</span> <span class="n">canvas_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_pts</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">x_scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">y_scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_border_pad</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">y_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_x_y</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<div class="viewcode-block" id="TraceView.Trace.set_x_y"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.Trace.set_x_y">[docs]</a>        <span class="k">def</span> <span class="nf">set_x_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;store data sample x, y and convert to canvas coords&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">x_scale</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">y_scale</span>

                <span class="c1"># this version paints in an x_scaled dblock length x scrollregion</span>
                <span class="c1"># where the visible region tracks vp_idx * x_scale</span>
                <span class="c1"># canvas_x = [ int(i * self.x_scale) for i in x ]</span>

                <span class="c1"># this version paints in 0 to vp_len * x_scale</span>
                <span class="c1"># canvas_x = [ int( i * self.x_scale) for i in range(self.parent.vp_len) ]</span>
                <span class="n">canvas_x</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_idx</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="c1"># nudge all traces up by y border pad to avoid clipping first</span>
                <span class="n">canvas_y</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_border_pad</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">canvas_x</span><span class="p">,</span> <span class="n">canvas_y</span><span class="p">)]</span></div></div>

<div class="viewcode-block" id="TraceView.TraceHScrollbar"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceHScrollbar">[docs]</a>    <span class="k">class</span> <span class="nc">TraceHScrollbar</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;derived scrollbar to update xview from model on set&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

            <span class="c1"># self.bind(&#39;&lt;Motion&gt;&#39;, self._on_motion)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_button</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># convert viewport indices to normalized values for slider</span>
            <span class="n">dblock_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">/</span> <span class="n">dblock_len</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">/</span> <span class="n">dblock_len</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>

        <span class="k">def</span> <span class="nf">_on_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="c1"># print(&#39;X scroll bar motion&#39;, e)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

        <span class="k">def</span> <span class="nf">_on_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="c1"># print(&#39;X scroll bar click&#39;, e)</span>
            <span class="n">click_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winfo_pointerx</span><span class="p">()</span>
            <span class="n">root_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winfo_rootx</span><span class="p">()</span>
            <span class="n">slider_x</span> <span class="o">=</span> <span class="n">click_x</span> <span class="o">-</span> <span class="n">root_x</span>
            <span class="n">vp_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">(</span><span class="n">slider_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># print(&#39;slider calling _update_vp(vp_idx = {0})&#39;.format(vp_idx))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">vp_idx</span><span class="o">=</span><span class="n">vp_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_streams</span><span class="p">()</span>  <span class="c1"># update traces and dblock</span>
            <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

<div class="viewcode-block" id="TraceView.TraceHScrollbar.set"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.TraceHScrollbar.set">[docs]</a>        <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ttk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;TraceView.TLabelframe&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># sensible viewport defaults</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># these track current state of the viewport, subject to change</span>
        <span class="c1"># from UI events, unify w/ dashboard mini-model some day</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># varies w/ window resizing and dblock changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_dblock_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span>  <span class="c1"># varies w/ Model.dblock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># varies with window resizing and x_scale</span>

        <span class="c1"># self.vp_cursor_idx = None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># to spread traces</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_vp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span><span class="p">)</span>  <span class="c1"># FIX ME</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># UI trace view controls</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># display state toggles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># bind mouse actions to canvas/trace controls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_mouse</span><span class="p">()</span>  <span class="c1"># all the pointer bindings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_keys</span><span class="p">()</span>  <span class="c1"># all the key bindings</span>

        <span class="n">dash_height</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TraceDashboard</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;traces_dash&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">dash_height</span>
        <span class="p">)</span>

        <span class="c1"># viewport location (where in datablock)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TraceHScrollbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sb</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">xview</span><span class="p">)</span>

        <span class="c1"># zoom time scale (x)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_scale_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_scale_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_x_scale</span><span class="p">,</span>
            <span class="n">showvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">from_</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">to</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_scale_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)</span>

        <span class="c1"># zoom uV scale (y)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_y_scale</span><span class="p">,</span>
            <span class="n">showvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">from_</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">to</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span><span class="p">)</span>

        <span class="c1"># y spacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset_sc</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset_sc</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_y_offset</span><span class="p">,</span>
            <span class="n">showvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">from_</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">to</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset_sc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">)</span>

        <span class="c1"># vertical view (y = chan)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>

        <span class="c1"># native vertical scrolling only ... x_sb bindings</span>
        <span class="c1"># drive horizontal scrolling through _update_vp()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">yscrollcommand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># layout</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_scale_sc</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sb</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset_sc</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale_sc</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

        <span class="c1"># trace view canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>

        <span class="c1"># update scrollregion on window resize</span>
        <span class="c1"># &lt;CONFIGURE&gt; useful event ... triggered on window resizing</span>
        <span class="c1"># self.bind(&#39;&lt;Configure&gt;&#39;, self.reset_scrollregion )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Configure&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_configure</span><span class="p">)</span>

        <span class="c1"># initialze viewed data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_vp_cursor</span><span class="p">()</span>  <span class="c1"># FIX ME ... inits should be separate from reset</span>

    <span class="k">def</span> <span class="nf">_on_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="c1"># update viewport on window resize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_streams</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_vp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets the TraceView viewport data</span>

<span class="sd">        The viewport length in samples is derived from the canvas</span>
<span class="sd">        visible fraction of the total scrollable canvas width:</span>
<span class="sd">        len(dblock) * x_scale</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for any change of state that requires a new vp_len calculation</span>
        <span class="n">vp_len_is_stale</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># assume we&#39;re OK</span>

        <span class="c1"># Model dblock changed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dblock_len</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_dblock_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span>
            <span class="n">vp_len_is_stale</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TraceView x_scale changed</span>
        <span class="k">if</span> <span class="n">x_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x_scale</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span> <span class="o">=</span> <span class="n">x_scale</span>
            <span class="c1"># print(&#39;update_vp new x_scale: &#39;, self.x_scale)</span>
            <span class="n">vp_len_is_stale</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Parent frame resized</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">():</span>
            <span class="c1"># print(&#39;update_vp new vp_winfo_width {0}&#39;.format(self.winfo_width()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span>
            <span class="n">vp_len_is_stale</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># update the vp_len if needed</span>
        <span class="k">if</span> <span class="n">vp_len_is_stale</span><span class="p">:</span>
            <span class="n">scrollregion_width</span><span class="p">,</span> <span class="n">scrollregion_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_scrollregion</span><span class="p">()</span>

            <span class="c1"># calc visible portion of the canvas as width minus the 3 y scrollbars ... ugh</span>
            <span class="n">y_ctrls_width</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y_ctrl</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_scale_sc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_offset_sc</span><span class="p">,</span>
            <span class="p">]:</span>  <span class="c1"># hard coded hack</span>
                <span class="n">y_ctrls_width</span> <span class="o">+=</span> <span class="n">y_ctrl</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">y_ctrl</span><span class="o">.</span><span class="n">cget</span><span class="p">(</span><span class="s2">&quot;borderwidth&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># 2 borders</span>

            <span class="c1"># pixels between the scroll bars</span>
            <span class="n">visible_canvas_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">-</span> <span class="n">y_ctrls_width</span>

            <span class="c1"># new vp_len</span>
            <span class="c1"># new_vp_len = max(0,int( (visible_canvas_px / scrollregion_width) * (len(self.model.dblock))) - 1)</span>
            <span class="n">new_vp_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">visible_canvas_px</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">))</span>
            <span class="c1"># print(&#39;update_vp ... stale vp_len {0}, recalculating {1}&#39;.format(self.vp_len, new_vp_len))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">=</span> <span class="n">new_vp_len</span>

        <span class="c1"># with current vp_len in hand, handle vp_idx</span>

        <span class="c1"># update self.vp_idx if one is passed in, else to current vp_idx</span>
        <span class="k">if</span> <span class="n">vp_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># use current vp_idx</span>
            <span class="n">vp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prevent scrolling past the data</span>
            <span class="c1"># print(&#39;new vp_idx {0}&#39;.format(self.vp_idx))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">vp_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">))</span>

        <span class="c1"># set xs all the way to end of vp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;rebuild and render traces and data block table according to current viewport</span>

<span class="sd">        reset_X() instructs view X to consult the data, rebuild the</span>
<span class="sd">        (abstract) grobs, and render them.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;Begin TraceView._update()&#39;)</span>
        <span class="c1"># self.canvas.xview_moveto(self.vp_idx / (len(self.model.dblock)-1) )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sb</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>  <span class="c1"># trace view scrollbar position via vp_idx, vp_len</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_traces</span><span class="p">()</span>  <span class="c1"># always reset and render traces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_vp_cursor</span><span class="p">()</span>  <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_trace_dashboard</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_event_marks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_pygarv</span><span class="p">()</span>  <span class="c1"># always reset and render artifacts</span>

        <span class="c1"># self.parent.children[&#39;dblock_table&#39;]._update()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_vernier</span><span class="p">()</span>
        <span class="c1"># print(&#39;End TraceView._update()&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>

<div class="viewcode-block" id="TraceView.update_x_scale"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.update_x_scale">[docs]</a>    <span class="k">def</span> <span class="nf">update_x_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;handle time zoom&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">vp_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_streams</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.update_y_scale"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.update_y_scale">[docs]</a>    <span class="k">def</span> <span class="nf">update_y_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;handle uV zoom&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_scrollregion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.update_y_offset"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.update_y_offset">[docs]</a>    <span class="k">def</span> <span class="nf">update_y_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;handle trace vertical spacing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_scrollregion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.bind_keys"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.bind_keys">[docs]</a>    <span class="k">def</span> <span class="nf">bind_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bindings&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;e&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_event_marks</span><span class="p">)</span>  <span class="c1"># on/off</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Left&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Right&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Left&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Right&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Up&gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview_scroll</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Down&gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview_scroll</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Up&gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview_scroll</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Down&gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview_scroll</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_trace_xview_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>

        <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)=(\w+)&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">direction</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;keysym&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># fixed direction and step each key press</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;keysym&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Right&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;keysym&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Left&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># debugging</span>
                <span class="c1"># print(repr(e) + &#39;unknown keysym&#39; + event[&#39;keysym&#39;])</span>
                <span class="k">pass</span>

            <span class="c1"># scrolling by samples</span>
            <span class="k">if</span> <span class="s2">&quot;state&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Shift&quot;</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># debugging</span>
                <span class="c1"># print(repr(e) + &#39;unknown keysym&#39; + event[&#39;keysym&#39;])</span>
                <span class="k">pass</span>

        <span class="k">elif</span> <span class="s2">&quot;num&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># disable mousewheel FIX ME</span>
            <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

            <span class="c1"># fixed direction variable step on mousewheel</span>
            <span class="c1"># print(e, event)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># debugging</span>
                <span class="c1"># print(repr(e) + &#39;unknown num &#39; + num)</span>
                <span class="k">pass</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_winfo_width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># debugging</span>
            <span class="c1"># print(&#39;_trace_xview_scroll unknown event&#39;, event)</span>
            <span class="k">pass</span>

        <span class="c1"># work out vp_idx</span>
        <span class="n">is_event_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">is_event_view</span>
        <span class="k">if</span> <span class="n">is_event_view</span><span class="p">:</span>
            <span class="c1"># print(&#39;trace_xview_scroll epoch event_view&#39;)</span>
            <span class="n">vp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">find_next_anchor</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="p">(</span><span class="n">direction</span> <span class="o">*</span> <span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_vp</span><span class="p">(</span><span class="n">vp_idx</span><span class="o">=</span><span class="n">vp_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_update_streams</span><span class="p">()</span>  <span class="c1"># parent in order to propagate to dblock view</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>

    <span class="c1"># move me ------------------------------------------------------------</span>
<div class="viewcode-block" id="TraceView.toggle_event_marks"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.toggle_event_marks">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_event_marks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># print(&#39;event marks on&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(&#39;event marks off&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.canvas_get_focus"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.canvas_get_focus">[docs]</a>    <span class="k">def</span> <span class="nf">canvas_get_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">focus_set</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">render_vernier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_vernier</span><span class="p">()</span>

    <span class="c1"># move me ------------------------------------------------------------</span>

<div class="viewcode-block" id="TraceView.bind_mouse"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.bind_mouse">[docs]</a>    <span class="k">def</span> <span class="nf">bind_mouse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mouse bindings&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Enter&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_get_focus</span><span class="p">)</span>

        <span class="c1"># self.canvas.bind(&#39;&lt;Leave&gt;&#39;, canvas_release_focus)</span>
        <span class="c1"># if needed ...</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;B1-Motion&gt;&#39;, self.b1_drag)</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;B2-Motion&gt;&#39;, self.b2_drag)</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;B3-Motion&gt;&#39;, self.b3_drag)</span>

        <span class="c1"># these move cursor ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Motion&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_vp_cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Button-1&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_vp_cursor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-1&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_vernier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;ButtonRelease-1&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_vernier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;B1-Motion&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_vernier</span><span class="p">)</span>

        <span class="c1"># these linux mousewheel trigger x-scroll arrow clicks to move</span>
        <span class="c1"># Windows has different mousewheel events</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Shift-Button-4&gt;&#39;, self.x_scroll_arrow)</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Shift-Button-5&gt;&#39;, self.x_scroll_arrow)</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Button-4&gt;&#39;, self.y_scroll_arrow) #</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Button-5&gt;&#39;, self.y_scroll_arrow) #</span>

        <span class="c1"># scroll canvas left-right</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Shift-Button-4&gt;&#39;, self.canvas_mouse_wheel)</span>
        <span class="c1"># self.canvas.bind(&#39;&lt;Shift-Button-5&gt;&#39;, self.canvas_mouse_wheel)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Button-4&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Shift-Button-5&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_xview_scroll</span><span class="p">)</span>

        <span class="c1"># scroll canvas up-down</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-4&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_mouse_wheel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-5&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_mouse_wheel</span><span class="p">)</span></div>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># UI callbacks</span>
    <span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="TraceView.canvas_mouse_wheel"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.canvas_mouse_wheel">[docs]</a>    <span class="k">def</span> <span class="nf">canvas_mouse_wheel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>

        <span class="c1"># mousewheel</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview</span><span class="p">(</span><span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>  <span class="c1"># up</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">yview</span><span class="p">(</span><span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>  <span class="c1"># down</span>

        <span class="c1"># shift-mousewheel</span>
        <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">xview</span><span class="p">(</span><span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>  <span class="c1"># right</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">xview</span><span class="p">(</span><span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>  <span class="c1"># left</span></div>

<div class="viewcode-block" id="TraceView.drag_vp_cursor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.drag_vp_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">drag_vp_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dragging mouse over moves viewport cursor and dblock selection</span>

<span class="sd">        This modifies dblock view selection to drive the cursor,</span>
<span class="sd">        indirect but synchronizes dblock selection and cursor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)</span>
        <span class="n">vp_cursor_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)))</span>

        <span class="c1"># this sets selection in dblock view which highlights</span>
        <span class="c1"># selected row and triggers trace view cursor rendering</span>
        <span class="n">dblock_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;dblock_table&quot;</span><span class="p">]</span>
        <span class="n">dblock_view</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">dblock_view</span><span class="o">.</span><span class="n">focus</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vp_cursor_idx</span><span class="p">))</span>
        <span class="n">dblock_view</span><span class="o">.</span><span class="n">selection_set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vp_cursor_idx</span><span class="p">))</span>

        <span class="c1"># place cursor row at top of dblock window, ... 0.5</span>
        <span class="c1"># adjusts for rounding</span>
        <span class="n">y_view</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">vp_cursor_idx</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">))</span>
        <span class="c1"># print(&#39;dragging:&#39;, &#39;x:&#39;, x, &#39;vp_cursor_idx:&#39;, vp_cursor_idx, &#39;dblock yview:&#39;, y_view)</span>
        <span class="n">dblock_view</span><span class="o">.</span><span class="n">yview_moveto</span><span class="p">(</span><span class="n">y_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor_idx</span> <span class="o">=</span> <span class="n">vp_cursor_idx</span></div>

<div class="viewcode-block" id="TraceView.b1_drag"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.b1_drag">[docs]</a>    <span class="k">def</span> <span class="nf">b1_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stub&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;b1 dragging&#39;, e)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TraceView.b2_drag"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.b2_drag">[docs]</a>    <span class="k">def</span> <span class="nf">b2_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stub&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;b2 dragging&#39;, e)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TraceView.b3_drag"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.b3_drag">[docs]</a>    <span class="k">def</span> <span class="nf">b3_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;stub&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;b3 dragging&#39;, e)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TraceView.mouse_wheel"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.mouse_wheel">[docs]</a>    <span class="k">def</span> <span class="nf">mouse_wheel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;handle mouse wheel&quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;mouse wheeling&#39;, e)</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y_start</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">y</span></div>

<div class="viewcode-block" id="TraceView.reset_vp"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_vp">[docs]</a>    <span class="k">def</span> <span class="nf">reset_vp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp_idx</span><span class="p">):</span>  <span class="c1"># , vp_len):</span>
        <span class="sd">&quot;&quot;&quot;set the TraceView viewport index and data slices of the current model.dblock</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vp_idx : int</span>
<span class="sd">           dblock index (samples) of left edge of TraceView viewport</span>

<span class="sd">        viewport start index values may come from keyboard/mouse TraceView navigation or</span>
<span class="sd">        be derived from epoch data lookup during table navigation</span>

<span class="sd">        The viewport length in samples is derived from the canvas</span>
<span class="sd">        scrollregion fraction of the canvas width (== len(dblock) \* x_scale)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(&#39;resetting_vp() vp_idx={0}&#39;.format(vp_idx))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">=</span> <span class="n">vp_idx</span>

        <span class="c1"># set xs all the way to end of vp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span><span class="p">]</span></div>

<div class="viewcode-block" id="TraceView.reset_scrollregion"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_scrollregion">[docs]</a>    <span class="k">def</span> <span class="nf">reset_scrollregion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;change the canvas scrollregion on zoom params or window changes</span>
<span class="sd">        y scrollregion always needs to include all traces.</span>
<span class="sd">        x scrollregion is canvas width ... _update_vp() sets vp_len data points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># scrollregion_width = int( self.x_scale * (len(self.model.dblock)-1) )</span>

        <span class="c1"># FIX ME ... see y_border_pad</span>
        <span class="c1"># add + 2 for first and last trace head room</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;traces&quot;</span><span class="p">):</span>
            <span class="n">traces_height</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">traces_height</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># don&#39;t shrink y scroll region smaller than trace view height</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y_sb&quot;</span><span class="p">):</span>
            <span class="n">y_sb_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_sb</span><span class="o">.</span><span class="n">winfo_height</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_sb_height</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">scrollregion_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span>
        <span class="c1"># print(&#39;reset_scrollregion()&#39;, scrollregion_width)</span>

        <span class="n">scrollregion_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_sb_height</span><span class="p">,</span> <span class="n">traces_height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">scrollregion</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scrollregion_width</span><span class="p">,</span> <span class="n">scrollregion_height</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollregion_width</span><span class="p">,</span> <span class="n">scrollregion_height</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">viewport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># grob object layers: traces, garv, cursor</span>
    <span class="c1">#</span>
    <span class="c1"># reset_X:   refresh grob data for rendering</span>
    <span class="c1"># render_X : paint the glyph on self.canvas</span>
    <span class="c1">#</span>
    <span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="TraceView.reset_trace_dashboard"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_trace_dashboard">[docs]</a>    <span class="k">def</span> <span class="nf">reset_trace_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pull info from the trace dashboard view controls and render</span>


<span class="sd">        - anchor marker</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>  <span class="c1"># sync trace dashboard widgets/data</span>

        <span class="c1"># build grobs ...</span>
        <span class="c1"># x,y,w,h = [int(px) for px in self.canvas.cget(&#39;scrollregion&#39;).split()]</span>

        <span class="n">y_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;traces&quot;</span><span class="p">)</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace_dashboard_grobs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">anchor_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">anchor_dblock_idx</span>
        <span class="k">if</span> <span class="n">anchor_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_dashboard_grobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">prestim_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">prestim_dblock_idx</span>
        <span class="c1"># print(&#39;vp_idx&#39;, self.vp_idx)</span>
        <span class="c1"># print(&#39;dashboard._data&#39;, self.dashboard._data)</span>
        <span class="c1"># print(&#39;rendering prestim grob at&#39;, prestim_idx)</span>
        <span class="k">if</span> <span class="n">prestim_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_dashboard_grobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">prestim_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prestim&quot;</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">poststim_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">poststim_dblock_idx</span>
        <span class="c1"># print(&#39;rendering poststim grob at&#39;, poststim_idx)</span>
        <span class="k">if</span> <span class="n">poststim_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_dashboard_grobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">poststim_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;poststim&quot;</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render_trace_dashboard</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.render_trace_dashboard"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_trace_dashboard">[docs]</a>    <span class="k">def</span> <span class="nf">render_trace_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;render or hide the trace dashboard view grobs&quot;&quot;&quot;</span>

        <span class="c1"># clean up previous if any ...</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="s2">&quot;dash_grob_ids&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">dash_grob_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">dgid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">dash_grob_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dgid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">dash_grob_ids</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="c1"># render new if scrolling by events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">is_event_view</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">dash_grob_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">grob</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_dashboard_grobs</span><span class="p">:</span>
                <span class="c1"># print(&#39;canvas.create dash grob&#39;, repr(grob), grob.canvas_pts)</span>
                <span class="n">grob_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span>
                    <span class="n">grob</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">grob</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">grob</span><span class="o">.</span><span class="n">width</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">dash_grob_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grob_id</span><span class="p">)</span></div>

    <span class="c1"># EEG trace grobs</span>
<div class="viewcode-block" id="TraceView.reset_traces"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_traces">[docs]</a>    <span class="k">def</span> <span class="nf">reset_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># combination init + reset ... slow but simple</span>
        <span class="c1"># build minimal Trace containers for current model dblock</span>
        <span class="n">trace_stream_labels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;dig_chan&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trace_stream_labels</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;O&quot;</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">]</span>

        <span class="p">(</span>
            <span class="n">at</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span>
        <span class="c1"># print(&#39;setting traces&#39;, at, n_samples)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trace_stream_labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_xs</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_ys</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">y_offset</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_traces</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.render_traces"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_traces">[docs]</a>    <span class="k">def</span> <span class="nf">render_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;fetch viewport info from model and render&quot;&quot;&quot;</span>

        <span class="c1"># clear traces in view port and redraw</span>
        <span class="p">(</span>
            <span class="n">at</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">canvas_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># configure trace attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">canvas_id</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">activewidth</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="n">label_nudge</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># pts</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">label_nudge</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_text</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span>
                    <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;sw&quot;</span><span class="p">,</span>
                    <span class="n">font</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">_trace_label_font</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># bind individual trace call backs here if any</span>
            <span class="c1"># self.canvas.tag_bind(t.canvas_id, ... )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>  <span class="c1"># makes display a bit more responsive</span></div>

    <span class="c1"># vernier grob</span>
<div class="viewcode-block" id="TraceView.reset_vernier"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_vernier">[docs]</a>    <span class="k">def</span> <span class="nf">reset_vernier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># note: vp_idx build in during Trace.__init__</span>
        <span class="n">x_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
        <span class="n">y_cal</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vernier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">y_cal</span><span class="p">,</span> <span class="o">-</span><span class="n">y_cal</span><span class="p">,</span> <span class="o">-</span><span class="n">y_cal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TraceView.render_vernier"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_vernier">[docs]</a>    <span class="k">def</span> <span class="nf">render_vernier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="c1"># Note ... tried state=&#39;normal&#39; vs &#39;hidden&#39;, no bbox?</span>
        <span class="c1"># self.vernier.set_x_y(self.vernier.x, self.vernier.y)</span>
        <span class="n">vernier_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)</span>
        <span class="n">vernier_pts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">vernier_x</span><span class="p">,</span>
                <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">canvasy</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">y_border_pad</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">canvas_pts</span>
        <span class="p">]</span>

        <span class="c1"># print(&#39;vernier_pts&#39;, vernier_pts)</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ButtonPress&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vernier_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span>
                <span class="n">vernier_pts</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Motion&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier_item</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vernier_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span>
                <span class="n">vernier_pts</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ButtonRelease&quot;</span><span class="p">:</span>
            <span class="c1"># print(&#39;vernier off&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vernier_item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;uh oh ... trouble with vernier&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">))</span></div>

    <span class="c1"># Event grobs</span>
<div class="viewcode-block" id="TraceView.reset_event_marks"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_event_marks">[docs]</a>    <span class="k">def</span> <span class="nf">reset_event_marks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;called when viewport changes&quot;&quot;&quot;</span>
        <span class="n">ev_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span>
            <span class="mi">0</span>
        <span class="p">]</span>  <span class="c1"># event , this dblock</span>
        <span class="n">ev_idxs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ev_idx</span>
            <span class="k">for</span> <span class="n">ev_idx</span> <span class="ow">in</span> <span class="n">ev_idxs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">&lt;=</span> <span class="n">ev_idx</span> <span class="ow">and</span> <span class="n">ev_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_marks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ev_idx</span> <span class="ow">in</span> <span class="n">ev_idxs</span><span class="p">:</span>
            <span class="n">ev_mark_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">][</span><span class="n">ev_idx</span><span class="p">]),</span>
                <span class="n">x</span><span class="o">=</span><span class="p">((</span><span class="n">ev_idx</span><span class="p">),)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">),</span>
            <span class="p">)</span>  <span class="c1"># span the traces</span>
            <span class="c1"># ev_mark_trace.set_x_y(x=ev_mark_trace.x, y=ev_mark_trace.y)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev_mark_trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_event_marks</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.render_event_marks"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_event_marks">[docs]</a>    <span class="k">def</span> <span class="nf">render_event_marks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># skip if not viewing events</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_marks_on</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="p">(</span>
            <span class="n">at</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span>
        <span class="k">for</span> <span class="n">ev_mark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_marks</span><span class="p">:</span>
            <span class="n">ev_mark</span><span class="o">.</span><span class="n">canvas_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">ev_mark</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span>
                <span class="n">ev_mark</span><span class="o">.</span><span class="n">canvas_id</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">ev_mark</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_text</span><span class="p">(</span>
                <span class="n">ev_mark</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">ev_mark</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">text</span><span class="o">=</span><span class="n">ev_mark</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="c1"># pygarv artifact grobs</span>
<div class="viewcode-block" id="TraceView.reset_pygarv"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.reset_pygarv">[docs]</a>    <span class="k">def</span> <span class="nf">reset_pygarv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;called when dblock or PyGarv.tr_docs test changes&quot;&quot;&quot;</span>

        <span class="c1"># for readability ... a better way?</span>
        <span class="c1"># pg = self.nametowidget(&#39;.!view.!dataview.pygarv&#39;).pg</span>
        <span class="c1"># pg = self.master.model.pg</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span>

        <span class="c1"># nothing to see</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span>
            <span class="ow">or</span> <span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;pygarv bug: no tr_docs for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_path</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># for readability</span>
        <span class="n">dbp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dbp_idx</span>
        <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>

        <span class="c1"># spot check tr_doc dblocks and fails==pygarv &gt; 0</span>
        <span class="k">assert</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;tr_docs[</span><span class="si">{0}</span><span class="s2">] fails and pygarv do not agree&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbp_idx</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># no fails to render, go home</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pygarvs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># container for pygarv traces, if any</span>
        <span class="n">fails</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># accumulate info on fails in this viewport</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_fails</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]):</span>
            <span class="c1"># test_fails may be empty ...</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_fails</span><span class="p">:</span>
                <span class="c1"># collect fail intervals that intersect this viewport</span>
                <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="ow">or</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># truncate fail to this viewport</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">this_fail</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">test_idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># print(this_fail)</span>
                <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_fail</span><span class="p">)</span>
                <span class="c1"># print(len(fails))</span>
        <span class="c1"># print(&#39;n fails: &#39;, len(fails))</span>

        <span class="c1"># reverse index the stream labels</span>
        <span class="n">trace_idxs</span> <span class="o">=</span> <span class="n">odict</span><span class="p">([(</span><span class="n">t</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)])</span>

        <span class="c1"># unnpack the fail tests and regions</span>
        <span class="c1"># self.pygarvs = np.ndarray(shape=(len(fails),), dtype=&#39;O&#39;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fail</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fails</span><span class="p">):</span>

            <span class="c1"># fetch the test params</span>
            <span class="n">this_test</span> <span class="o">=</span> <span class="n">odict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">][</span><span class="n">fail</span><span class="p">[</span><span class="s2">&quot;test_idx&quot;</span><span class="p">]]:</span>
                <span class="n">this_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># look up the streams to mark as bad, if None mark all</span>
            <span class="n">streams</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">this_test</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;stream&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

            <span class="c1"># regex patterns, literals &#39;MiPa&#39; or with wildcards &#39;Mi..&#39; or &#39;..Pf&#39;</span>
            <span class="n">stream_patts</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">this_test</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;stream&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

            <span class="c1"># list of trace labels that match test stream regexp</span>
            <span class="n">streams</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span><span class="o">.</span><span class="n">label</span>
                <span class="k">for</span> <span class="n">stream_patt</span> <span class="ow">in</span> <span class="n">stream_patts</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">stream_patt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># fall back to all channels</span>
            <span class="c1"># if len(streams) == 0:</span>
            <span class="c1">#    streams = [s.label for s in self.traces]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">streams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no streams found in this pygarv test, yell at urbach: &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_test</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># calculate artifact boundaries and build</span>
            <span class="c1"># pygarv trace snippets to overplot the traces</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">streams</span><span class="p">):</span>

                <span class="c1"># x slicer</span>
                <span class="n">vp_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">fail</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span><span class="p">,</span> <span class="n">fail</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># y index into traces by stream label ... scary</span>
                <span class="n">trace_idx</span> <span class="o">=</span> <span class="n">trace_idxs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

                <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">vp_slice</span><span class="p">]</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="n">trace_idx</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">vp_slice</span><span class="p">]</span>  <span class="c1"># brittle</span>

                <span class="c1"># debugging</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pygarv xs len == 0&quot;</span><span class="p">)</span>

                <span class="c1"># turn single point artifacts into short vertical line segments</span>
                <span class="c1"># line segments</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># scale segment w/ y</span>
                    <span class="n">seg_prop</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">*</span> <span class="n">seg_prop</span><span class="p">),</span>
                        <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">*</span> <span class="n">seg_prop</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="n">this_garv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pygarv&quot;</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">ys</span><span class="p">,</span>
                    <span class="n">y_offset</span><span class="o">=</span><span class="n">trace_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">this_garv</span><span class="o">.</span><span class="n">set_x_y</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pygarvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_garv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_pygarv</span><span class="p">()</span></div>

<div class="viewcode-block" id="TraceView.render_pygarv"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_pygarv">[docs]</a>    <span class="k">def</span> <span class="nf">render_pygarv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">at</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewport</span>

        <span class="c1"># clean up previous</span>
        <span class="c1"># clear_these = [garv_trace for garv_trace in self.pygarvs \</span>
        <span class="c1">#                if garv_trace.canvas_id is not None]</span>
        <span class="c1"># for garv_trace in clear_these:</span>
        <span class="c1">#     self.canvas.delete(garv_trace.canvas_id)</span>

        <span class="c1"># left edge of garv trace is self.vp_idx</span>
        <span class="c1"># right edge of garv trace is self.vp_idx + self.vp_len</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pygarvs</span><span class="p">):</span>
            <span class="c1"># if len(p.x) == 1:</span>
            <span class="c1">#     msg = (&#39;Fixing single sample artifacts: self.vp_idx: &#39;</span>
            <span class="c1">#            &#39;{0} self.vp_len {1}&#39;).format(self.vp_idx,</span>
            <span class="c1">#                                         self.vp_len)</span>
            <span class="c1">#     warnings.warn(msg)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     try:</span>
            <span class="c1">#         p.canvas_id = self.canvas.create_line(p.canvas_pts)</span>
            <span class="c1">#     except:</span>
            <span class="c1">#         pdb.set_trace()</span>

            <span class="n">p</span><span class="o">.</span><span class="n">canvas_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">canvas_id</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>

    <span class="c1"># cursor grob</span>
<div class="viewcode-block" id="TraceView.init_vp_cursor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.init_vp_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">init_vp_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cursor&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TraceView.render_vp_cursor"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.TraceView.render_vp_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">render_vp_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp_cursor_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor_idx</span> <span class="o">=</span> <span class="n">vp_cursor_idx</span>

        <span class="c1"># clear cursor grob, if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span><span class="o">.</span><span class="n">canvas_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span><span class="o">.</span><span class="n">canvas_id</span><span class="p">)</span>

        <span class="c1"># redraw if new or moved</span>
        <span class="k">if</span> <span class="n">vp_cursor_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># clear current if rendered</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor_idx</span><span class="p">),)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="c1"># atrocious hack to compensate for Trace auto yscale</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traces</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span><span class="p">)</span>  <span class="c1"># span the traces</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span><span class="o">.</span><span class="n">set_x_y</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span><span class="o">.</span><span class="n">canvas_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vp_cursor</span><span class="o">.</span><span class="n">canvas_pts</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;white&quot;</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="Application"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.Application">[docs]</a><span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;top level viewer frame&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmp_yarf_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">mkh5_f</span><span class="o">=</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">tmp_yarf_f</span><span class="o">=</span><span class="n">tmp_yarf_f</span><span class="p">)</span>

        <span class="c1"># FIX ME ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">)</span></div>


<div class="viewcode-block" id="launch_app"><a class="viewcode-back" href="../../api_source/mkpy.mkh5viewer.html#mkpy.mkh5viewer.launch_app">[docs]</a><span class="k">def</span> <span class="nf">launch_app</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">tmp_yarf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">mkh5_f</span> <span class="o">+</span> <span class="s2">&quot;.yarf.&quot;</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="o">=</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">tmp_yarf_f</span><span class="o">=</span><span class="n">tmp_yarf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">set_styles</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
    <span class="n">tmp_yarf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">launch_app</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021 Thomas P. Urbach, Andrey Portnoy, 2013 Nathaniel Smith.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>