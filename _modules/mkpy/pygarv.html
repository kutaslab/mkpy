

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mkpy.pygarv &mdash; mkpy 0.2.5.dev5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-rendered-html.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> mkpy
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Introduction (0.2.5.dev5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation (64-bit linux only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Quick%20Start.html">Quick start with <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AS_howto.html">A. Stoermannâ€™s online how-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CheatSheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../UserGuide.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ExamplesGallery.html">Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Learning.html">Background reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ReleaseNotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RolesCredits.html">Roles and credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mkpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../mkpy.html">mkpy</a> &raquo;</li>
        
      <li>mkpy.pygarv</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mkpy.pygarv</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;pygarv is the backend for marking artifacts in mkh5 data with tests defined in a YAML file</span>

<span class="sd">Successful runs of tests and their results are stored in</span>
<span class="sd">PyGarv.tr_docs a list of tr_doc dicts, one dict per h5 datablock.</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>
<span class="sd">tr_doc[&#39;tests&#39;] : list</span>
<span class="sd">   each item is a dict</span>


<span class="sd">Examples</span>

<span class="sd">* tr_doc[&#39;tests&#39;]</span>

<span class="sd">   .. code-block:: python</span>

<span class="sd">      [ {&#39;dblock_path_idx&#39;: 0,</span>
<span class="sd">         &#39;dblock_path&#39;: &#39;calstest/dblock_0&#39;,</span>
<span class="sd">         &#39;name&#39;: &#39;pygarv&#39;,</span>
<span class="sd">         &#39;tests&#39;: [ [{&#39;test&#39;: &#39;ppa&#39;},</span>
<span class="sd">                     {&#39;tag&#39;: &#39;amplitude exursions&#39;},</span>
<span class="sd">                     {&#39;stream&#39;: &#39;MiCe&#39;},</span>
<span class="sd">                     {&#39;threshold&#39;: 0.0},</span>
<span class="sd">                     {&#39;interval&#39;: 0.0} ],</span>
<span class="sd">                    [{&#39;test&#39;: &#39;ppadif&#39;},</span>
<span class="sd">                     {&#39;tag&#39;: &#39;amplitude exursions&#39;},</span>
<span class="sd">                     {&#39;stream&#39;: &#39;MiCe&#39;},</span>
<span class="sd">                     {&#39;threshold&#39;: 0.1},</span>
<span class="sd">                     {&#39;interval&#39;: 0.1},</span>
<span class="sd">                     {&#39;stream2&#39;: &#39;MiPa&#39;} ] ]},</span>

<span class="sd">          {&#39;dblock_path_idx&#39;: 1,</span>
<span class="sd">           &#39;dblock_path&#39;: &#39;calstest/dblock_1&#39;,</span>
<span class="sd">           &#39;name&#39;: &#39;pygarv&#39;,</span>
<span class="sd">           &#39;tests&#39;: None},</span>
<span class="sd">      ]</span>

<span class="sd">tr_doc[&#39;fails&#39;] : list</span>

<span class="sd">len(tr_doc[&#39;fails&#39;] == len(tr_doc[&#39;tests&#39;])</span>
<span class="sd">where tr_doc[&#39;fails&#39;][idx] is</span>

<span class="sd">a list of (start, stop) intervals in dblock_tick indexes where tr_doc[&#39;test&#39;] failed. </span>
<span class="sd">tr_doc[&#39;pygarv&#39;]</span>



<span class="sd">* The tests are specified as a YAML file .yarf.</span>

<span class="sd">  .. code-block:: yaml</span>

<span class="sd">     ---</span>
<span class="sd">     dblock_path: some_path</span>
<span class="sd">     dblock_path_idx: unint</span>
<span class="sd">     name: pygarv</span>
<span class="sd">     tests:</span>
<span class="sd">     - - test_spec</span>
<span class="sd">       - test_spec</span>
<span class="sd">       ...</span>
<span class="sd">       - test_spec</span>

<span class="sd">* Each `test_spec` is a YAML map with a mandatory `name` and `tag`</span>
<span class="sd">  parameter and optional other paramters as needed for specific tests</span>

<span class="sd">  test: str</span>
<span class="sd">  tag: str</span>

<span class="sd">where</span>

<span class="sd">  `test` names a pygarv test function, e.g., `mxflat`, `ppadif`</span>
<span class="sd">  `tag` is a user-defined descriptive tag, e.g., *blocking*, *heog*, *fancy test*</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pprint</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">yamllint</span> <span class="kn">import</span> <span class="n">linter</span>
<span class="kn">from</span> <span class="nn">yamllint.config</span> <span class="kn">import</span> <span class="n">YamlLintConfig</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">mkh5</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># import dpath.util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dpath</span>

<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">mkh5viewer</span>


<div class="viewcode-block" id="PyYarf"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf">[docs]</a><span class="k">class</span> <span class="nc">PyYarf</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;YAML test file I/O for PyGarv artifact test parameters </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yarf_f : str</span>
<span class="sd">      file path to well-formed YAML with PyYarf test specification structure</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    yarf_docs : list </span>
<span class="sd">       each item is a yarf_doc dict that yamlizes in-out without modification</span>
<span class="sd">       ..code-block:: python</span>

<span class="sd">         {&#39;name&#39;: &#39;pygarv&#39; (str),</span>
<span class="sd">          &#39;dblock_path_idx&#39;: n (uint)</span>
<span class="sd">          &#39;dblock_path&#39;: path_to_a_mkh5_dblock (str),</span>
<span class="sd">          &#39;tests&#39;: [ test_spec, ... test_spec] (list)}</span>

<span class="sd">    Methods </span>
<span class="sd">    ------------</span>
<span class="sd">    IO methods </span>
<span class="sd">       read yarf_docs from yaml</span>
<span class="sd">       write yarf_docs to yaml</span>
<span class="sd">       read yarf_docs from mkh5 headers </span>

<span class="sd">        </span>
<span class="sd">    PyYarf YAML format:</span>
<span class="sd">      * exactly one yaml document per mkh5 dblock_path</span>
<span class="sd">      * each doc is a map with 3 keys: `name`, `dblock_path`, `tests`</span>
<span class="sd">      * the value of `name` must be `pygarv` (str)</span>
<span class="sd">      * the value of `dblock_path` in the ith yaml doc must == mkh5.data_blocks[i] (str)</span>
<span class="sd">      * the value of `tests` must be a list of test specifications (see PyGarvTest docs)</span>

<span class="sd">    Examples</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">       # generated by PyYarf</span>
<span class="sd">       ---</span>
<span class="sd">       dblock_path_idx: 0</span>
<span class="sd">       dblock_path: calstest/dblock_0</span>
<span class="sd">       name: pygarv</span>
<span class="sd">       tests:</span>
<span class="sd">         - - test: ppa_event</span>
<span class="sd">	   - tag: tag1</span>
<span class="sd">	   - stream: MiPf</span>
<span class="sd">	   - threshold: 20.0</span>
<span class="sd">	   - prestim: 500.0</span>
<span class="sd">	   - poststim: 1500.0</span>
<span class="sd">	 - - test: ppa_event</span>
<span class="sd">	   - tag: tag1</span>
<span class="sd">	   - stream: MiCe</span>
<span class="sd">	   - threshold: 50.0</span>
<span class="sd">	   - prestim: 100.0</span>
<span class="sd">	   - poststim: 1000.0</span>
<span class="sd">	 - - test: ppa_event</span>
<span class="sd">	   - tag: tag1</span>
<span class="sd">	   - stream: MiPa</span>
<span class="sd">	   - threshold: 10.0</span>
<span class="sd">	   - prestim: 10.0</span>
<span class="sd">	   - poststim: 200.0</span>
<span class="sd">       ---</span>
<span class="sd">       dblock_path_idx: 1</span>
<span class="sd">       dblock_path: calstest/dblock_1</span>
<span class="sd">       name: pygarv</span>
<span class="sd">       tests: []</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.1&quot;</span>

    <span class="n">_yarf_config</span> <span class="o">=</span> <span class="n">YamlLintConfig</span><span class="p">(</span><span class="s2">&quot;extends: default&quot;</span><span class="p">)</span>
    <span class="n">_yarf_doc_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">dblock_path_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dblock_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pygarv&quot;</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yarf_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yarf_f</span> <span class="o">=</span> <span class="n">yarf_f</span>

    <span class="c1"># yarf file CRUD ... yaml I/O</span>
<div class="viewcode-block" id="PyYarf.read_from_yaml"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf.read_from_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">read_from_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return yarf_doc list populated with yarf info, if any, from mkh5 dblock headers&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yf</span><span class="p">:</span>
            <span class="n">yaml_stream</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lint_yarf</span><span class="p">(</span><span class="n">yaml_stream</span><span class="p">)</span>  <span class="c1"># raises Exception on bad YAML</span>

        <span class="c1"># thank you PyYaml</span>
        <span class="n">yarf_iter</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="n">yaml_stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">)</span>
        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">yarf_doc</span> <span class="ow">in</span> <span class="n">yarf_iter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_yarf_doc</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">)</span>
            <span class="n">yarf_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yarf_docs</span>  <span class="c1"># so far so good ...</span></div>

<div class="viewcode-block" id="PyYarf.read_from_mkh5"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf.read_from_mkh5">[docs]</a>    <span class="k">def</span> <span class="nf">read_from_mkh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;scan mkh5 dblock headers and dblock[&#39;pygarv&#39;] stream artifact test info</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        yarf_docs : list of list of dict where</span>
<span class="sd">            dict is a PyYarf format dict see PyYarf doc string for details </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">has_yarf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># for error checking</span>
        <span class="n">h5</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dbpath</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
            <span class="n">yarf_doc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;pygarv&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">yarf_doc</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_yarf_doc</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">)</span>
                <span class="n">has_yarf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># build an empty one</span>
                <span class="n">yarf_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yarf_doc_template</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="c1"># print(&#39;loading empty yarf_doc&#39;, dbpath)</span>
                <span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbpath</span>
                <span class="n">has_yarf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">yarf_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">)</span>

        <span class="c1"># none is OK, all is OK, some but not all is probably pathological</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">has_yarf</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">has_yarf</span><span class="p">):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">has_yarf</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;uh oh ... missing pygarv info in headers of </span><span class="si">{0}</span><span class="s2"> &quot;</span> <span class="s2">&quot;dblocks </span><span class="si">{1}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">yarf_docs</span></div>

<div class="viewcode-block" id="PyYarf.to_yaml"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf.to_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_docs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return yarf_docs YAML-ized as string suitable for serialization</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yaml_stream</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;# generated by PyYarf v. </span><span class="si">{0}</span><span class="s2">, &quot;</span> <span class="s2">&quot;edit at your own risk</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">yarf_doc</span> <span class="ow">in</span> <span class="n">yarf_docs</span><span class="p">:</span>
            <span class="n">yaml_stream</span> <span class="o">+=</span> <span class="s2">&quot;---</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># doc delimiter</span>
            <span class="n">yaml_stream</span> <span class="o">+=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="n">yarf_doc</span><span class="p">,</span> <span class="n">explicit_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lint_yarf</span><span class="p">(</span><span class="n">yaml_stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yaml_stream</span></div>

    <span class="c1"># YAML lint a string</span>
<div class="viewcode-block" id="PyYarf.lint_yarf"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf.lint_yarf">[docs]</a>    <span class="k">def</span> <span class="nf">lint_yarf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; run yamllint on yarf_stream, if errors die informatively &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">linter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">yarf_stream</span><span class="p">,</span> <span class="n">PyYarf</span><span class="o">.</span><span class="n">_yarf_config</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">*** </span><span class="si">{0}</span><span class="s2"> ***</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyYarf.check_yarf_doc"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyYarf.check_yarf_doc">[docs]</a>    <span class="k">def</span> <span class="nf">check_yarf_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_doc</span><span class="p">):</span>
        <span class="c1"># does each YAML doc have all and only the right keys?</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">yarf_doc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">PyYarf</span><span class="o">.</span><span class="n">_yarf_doc_template</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;yarf doc </span><span class="si">{0}</span><span class="s2"> must have &quot;</span>
                <span class="s2">&quot;exactly these keys: </span><span class="si">{1}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">,</span> <span class="n">PyYarf</span><span class="o">.</span><span class="n">_yarf_doc_template</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># name?</span>
        <span class="k">if</span> <span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PyYarf</span><span class="o">.</span><span class="n">_yarf_doc_template</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;yarf doc &#39;name&#39;: </span><span class="si">{0}</span><span class="s2"> &quot;</span> <span class="s2">&quot;must be </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># if there are tests are they a list?</span>
        <span class="k">if</span> <span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;yarf doc &#39;tests&#39;: </span><span class="si">{0}</span><span class="s2"> &quot;</span> <span class="s2">&quot;must be a list of tests&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> must be a list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">param_spec</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s1">&#39;.yarf </span><span class="si">{0}</span><span class="s1">:  test parameter &quot;</span><span class="si">{1}</span><span class="s1">&quot; is not &#39;</span>
                            <span class="s2">&quot;a {{key:value}} pair&quot;</span>
                            <span class="s2">&quot;&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">],</span> <span class="n">param_spec</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PyGarvTest"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarvTest">[docs]</a><span class="k">class</span> <span class="nc">PyGarvTest</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator class for the PyGarv tests.</span>

<span class="sd">    This enforces an extensible standard form on PyGarv test specs and</span>
<span class="sd">    execution.</span>

<span class="sd">    The class derives from OrderedDict so it returns .keys() .values()</span>
<span class="sd">    .items() in fixed original parameter order. This is useful for</span>
<span class="sd">    populating test UI elements and reading writing YAML sequences</span>
<span class="sd">    without scrambling the key:value pairs the way a dict() might.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_specs : [(key,type), ...]</span>
<span class="sd">        key : str </span>
<span class="sd">          parameter label</span>
<span class="sd">        type : Python type</span>
<span class="sd">          required Python data type for values of the key</span>

<span class="sd">	(&#39;test&#39;,str), </span>
<span class="sd">        (&#39;tag&#39;, str),</span>
<span class="sd">        (&#39;stream&#39;, str),</span>


<span class="sd">    * Default test parameters (in sequence order)</span>

<span class="sd">      test : str</span>
<span class="sd">         corresponds to the self._test() function that runs it</span>
<span class="sd">      tag : str</span>
<span class="sd">         user specified descriptive tag for the test ... anything sensible </span>
<span class="sd">      stream : str</span>
<span class="sd">         name or regex pattern for primary dblock data stream(s) to run the test on</span>

<span class="sd">    * Optional test specific `parameter:type` pairs are defined in the</span>
<span class="sd">      decorator arguments</span>


<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">      ValueError</span>
<span class="sd">          If the type of a test parameter differs from that in ``param_specs``</span>


<span class="sd">    * ``PyGarvTest`` overrides ``OrderedDict.__setitem__()`` with</span>
<span class="sd">      additional type checking on the value of test[&#39;key&#39;] = value</span>

<span class="sd">    * The class variable ``param_specs`` specifies mandatory</span>
<span class="sd">      ``PyGarvTest`` parameters and types.</span>

<span class="sd">    * Optional decorator arguments can extend the mandatory parameters</span>
<span class="sd">      and types and will be automatically passed to the decorated test</span>
<span class="sd">      function.</span>

<span class="sd">    * all PyGarvTest instances have _default_params with key, type</span>

<span class="sd">    * optional decorater args extend PyGarvTest instances with additional params</span>

<span class="sd">    * public CRUD API is standardized </span>

<span class="sd">    * To preserve test spec order for display and yamlized round</span>
<span class="sd">      trips, test specs are stored internally as OrderedDicts and the</span>
<span class="sd">      setter/getter API wants and returns lists of dict, i.e.,</span>
<span class="sd">      ..code-block:: python</span>

<span class="sd">        [{&#39;test&#39;:&#39;ppa&#39;}, ...{&#39;interval&#39;:1500.0}]</span>



<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    run(hdr, dblock, **kwargs)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdr : dict</span>
<span class="sd">            metadata consulted in running the tests, e.g., sampling rate</span>
<span class="sd">        dblock : np.ndarray (named dtypes)</span>
<span class="sd">            columns of data, typically accessed by dtype.name</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : np.ndarray, dtype=bool, length = len(dblock)</span>
<span class="sd">            sample-wise data rejection mask, 1=bad, 0=good</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_max_path_len</span> <span class="o">=</span> <span class="mi">4096</span>  <span class="c1"># no particular reason, roughly max linux path length</span>

    <span class="c1"># default parameter types, all PyGarvTests</span>
    <span class="n">__default_param_specs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; test is passed in by decorator, kwargs are optional param=type specs&quot;&quot;&quot;</span>

        <span class="c1"># handle the types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># default params</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">PyGarvTest</span><span class="o">.</span><span class="n">__default_param_specs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># add any extra params, types from decorator</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># set as an attribute to cross-check case self[&#39;test&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>

        <span class="c1"># self[&#39;test&#39;] = test, other key values = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># Override setting to include validation</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; type check all item settings &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># check type all keys</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2"> value required type </span><span class="si">{2}</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># prevent string overrun</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PyGarvTest</span><span class="o">.</span><span class="n">_max_path_len</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;string length exceeds </span><span class="si">{0}</span><span class="s2"> for </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2"> ... </span><span class="si">{3}</span><span class="s2">&quot;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">PyGarvTest</span><span class="o">.</span><span class="n">_max_path_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># check stream patterns can be compiled</span>
            <span class="k">if</span> <span class="s2">&quot;stream&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;bad regexp pattern: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; ... </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># cross-check</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;failed on test=</span><span class="si">{0}</span><span class="s2"> ... cannot change read-only value&quot;</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">OrderedDict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># decorator magic here wraps the decorated function, e.g.</span>
    <span class="c1">#</span>
    <span class="c1">#   @PyGarvTest(ppa)</span>
    <span class="c1">#   ppa(header, dblock, **kwargs)</span>
    <span class="c1">#</span>
    <span class="c1"># with kwargs from self.keys(), self.values() and</span>
    <span class="c1"># exposes the callable self.run() to do the work</span>
    <span class="c1">#</span>
    <span class="c1"># Similar to duck typing flexibility but with built in keys and</span>
    <span class="c1"># value type-checking per-test by the decorator ...  simple but</span>
    <span class="c1"># flexible.</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; f(header, dblock, ...) &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># convert self odict k,v to dict for kwargs</span>
            <span class="n">test_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">test_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="c1"># now PyGarv.ppa.run(hdr, dblock, ...)  will execute with current params</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># --------------------------------------------------</span>
    <span class="c1"># public-ish setter/getters</span>
    <span class="c1"># --------------------------------------------------</span>
<div class="viewcode-block" id="PyGarvTest.set_specs"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarvTest.set_specs">[docs]</a>    <span class="k">def</span> <span class="nf">set_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; test_params is {key:value, ... } for test keys,values &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>

<div class="viewcode-block" id="PyGarvTest.reset"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarvTest.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># init the values</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PyGarvTest.get_specs"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarvTest.get_specs">[docs]</a>    <span class="k">def</span> <span class="nf">get_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span></div>

<div class="viewcode-block" id="PyGarvTest.param_type"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarvTest.param_type">[docs]</a>    <span class="k">def</span> <span class="nf">param_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; type of param &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="p">[</span><span class="n">param</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; names of the parameters this test as a list &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; data types of the values for the parameters as a list &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_types</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_specs</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specs_as_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns current specs as yaml string &quot;&quot;&quot;</span>
        <span class="n">yaml_specs</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">,</span> <span class="n">explicit_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">yaml_specs</span></div>


<div class="viewcode-block" id="PyGarv"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv">[docs]</a><span class="k">class</span> <span class="nc">PyGarv</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;container to hold an inventory of functions for computing sample-wise </span>
<span class="sd">    artifact masks.</span>


<span class="sd">    When invoked at the command line, pygarv needs an mkh5 file to work with</span>

<span class="sd">    There are two cases:</span>
<span class="sd">      - has not been previously garved with _update_mkh5()</span>
<span class="sd">          - no pygarv test info in header</span>
<span class="sd">          - pygarv data streams all zeros</span>

<span class="sd">      - data has been previously garved with _update_mkh5()</span>
<span class="sd">          - pygarv test info appears in header</span>
<span class="sd">          - test results are unknown, possibly None</span>
<span class="sd">          - pygarv data stream state is unknown</span>

<span class="sd">    On init the mkh5 file is scanned for previous runs, if found the</span>
<span class="sd">    pygarv data buffers (volatile) are synced with the info from the h5</span>
<span class="sd">    file.</span>

<span class="sd">    For each data block:</span>

<span class="sd">      - self.tr_docs are set to match the header[&#39;pygarv&#39;] dict</span>
<span class="sd">      - self.yarf_fails are set according to dblock[&#39;pygarv&#39;], self.tr_docs</span>
<span class="sd">      - the value of pygarv = run_test(db_idx) (what-if run) is</span>
<span class="sd">        checked against the dblock data, discrepanices throw a warning</span>

<span class="sd">    PyGarv now has persistent and volatile rejection data in</span>
<span class="sd">    alignment, suitable for viewing/editing in mkh5viewer</span>

<span class="sd">    PyGarvTest</span>

<span class="sd">    The PyGarvTest decorator handles all the default parameter</span>
<span class="sd">    name and type bookkeeping for specific tests </span>
<span class="sd">    </span>
<span class="sd">    To add a test to the catalog ...</span>
<span class="sd">      </span>
<span class="sd">    1. implement a function that takes two args (hdr, dblock,</span>
<span class="sd">    \*\*kwargs) and returns a boolean artifact mask of length dblock</span>
<span class="sd">    data samples where 0 = good, 1 = bad.</span>
<span class="sd">    </span>
<span class="sd">    The hdr (dict), and dblock (np.ndarray) are, e.g., as</span>
<span class="sd">    returned by hdr, dblock = mkh5.get_dblock(path_to_datablock) </span>
<span class="sd">    but can by any dict and dblock that expose variable needed to </span>
<span class="sd">    compute the artifact mask. </span>
<span class="sd">    </span>
<span class="sd">    2. decorate it with @PyGarvTest(test_name, [key=dtype, key=dtype])</span>
<span class="sd">      </span>
<span class="sd">    where test_name is the test name and the list of key_i=dtype_i</span>
<span class="sd">    optionally gives extra parameters named key_1, ... key_n </span>
<span class="sd">    with data type dtype.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">yarf_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;continuous artifact rejection manager  </span>

<span class="sd">        # FIX ME ... move to main PyGarv docs</span>

<span class="sd">        - self.mkh5</span>

<span class="sd">             read-only record of tests in dblock[&#39;pygarv&#39;] and hdr[&#39;pygarv&#39;]. persistent.</span>

<span class="sd">        - self.dblock_paths : list of str, </span>

<span class="sd">             sequence of all the mkh5 datablock slashpaths as returned by mkh5.data_blocks</span>

<span class="sd">        - self.tr_docs : list of dict</span>

<span class="sd">             &quot;tr_&quot; abbreviates &quot;test results&quot;. There is exactly one</span>
<span class="sd">             tr_doc per mkh5 data and it is the master pygarv data</span>
<span class="sd">             structure. It contains contain all the yarf_docs test</span>
<span class="sd">             info *plus* test run results as a pygarv vector (1-D</span>
<span class="sd">             array) of 64-bit uints and a list of fails.</span>

<span class="sd">             By design, tests are dry run *before* loading into</span>
<span class="sd">             tr_docs so these volatile test_specs, fails, and pygarv</span>
<span class="sd">             vector are always 1-1 and consistent.</span>
<span class="sd">             </span>
<span class="sd">             The tr_doc initialized from mkh5_f headers or loaded from</span>
<span class="sd">             YAML .yarf. The tr_docs may be passed to PyYarfIO and the</span>
<span class="sd">             test specs written as YAML.</span>

<span class="sd">             tr_doc format on init</span>

<span class="sd">             {&#39;name&#39;: &#39;pygarv&#39;, </span>
<span class="sd">              &#39;dblock_path&#39;: &#39;&#39;</span>
<span class="sd">              &#39;dblock_path_idx: None</span>
<span class="sd">              &#39;tests&#39;: [ [] ... [] ], </span>
<span class="sd">              &#39;fails&#39;: [ [] ... [] ],</span>
<span class="sd">              &#39;pygarv&#39;: np.zeros(shape=(len(dblock), ), </span>
<span class="sd">                                 dtype=dblock[&#39;pygarv&#39;].dtype)</span>

<span class="sd">             Each item in `tests` is a PyGarvTest format test specification</span>

<span class="sd">             Each item in `fails` item is the corresponding test failures of</span>
<span class="sd">             the form:</span>

<span class="sd">                [(x0_0,x1_0) ... (x0_n,x1_n)]</span>

<span class="sd">             where x0_i,x1_i are the index of beginning and end of a</span>
<span class="sd">             contiguous fail. Note: x0==x1 for single sample failed is</span>
<span class="sd">             allowed.</span>


<span class="sd">        </span>
<span class="sd">        dbp_index  dblock_paths      tr_docs        </span>
<span class="sd">        -----      --------------    ---------      </span>
<span class="sd">          0        dblock_paths[0]   tr_docs[0]     </span>
<span class="sd">          1        dblock_paths[1]   tr_docs[1]     </span>
<span class="sd">        </span>
<span class="sd">          .               .                .   </span>
<span class="sd">          .               .                .   </span>
<span class="sd">          .               .                .   </span>


<span class="sd">          n        dblock_paths[n]   tr_docs[n]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reset test parameters b.c. with class decorator approach, new</span>
        <span class="c1"># instances in the same namespace inherit test specs set</span>
        <span class="c1"># during previous calls</span>

        <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;mkh5&quot;</span><span class="p">,</span> <span class="s2">&quot;mkh5_f&quot;</span><span class="p">,</span> <span class="s2">&quot;dblock_paths&quot;</span><span class="p">,</span> <span class="s2">&quot;yarf&quot;</span><span class="p">,</span> <span class="s2">&quot;tr_docs&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># clear tests in case of carry over from previous test runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_tests</span><span class="p">()</span>

        <span class="c1"># set the inventory of available tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_catalog</span><span class="p">()</span>

        <span class="c1"># set the file names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span> <span class="o">=</span> <span class="n">mkh5_f</span>

        <span class="c1"># ready the mkh5 data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span>

        <span class="c1"># ready the yarf I/O manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yarf</span> <span class="o">=</span> <span class="n">PyYarf</span><span class="p">()</span>  <span class="c1">#</span>

        <span class="c1"># init the tests and results data structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">):</span>
            <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp</span><span class="p">)</span>
            <span class="n">tr_doc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;dblock_path&quot;</span><span class="p">:</span> <span class="n">dbp</span><span class="p">,</span>
                <span class="s2">&quot;dblock_path_idx&quot;</span><span class="p">:</span> <span class="n">dbp_idx</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pygarv&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tests&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;fails&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;pygarv&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_tr_docs_from_yarf_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_docs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;iterates through an entire yarf_docs (= test specs) and updates tr_docs&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_tr_docs</span><span class="p">(</span><span class="n">yarf_docs</span><span class="p">)</span>

        <span class="c1"># dry run individual tests all tests individually</span>
        <span class="k">for</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">):</span>
            <span class="n">yarf_doc</span> <span class="o">=</span> <span class="n">yarf_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yarf_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]):</span>
                <span class="c1"># default test_idx=None is to append the tests and results</span>
                <span class="n">exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_tr_docs</span><span class="p">(</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">exception</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> in data_block: </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">dbp</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exception</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_tr_docs</span><span class="p">(</span><span class="n">yarf_docs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_tr_docs_from_mkh5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; scrape all yarf docs, from mkh5 headers, run and collect all in tr_docs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;updating tr_docs from mkh5&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mkh5_f not set&quot;</span><span class="p">)</span>

        <span class="c1"># gotta have some data ...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no data block paths in &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># populate yarf docs from existing hdr[&#39;pygarv&#39;] footprints</span>
        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yarf</span><span class="o">.</span><span class="n">read_from_mkh5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">)</span>

        <span class="c1"># collect tests in tr_docs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_tr_docs_from_yarf_docs</span><span class="p">(</span><span class="n">yarf_docs</span><span class="p">)</span>

        <span class="c1"># FIX ME??? ... compare tr_doc[&#39;pygarv &#39;] with dblock[&#39;pygarv&#39;] and</span>
        <span class="c1"># and warn of mismatch</span>

    <span class="k">def</span> <span class="nf">_update_tr_docs_from_yaml_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; collect all YAML tests and results into tr_docs &quot;&quot;&quot;</span>

        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yarf</span><span class="o">.</span><span class="n">read_from_yaml</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_tr_docs_from_yarf_docs</span><span class="p">(</span><span class="n">yarf_docs</span><span class="p">)</span>

        <span class="c1"># # pygarv.mkh5 may or may not have been pygarved. Either way,</span>
        <span class="c1"># # if there is a yarf_f, it trumps previous pygarv info</span>
        <span class="c1"># if self.yarf_f is None:</span>
        <span class="c1">#     raise ValueError(&#39;yarf_f not set&#39;)</span>

    <span class="c1"># tr_docs getters ...</span>
    <span class="k">def</span> <span class="nf">_get_yarf_doc_from_tr_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_doc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pulls out just the yarf_doc test info from current tr_docs[dbp_idx], no results.</span>
<span class="sd">        Unfortuante consequence of pooling tests and results in tr_docs, tho a lesser evil</span>
<span class="sd">        than segregating them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yarf_doc_keys</span> <span class="o">=</span> <span class="n">PyYarf</span><span class="o">.</span><span class="n">_yarf_doc_template</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">yarf_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">yarf_doc_keys</span><span class="p">:</span>
            <span class="n">yarf_doc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr_doc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">yarf_doc</span>

    <span class="k">def</span> <span class="nf">_get_yarf_docs_from_tr_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">yarf_docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tr_doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">:</span>
            <span class="n">yarf_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_yarf_doc_from_tr_doc</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">yarf_docs</span>

    <span class="k">def</span> <span class="nf">_init_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; inventory of implemented tests as given by @PyGarvTest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">this_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_attr</span><span class="p">,</span> <span class="n">PyGarvTest</span><span class="p">):</span>
                <span class="n">this_attr</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># clear params</span>
                <span class="n">catalog</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">this_attr</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">this_attr</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">catalog</span>

    <span class="k">def</span> <span class="nf">_load_tr_docs_from_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yarf_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; populate self.tr_docs dict from YAML yarf file &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yarf</span><span class="o">.</span><span class="n">read_from_yaml</span><span class="p">(</span><span class="n">yarf_f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_tr_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_docs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sanity check tr_docs list lines up with h5 data blocks and each </span>
<span class="sd">        yarf_doc is well-formed. </span>

<span class="sd">        Checks form only, does not re-run tests or check semantics of the results</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tr_docs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tr_docs is None&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_docs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">db_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">):</span>

            <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>

            <span class="c1"># do pygarv and fails agree at least in form?</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">all</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">any</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;tr_docs[</span><span class="si">{0}</span><span class="s2">] fails and pygarv do not agree&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbp_idx</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># check that non-zero bits in the tr_doc[&#39;pygarv&#39;] still</span>
            <span class="c1"># agree w/ non-emtpy tr_doc[&#39;fails&#39;]</span>
            <span class="n">fails_from_pygarv_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_pygarv_stream</span><span class="p">(</span>
                <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">],</span> <span class="n">tr_doc</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fails_from_pygarv_bits</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;tr_doc[&quot;</span>
                        <span class="s2">&quot;pygarv&quot;</span>
                        <span class="s2">&quot;] bits do not match non-empty tr_doc[&quot;</span>
                        <span class="s2">&quot;fails&quot;</span>
                        <span class="s2">&quot;] ... yell at urbach immediately</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot;data block path: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;fails according to tr_doc[&quot;</span>
                        <span class="s2">&quot;pygarv&quot;</span>
                        <span class="s2">&quot;] bits: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fails_from_pygarv_bits</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;fails according to tr_doc[&quot;</span>
                        <span class="s2">&quot;fails&quot;</span>
                        <span class="s2">&quot;]: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">log_msg</span><span class="p">))</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;probable pygarv bug ... see the latest .mkpy/logs for details&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; clears parameter specs, all tests &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">this_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_attr</span><span class="p">,</span> <span class="n">PyGarvTest</span><span class="p">):</span>
                <span class="n">this_attr</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># clear any residual parameters</span>

<div class="viewcode-block" id="PyGarv.get_catalog"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.get_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span></div>

    <span class="k">def</span> <span class="nf">_run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;run the test  on the dblock[dpb_idx] data</span>

<span class="sd">        This is a dry run ... returns usable results and fails, does not change data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            dbp_idx : uint</span>
<span class="sd">               index of the datablock to run the tests on </span>
<span class="sd">            test_spec : list</span>
<span class="sd">               pygarv test specs format [param:value, ... param:value]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">         (results, fails) : 2-ple </span>
<span class="sd">            results : np.ndarray, len(dblock), dtype=bool</span>
<span class="sd">                True at samples where test failed</span>
<span class="sd">            fails : list of uint tuples</span>
<span class="sd">               [{&#39;x0&#39;: i, &#39;x1&#39;: j, &#39;test_idx&#39;, k}, ...  ] where</span>
<span class="sd">                 the i, j are start, end of consecutive True, </span>
<span class="sd">                 i.e., a stretch of bad data and k is the index of the test in</span>
<span class="sd">                 the list of tests, this dblock</span>

<span class="sd">        Normative use is where</span>
<span class="sd">        </span>
<span class="sd">            `result` is returned by pg.sometest.run(hdr,dblock)</span>
<span class="sd">            `test` is an item from the test list at tr_docs[dbp_idx][&#39;tests&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pg.dblock_paths == mkh5.data_blocks, should fix mkh5</span>
        <span class="n">dbp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>

        <span class="c1"># lookup data block hdr and data. Note: strict hdf5 root paths</span>
        <span class="c1"># have a slash prefix, the h5py root datagroup path does not</span>
        <span class="c1"># so we remain agnostic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PyGarv.dblock_paths is None&quot;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp</span><span class="p">)</span>
        <span class="n">hdr_dbp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/*(.+)&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># sanity checks ... header, h5.data_blocks, yarf ...does everything agree?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbp</span> <span class="o">==</span> <span class="n">hdr_dbp</span><span class="p">:</span>  <span class="c1">#  == test_params[&#39;dblock_path&#39;]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fatal mismatch in tr_doc, h5 header, test dblock path&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># fill test specs</span>
        <span class="n">test_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">test_spec</span><span class="p">:</span>
            <span class="n">test_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span>

        <span class="c1"># lookup the test function in the pygarv catalog by name</span>
        <span class="c1"># and set its params</span>
        <span class="n">this_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="p">[</span><span class="n">test_params</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]]</span>
        <span class="n">this_test</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">this_test</span><span class="o">.</span><span class="n">set_specs</span><span class="p">(</span><span class="n">test_params</span><span class="p">)</span>

        <span class="c1"># run it, then clear the settings</span>
        <span class="n">this_result</span> <span class="o">=</span> <span class="n">this_test</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">)</span>
        <span class="n">this_test</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># fails [ (start,stop) ... (start,stop)] for contiguous fails</span>
        <span class="n">fails</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_result</span><span class="p">(</span><span class="n">this_result</span><span class="p">)</span>

        <span class="c1"># if we make it here ... update</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">this_result</span><span class="p">,</span> <span class="n">fails</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compress_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;compress full-length boolean pygarv boolean result test vector into</span>
<span class="sd">        a list of fails [(start,stop)...(start,stop)] tuples encoding</span>
<span class="sd">        contiguous runs of True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fail_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fails_x0_x1</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># case 1: no points failed this test</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no fails so no (x0,x1) tuples</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case 2: one or more points failed this test</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_xs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail_idxs</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">fail_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># init left edge, exists b.c len &gt; 0</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">n_xs</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">fail_idxs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>  <span class="c1"># update right edge which may == left edge</span>
                <span class="k">if</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n_xs</span><span class="p">:</span>
                    <span class="c1"># last point is always a right bound, no new region</span>
                    <span class="n">fails_x0_x1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># look ahead continuous fail</span>
                    <span class="k">if</span> <span class="n">fail_idxs</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fail_idxs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># if not, append and start a new retion</span>
                        <span class="n">fails_x0_x1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="n">fail_idxs</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">fails_x0_x1</span>  <span class="c1"># possibly []</span>

<div class="viewcode-block" id="PyGarv.run_dblock"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.run_dblock">[docs]</a>    <span class="k">def</span> <span class="nf">run_dblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">tr_doc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run tests in the tr_doc for datablock at dbp_idx, returns 64-bit pygarv sample mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dpb_idx : uint</span>
<span class="sd">          index of the ith dblock in self.dblock_paths</span>
<span class="sd">        tr_doc : dict</span>
<span class="sd">          PyYarf format dict with tr_doc[&#39;tests&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          results </span>
<span class="sd">	    dict of results like so:</span>

<span class="sd"> 	    .. code-block:: python</span>

<span class="sd">               {name: &#39;results&#39;,</span>
<span class="sd">                dblock_path: str (== the yarf_dbp),</span>
<span class="sd">                pygarv : np.ndarray(shape=(len(dblock),),</span>
<span class="sd">                                    dtype=dblock[&#39;pygarv&#39;].dtype),</span>
<span class="sd">                fails : list of uint 2-ples (x0, x1)}</span>

<span class="sd">        * The fails list amounts to an RLL compression of the boolean vector `pygarv &gt; 0` </span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">          ValueError if tr_doc[&#39;dblock_path&#39;] != self.dblock_paths[dbp_idx]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># originally from h5</span>
        <span class="n">dbp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>

        <span class="c1"># from PyYarf</span>
        <span class="n">yarf_dbp</span> <span class="o">=</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span>

        <span class="n">yarf_test_list</span> <span class="o">=</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span>

        <span class="c1"># lookup data block hdr and data. Note: hdf5 root paths have a</span>
        <span class="c1"># slash prefix, the h5py root datagroup path does not so we</span>
        <span class="c1"># remain agnostic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PyGarv.dblock_paths is None&quot;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp</span><span class="p">)</span>
        <span class="n">hdr_dbp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/*(.+)&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># three way sanity check ... header, h5.data_blocks, yarf ...does everything agree?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbp</span> <span class="o">==</span> <span class="n">yarf_dbp</span> <span class="o">==</span> <span class="n">hdr_dbp</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fatal mismatch in mkh5 - pygarv - .yarf dblock path&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># init the return ... no tests -&gt; no fails -&gt; all zeros</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">,</span>
            <span class="n">dblock_path</span><span class="o">=</span><span class="n">yarf_dbp</span><span class="p">,</span>
            <span class="n">pygarv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">fails</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if nothing to do, return</span>
        <span class="k">if</span> <span class="n">yarf_test_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">yarf_test_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="c1"># otherwise run the tests in yarf test list</span>

        <span class="c1"># init to whatever dtype is in the dblock[&#39;pygarv&#39;]</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># compute the bit fiddled pygarv artifact mask</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yarf_test_list</span><span class="p">):</span>

            <span class="c1"># gather the list of key:value params for this test in</span>
            <span class="c1"># into a dict for test.set_specs(kwargs)</span>
            <span class="n">test_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="c1"># test_params[&#39;dblock_path&#39;] = dbp # DEPRECATED</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">test_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span>

            <span class="c1"># lookup the test function in the pygarv catalog by name</span>
            <span class="c1"># and set its params</span>
            <span class="n">this_test</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">this_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="p">[</span><span class="n">test_params</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]]</span>
            <span class="n">this_test</span><span class="o">.</span><span class="n">set_specs</span><span class="p">(</span><span class="n">test_params</span><span class="p">)</span>

            <span class="c1"># run it then clear the params</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">this_test</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">)</span>
            <span class="n">this_test</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="c1"># update the results[&#39;pygarv&#39;] stream from the boolean result</span>
            <span class="c1"># by OR masking the ith bit where the test fails</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_pygarv_stream</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">])</span>

        <span class="c1"># map the fiddled bits back to indices of the test in</span>
        <span class="c1"># tr_doc that failed ... this is for visualization, human</span>
        <span class="c1"># consumption at run time, not stored in mkh5 hdr or dblock</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_pygarv_stream</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">],</span> <span class="n">tr_doc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;fails&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;updating test results: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="PyGarv.get_result"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.get_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pg_test_result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience wrapper to query a test result, decode the mask, and </span>
<span class="sd">        return with its test in a handy package.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pg_test_result : a (tr_doc, pygarv_mask) tuple</span>
<span class="sd">            as returned by run_* functions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="PyGarv.run_tests"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.run_tests">[docs]</a>    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;fetch tests and pygarv mask for all dblocks, does not modify mkh5</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pg_test_results : list of 2-ples (tr_doc, pygarv_mask), one</span>
<span class="sd">        for each datablock in self.mkh5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># one mask per dblock, suitable for assigning to</span>
        <span class="c1"># hdr[&#39;pygarv&#39;]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">):</span>
            <span class="c1"># print(&#39;pygarving&#39;, dbp)</span>
            <span class="n">these_results</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dblock</span><span class="p">(</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="n">tr_doc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span></div>

    <span class="k">def</span> <span class="nf">_update_mkh5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; wrapper to pull tests and results out of tr_docs and push them into mkh5&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no tr_docs&quot;</span><span class="p">)</span>

        <span class="n">hio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">HeaderIO</span><span class="p">()</span>  <span class="c1"># used below to update header</span>
        <span class="k">for</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">data_blocks</span><span class="p">):</span>
            <span class="c1"># sanity check</span>
            <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dbp</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;uh oh ... mkh5 v. tr_doc dblock_path mismatch in _update_mkh5&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;dblock_path_idx&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dbp_idx</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;uh oh ... mkh5 v. tr_doc dblock_path_idx mismatch in _update_mkh5&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                    <span class="n">dblock</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="n">dbp</span><span class="p">]</span>  <span class="c1"># open, read write h5py Dataset</span>

                    <span class="c1"># overwrite the pygarv data stream and header[&#39;pygarv&#39;]</span>
                    <span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span>  <span class="c1"># bit-fiddled stream</span>

                    <span class="n">hio</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>  <span class="c1"># fetch header, this dblock</span>

                    <span class="c1"># brittle ... accessing header dict directly</span>
                    <span class="n">hio</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_yarf_doc_from_tr_doc</span><span class="p">(</span><span class="n">tr_doc</span><span class="p">)</span>
                    <span class="n">hio</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>  <span class="c1"># modded header jsonified into dblock.attrs</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VERY VERY BAD ... pygarving </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> failed part &quot;</span>
                    <span class="s2">&quot;way through, possible mkh5 data corruption.&quot;</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yarf_f</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msg</span><span class="p">),)</span>
                <span class="k">raise</span> <span class="n">err</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># Test Developer API:</span>
    <span class="c1">#</span>
    <span class="c1"># hdr : dict</span>
    <span class="c1">#     mkh5 dblock header ... sample rate, column specs, etc..</span>
    <span class="c1">#</span>
    <span class="c1"># dblock : np.ndarray</span>
    <span class="c1">#     mkh5 data block</span>
    <span class="c1">#</span>
    <span class="c1"># default kwarg keys exposed by PyGarvTest for use in the test body:</span>
    <span class="c1">#</span>
    <span class="c1">#    &#39;dblock_path&#39; (str) current dblock_path</span>
    <span class="c1">#    &#39;test&#39; (str)  name of this test</span>
    <span class="c1">#    &#39;tag&#39; (str)  user description, may be anything</span>
    <span class="c1">#    &#39;stream&#39; (str) name of dblock dtype for column selection</span>
    <span class="c1">#    &#39;threshold&#39; (float) test critical value</span>
    <span class="c1">#    &#39;interval&#39; (float)  length of interval (ms) to sweep the test</span>
    <span class="c1">#</span>
    <span class="c1"># Note: to dump or inspect kwarg keys:values at run time use, e.g.,</span>
    <span class="c1">#</span>
    <span class="c1">#  print(kwargs)</span>
    <span class="c1">#  pdb.set_trace()</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># ------------------------------------------------------------</span>

    <span class="c1"># garv-like event-based tests ... *only* the event code sample gets tagged</span>
    <span class="c1"># param_types = dict(stream=str, threshold=float, prestim=float, poststim=float)</span>
    <span class="c1"># @PyGarvTest(&#39;ppa&#39;, **param_types)</span>
    <span class="c1"># def ppa(hdr, dblock, *args, **kwargs):</span>
    <span class="c1">#     &#39;&#39;&#39;tag events with single stream peak-to-peak amplitude excursions</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     stream : regex</span>
    <span class="c1">#        stream label pattern to match, e.g. &#39;MiPa&#39; or &#39;\w+&#39;</span>
    <span class="c1">#     threshold : float</span>
    <span class="c1">#        amplitude excursion threshold</span>
    <span class="c1">#     prestim : float (&gt;= 0)</span>
    <span class="c1">#        length in ms to scan before the anchor event</span>
    <span class="c1">#     poststim : float (&gt;= 0)</span>
    <span class="c1">#        length in ms to scan after the anchor event</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     stream = kwargs[&#39;stream&#39;]</span>
    <span class="c1">#     threshold = kwargs[&#39;threshold&#39;]</span>
    <span class="c1">#     prestim_ms = kwargs[&#39;prestim&#39;]</span>
    <span class="c1">#     poststim_ms = kwargs[&#39;poststim&#39;]</span>
    <span class="c1">#     print(&#39;running ppa_event&#39;, threshold, prestim_ms, poststim_ms)</span>
    <span class="c1">#     prestim_samps = mkh5.mkh5._ms2samp(prestim_ms, hdr[&#39;samplerate&#39;])</span>
    <span class="c1">#     poststim_samps = mkh5.mkh5._ms2samp(poststim_ms, hdr[&#39;samplerate&#39;])</span>

    <span class="c1">#     n_samps = len(dblock)</span>
    <span class="c1">#     result = np.full(shape=(n_samps,), fill_value=False)</span>
    <span class="c1">#     ev_idxs = np.where(dblock[&#39;log_evcodes&#39;] &gt; 0)[0]</span>
    <span class="c1">#     for ev_idx in ev_idxs:</span>
    <span class="c1">#         interval = slice( max(0,ev_idx-prestim_samps), min(n_samps, ev_idx + poststim_samps))</span>
    <span class="c1">#         ev_view = dblock[stream][interval].view()</span>
    <span class="c1">#         if np.ptp(ev_view) &gt; threshold:</span>
    <span class="c1">#             result[ev_idx] = True  # mark this event sample bad</span>
    <span class="c1">#     return result</span>

<div class="viewcode-block" id="PyGarv.ppa"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.ppa">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span><span class="s2">&quot;ppa&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">prestim</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">poststim</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ppa</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;tag event if any stream regexp match has peak-to-peak amplitude excursion</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream : regex</span>
<span class="sd">           stream label pattern to match, e.g. &#39;.+&#39; or &#39;MiPa&#39; or &#39;\w+&#39;</span>
<span class="sd">        threshold : float</span>
<span class="sd">           amplitude excursion threshold</span>
<span class="sd">        prestim : float (&gt;= 0)</span>
<span class="sd">           length in ms to scan before the anchor event</span>
<span class="sd">        poststim : float (&gt;= 0)</span>
<span class="sd">           length in ms to scan after the anchor event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream_patt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span>
        <span class="n">test_streams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">stream</span>
            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">stream_patt</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;dig_chan&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">stream</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_streams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no streams match: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_patt</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">prestim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">]</span>
        <span class="n">poststim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;poststim&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;running ppa with regex stream&quot;</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">prestim_ms</span><span class="p">,</span>
            <span class="n">poststim_ms</span><span class="p">,</span>
            <span class="n">test_streams</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">prestim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">prestim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>
        <span class="n">poststim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">poststim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>

        <span class="n">n_samps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># init no artifacts</span>
        <span class="n">ev_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ev_idx</span> <span class="ow">in</span> <span class="n">ev_idxs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">test_streams</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">-</span> <span class="n">prestim_samps</span><span class="p">),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">+</span> <span class="n">poststim_samps</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">ev_view</span> <span class="o">=</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">][</span><span class="n">interval</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
                <span class="c1"># thank you numpy ...</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">ev_view</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span>
                        <span class="n">ev_idx</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># mark this event sample bad on first bad channel</span>
                    <span class="k">break</span>  <span class="c1"># no need to look further</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">ev_idx</span><span class="p">]:</span>
                <span class="k">continue</span>  <span class="c1"># move on to the next event</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PyGarv.maxflat"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.maxflat">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span>
        <span class="s2">&quot;maxflat&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nsamp</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">prestim</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">poststim</span><span class="o">=</span><span class="nb">float</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">maxflat</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;tag events on regex stream for flat runs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stream : regex</span>
<span class="sd">           stream label pattern to match, e.g. &#39;MiPa&#39; or &#39;\w{3}$&#39;</span>
<span class="sd">        threshold : float</span>
<span class="sd">           minimum range allowable</span>
<span class="sd">        nsamp : int</span>
<span class="sd">           length in samples of rolling window to scan for flatness</span>
<span class="sd">        prestim : float (&gt;= 0, units ms)</span>
<span class="sd">           time (ms) relative to the event to start scanning for flatness</span>
<span class="sd">        poststim : float (&gt;= 0, units ms)</span>
<span class="sd">           time (ms) relative to the event to stop scanning for flatness</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : np.ndarray(shape=(len(dblock), ), dtype=&#39;bool&#39;)</span>
<span class="sd">           True at dblock indexs where test fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream_patt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span>
        <span class="n">test_streams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">stream</span>
            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">stream_patt</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;dig_chan&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">stream</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_streams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no streams match: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_patt</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">prestim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">]</span>
        <span class="n">poststim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;poststim&quot;</span><span class="p">]</span>

        <span class="n">win_len</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nsamp&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">win_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;maxflat nsamp must be &gt; 0&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running mxflat_event&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">win_len</span><span class="p">,</span> <span class="n">prestim_ms</span><span class="p">,</span> <span class="n">poststim_ms</span><span class="p">)</span>
        <span class="n">prestim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">prestim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>
        <span class="n">poststim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">poststim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>

        <span class="n">n_samps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ev_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ev_idx</span> <span class="ow">in</span> <span class="n">ev_idxs</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">-</span> <span class="n">prestim_samps</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">+</span> <span class="n">poststim_samps</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">test_streams</span><span class="p">:</span>
                <span class="n">ev_view</span> <span class="o">=</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">][</span><span class="n">interval</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev_view</span><span class="p">)</span> <span class="o">-</span> <span class="n">win_len</span><span class="p">):</span>
                    <span class="c1"># scan nsamp sub intervals for a flat line</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">ev_view</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">win_len</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">ev_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># mark this event sample bad</span>
                        <span class="k">break</span>  <span class="c1"># no need to look further</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">ev_idx</span><span class="p">]:</span>
                    <span class="k">continue</span>  <span class="c1"># done, these streams move on to the next event</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="n">param_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">stream</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">stream2</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">prestim</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">poststim</span><span class="o">=</span><span class="nb">float</span>
    <span class="p">)</span>

<div class="viewcode-block" id="PyGarv.ppadif"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.ppadif">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span><span class="s2">&quot;ppadif&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">param_types</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ppadif</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tag events with two-stream amplitude difference excursions&quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream2&quot;</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">prestim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prestim&quot;</span><span class="p">]</span>
        <span class="n">poststim_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;poststim&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running ppadif&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">prestim_ms</span><span class="p">,</span> <span class="n">poststim_ms</span><span class="p">)</span>
        <span class="n">prestim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">prestim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>
        <span class="n">poststim_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">poststim_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>

        <span class="n">n_samps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ev_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ev_idx</span> <span class="ow">in</span> <span class="n">ev_idxs</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">-</span> <span class="n">prestim_samps</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_samps</span><span class="p">,</span> <span class="n">ev_idx</span> <span class="o">+</span> <span class="n">poststim_samps</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span>
                    <span class="n">dblock</span><span class="p">[</span><span class="n">interval</span><span class="p">][</span><span class="n">stream</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span> <span class="o">-</span> <span class="n">dblock</span><span class="p">[</span><span class="n">interval</span><span class="p">][</span><span class="n">stream2</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="o">&gt;</span> <span class="n">threshold</span>
            <span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">ev_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="c1"># continuous data tagging tests ----------------------------------------</span>
    <span class="n">param_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<div class="viewcode-block" id="PyGarv.cstdev"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.cstdev">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span><span class="s2">&quot;cstdev&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">param_types</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cstdev</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tag intervals that span cross-channel amplitude standard deviation excursions&quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">interval_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running stdev&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">interval_ms</span><span class="p">)</span>
        <span class="n">interval_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">interval_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>
        <span class="n">eeg_streams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">stream_name</span>
            <span class="k">for</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;dig_chan&quot;</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># for i in range(len(dblock)):</span>
        <span class="c1">#     result[i] = np.std(dblock[eeg_streams][i].astype(np.ndarray)) &gt; threshold</span>
        <span class="n">nsamp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nsamp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dblock</span><span class="p">[</span><span class="n">eeg_streams</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">interval_samps</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="c1"># this test takes two extra params w/ numpy dtypes str, float</span>
    <span class="n">param_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">stream2</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<div class="viewcode-block" id="PyGarv.cppadif"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.cppadif">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span><span class="s2">&quot;cppadif&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">param_types</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cppadif</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;peak-to-peak amplitude difference stream2 - stream&quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span>
        <span class="n">stream2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stream2&quot;</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
        <span class="n">interval_ms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
        <span class="n">interval_samps</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="o">.</span><span class="n">_ms2samp</span><span class="p">(</span><span class="n">interval_ms</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running ppadif:&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">stream2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">interval_ms</span><span class="p">)</span>

        <span class="n">nsamp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nsamp</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">dblock</span><span class="p">[</span><span class="n">stream2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># fast enough</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nsamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">interval_samps</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">interval_samps</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="n">param_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<div class="viewcode-block" id="PyGarv.cppa"><a class="viewcode-back" href="../../api_source/mkpy.pygarv.html#mkpy.pygarv.PyGarv.cppa">[docs]</a>    <span class="nd">@PyGarvTest</span><span class="p">(</span><span class="s2">&quot;cppa&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">param_types</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cppa</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;peak-to-peak amplitude (stub)&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running ppa:&quot;</span><span class="p">)</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># print(dblock[kwargs[&#39;stream&#39;]])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">),))</span></div>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># PyGarv.tr_docs CRUD</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_delete_tr_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;removes the test and its results from at tr_docs[dbp_idx]</span>
<span class="sd">        [&#39;tests&#39;][test_idx] and updates </span>
<span class="sd">        the tr_docs[dbp_idx][&#39;fails&#39;] tr_docs[dbp_idx][&#39;pygarv&#39;]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>  <span class="c1"># lookup the tests/results doc</span>
        <span class="n">n_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">test_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">test_idx</span><span class="p">)</span>

        <span class="c1"># move the pygarv bits above the popped test one bit left</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_idx</span><span class="p">,</span> <span class="n">n_tests</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">-=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>  <span class="c1"># zero out the ith bit</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>  <span class="c1"># copy i+1 bit to ith bit</span>
        <span class="n">mask</span> <span class="o">-=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">n_tests</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">n_tests</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># zero out the last bit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_tr_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Primary Create/Update pygarv test CRUD operation. </span>

<span class="sd">        The test is dry run on data_blocks[dbp_idx]. If an exception</span>
<span class="sd">        is raised, it is returned. If no exception is raised, the</span>
<span class="sd">        corresponding tr_docs[dbp_idx] test specs and results are</span>
<span class="sd">        modified and None is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">        dbp_idx: uint</span>
<span class="sd">            index of the ith datablock path in self.mkh5.data_blocks</span>
<span class="sd">        test_idx : uint</span>
<span class="sd">           index of the test in the self.tr_docs[dbp_idx][&#39;tests&#39;]. </span>
<span class="sd">           If None, operation appends test to tr_docs[dbp_idx][&#39;tests&#39;]</span>
<span class="sd">        test: list</span>
<span class="sd">            PyGarvTest format list of singleton param:value dicts,</span>
<span class="sd">            e.g., [ {key:val}, ..., {key:val}]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The first Exception raised when running the test or None on success.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tr_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">]</span>  <span class="c1"># lookup the tests/results doc</span>
        <span class="n">n_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">])</span>

        <span class="c1"># check the test index this dblock</span>
        <span class="k">if</span> <span class="n">test_idx</span> <span class="o">&gt;</span> <span class="n">n_tests</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;test_idx &gt; number of tests&quot;</span><span class="p">)</span>

        <span class="c1"># dry run the test and collect results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">fails</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_test</span><span class="p">(</span><span class="n">dbp_idx</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="c1"># if we make it here, mod the tr_docs with the new info</span>
        <span class="k">if</span> <span class="n">test_idx</span> <span class="o">&lt;</span> <span class="n">n_tests</span><span class="p">:</span>
            <span class="c1"># update is overwrite in place</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">][</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;fails&quot;</span><span class="p">][</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fails</span>
        <span class="k">elif</span> <span class="n">test_idx</span> <span class="o">==</span> <span class="n">n_tests</span><span class="p">:</span>
            <span class="c1"># update is append</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;fails&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fails</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># handled on the way in</span>
            <span class="k">pass</span>

        <span class="c1"># update the pygarv vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_pygarv_stream</span><span class="p">(</span>
            <span class="n">test_idx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_docs</span><span class="p">[</span><span class="n">dbp_idx</span><span class="p">][</span><span class="s2">&quot;pygarv&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># misc private utility methods</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_encode_pygarv_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set only i-th bit of pygarv mask[j] = 1 where results[j] == True for test_idx == i</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_idx : uint &lt; 64</span>
<span class="sd">           index in the list of tests, this dblock. Bit at this index encodes results</span>
<span class="sd">        results : np.ndarray, dtype=bool</span>
<span class="sd">           sample-wise results of a pygarv test ... 1 is bad/fail, 0 is good/pass</span>
<span class="sd">        mask : np.array, dtype=&#39;u4&#39;</span>
<span class="sd">           array of 64-bit uints where the test_idx bit encodes test_idx results.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mask : np.array, dtype=&#39;u4&#39;</span>
<span class="sd">           This is the same mask bit-fiddled if at all, only at the test_idx-th bit.</span>

<span class="sd">        Usage</span>
<span class="sd">        -----</span>
<span class="sd">        # pseudo-code for a given dblock and list of tests</span>
<span class="sd">        mask = np.zeros(shape=(len(dblock),), dtype=&#39;u4&#39;)</span>
<span class="sd">        for i,t in enumerate(tests):</span>
<span class="sd">           result = run_the_test(..., t, ...) # returns boolean len(dblock)</span>
<span class="sd">           mask = _encode_pygarv_stream(i, results, mask) # update the mask, bit i</span>
<span class="sd">        # now pygarv mask is current, this deblock</span>

<span class="sd">        </span>
<span class="sd">        The pygarv mask has the following properties:</span>

<span class="sd">        1. Any non-zero value in the mask indicates some test failed</span>
<span class="sd">           at that sample (quick check)</span>

<span class="sd">        2. From the numerical value of the mask at any given sample,</span>
<span class="sd">           unfiddling the non-zero values in the i-th bit-position</span>
<span class="sd">           recovers the i-th pygarv[&#39;tests&#39;] in the list of tests in</span>
<span class="sd">           this dblock&#39;s header[&#39;pygarv&#39;] info, i.e., points back to</span>
<span class="sd">           all there is to know about why this sample is marked bad</span>
<span class="sd">           ... stream, tag, threshold, other test params, etc..</span>

<span class="sd">        3. The index-to-bit-to-test mapping only holds per dblock</span>
<span class="sd">           since test specs can vary across dblocks.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">test_idx</span> <span class="o">&lt;</span> <span class="mi">64</span>
        <span class="k">assert</span> <span class="n">results</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">results</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">reset_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="c1"># zero the bits at test_idx, then reset w/ new results</span>
            <span class="n">mask</span> <span class="o">-=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">test_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">test_idx</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">**</span> <span class="n">test_idx</span><span class="p">)</span> <span class="o">*</span> <span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_decode_pygarv_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">tr_doc_tests</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;decode the bits set in s and return the failed test specs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : uint64</span>
<span class="sd">           as found in a pygarv_mask</span>

<span class="sd">        tr_doc_tests: list of PyGarv format tests specs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        failed tests : list of pygarv test specs</span>
<span class="sd">           those that tests which failed during run_tests()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># idxs = []</span>
        <span class="n">failed_tests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># scan bits only as far as necessary</span>
        <span class="k">while</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">ii</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">:</span>
            <span class="c1"># check last bit ... same as div mod 2</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># idxs.append(ii)</span>
                <span class="n">failed_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr_doc_tests</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">failed_tests</span>

    <span class="k">def</span> <span class="nf">_decode_pygarv_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pygarv_stream</span><span class="p">,</span> <span class="n">tr_doc</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;recover pygarv test indexes from bits in sample pygarv_stream</span>

<span class="sd">        This function operates per tr_doc, datablock pair</span>

<span class="sd">        The 64-bit uint at each sample of the pygarv data stream encodes</span>
<span class="sd">        which test or tests in the tr_doc[&#39;tests&#39;] failed at that sample.</span>

<span class="sd">        This function decodes such uints, mapping the non-zero bits</span>
<span class="sd">        i,j,k, ...  back to integers i, j, k ... that index the ith,</span>
<span class="sd">        jth, kth, test(s) in tr_doc that failed. Whew.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pygarv_stream : np.ndarray, uint64, shape=(len(dblock), )</span>
<span class="sd">           set bit i indicates failed test i in tr_doc[&#39;tests&#39;]</span>

<span class="sd">        tr_doc : dict</span>
<span class="sd">           in yarf format ...</span>
<span class="sd">            {name: &#39;pygarv&#39;,</span>
<span class="sd">            &#39;dblock_path&#39; : slashpath_to_mkh5_dblock,</span>
<span class="sd">            &#39;tests&#39; : [ test_spec,  ... test-spec ] </span>
<span class="sd">            &#39;fails&#39; : [ [ {}, {}, ] ... [ {}, {}, ] ] ] </span>
<span class="sd">           }   </span>

<span class="sd">        where each test_spec are the (ordered) param specs of a</span>
<span class="sd">        PyGarvTest.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fails: list of list of uints</span>

<span class="sd">          Each list in `fails` is a lookup table of the samples in the</span>
<span class="sd">          datablock where the corresponding test in tr_doc[&#39;tests&#39;]</span>
<span class="sd">          failed. I.e.,</span>
<span class="sd">        </span>
<span class="sd">          * len(fails) == len(tr_doc[&#39;tests&#39;]</span>

<span class="sd">          * fail[i] tracks tr_doc[&#39;tests&#39;][i]</span>

<span class="sd">          * j in fail[i] == True iff test tr_doc[&#39;tests&#39;][i] marks</span>
<span class="sd">            the jth row of the dblock as bad (boolean 1).</span>

<span class="sd">        (pygarv_stream[i] &gt;&gt; i) % 2  == True if i-th bit is set</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># may or may not be tests for this dblock ...</span>
        <span class="k">if</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># this trusts trust the tr_doc is well-formed</span>
        <span class="n">test_fails</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tr_doc</span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]]</span>

        <span class="c1"># &gt; 1 means at least one failed test</span>
        <span class="n">fail_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pygarv_stream</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># decode the non-zero pygarv values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 1. unpack the test_fails</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fail_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fail_idxs</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">pygarv_stream</span><span class="p">[</span><span class="n">fail_idx</span><span class="p">]</span>  <span class="c1"># integer value at the fail</span>
                <span class="c1"># test_idxs = []</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># scan bits only as far as necessary</span>
                <span class="k">while</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">ii</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">:</span>
                    <span class="c1"># shift and check last bit ... same as div mod 2</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># test_idxs.append(ii)</span>
                        <span class="c1"># update failed samples, this test</span>
                        <span class="n">test_fails</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fail_idx</span><span class="p">)</span>
                    <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">compress</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># RLL compress the fail regions as (x0,x1) intervals</span>
                <span class="c1"># two cases of interest:</span>
                <span class="c1">#    length 1 (x0,x0)</span>
                <span class="c1">#    length &gt; 1 (x0, x1) where x0 &lt; x1</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_xs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_fails</span><span class="p">):</span>

                    <span class="c1"># case 1: no points failed this test</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># no fails so no (x0,x1) tuples</span>
                        <span class="n">test_fails</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">continue</span>

                    <span class="c1"># case 2: one or more points failed this test</span>
                    <span class="n">x0_x1</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">n_xs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_xs</span><span class="p">)</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">test_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># init left edge, exists b.c len &gt; 0</span>
                    <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">n_xs</span><span class="p">:</span>
                        <span class="n">x1</span> <span class="o">=</span> <span class="n">test_xs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>  <span class="c1"># update right edge</span>
                        <span class="k">if</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n_xs</span><span class="p">:</span>
                            <span class="c1"># last point is always a right bound, no new region</span>
                            <span class="n">x0_x1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># look ahead ...</span>
                            <span class="k">if</span> <span class="n">test_xs</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">test_xs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># append and start a new retion</span>
                                <span class="n">x0_x1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>
                                <span class="n">x0</span> <span class="o">=</span> <span class="n">test_xs</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># overwrite this test sample fails w/ the intervals</span>
                    <span class="n">test_fails</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0_x1</span>
        <span class="k">return</span> <span class="n">test_fails</span>  <span class="c1"># possibly [ [] ... [] ] if len == 0</span></div>

    <span class="c1"># def _ppa(test,dblock,srate):</span>
    <span class="c1">#     &quot;&quot;&quot; ppa test handler &quot;&quot;&quot;</span>

    <span class="c1">#     # data type template for this test</span>
    <span class="c1">#     dtypes = {</span>
    <span class="c1">#         &#39;test&#39;: str,</span>
    <span class="c1">#         &#39;tag&#39;: str,</span>
    <span class="c1">#         &#39;stream&#39;: str,</span>
    <span class="c1">#         &#39;params&#39;: dict(</span>
    <span class="c1">#             threshold = float,  # uV max excursion</span>
    <span class="c1">#             interval = float    # ms</span>
    <span class="c1">#         )</span>
    <span class="c1">#     }</span>

    <span class="c1">#     # general sanity check</span>
    <span class="c1">#     _check_test(test, dtypes, dblock)</span>
    <span class="c1">#     test_stream = dblock[test[&#39;stream&#39;]]</span>
    <span class="c1">#     result_stream = np.ndarray(shape=(len(test_stream)), dtype=bool)</span>
    <span class="c1">#     result_stream.fill(False)</span>
    <span class="c1">#     n = int((test[&#39;params&#39;][&#39;interval&#39;]*srate)/1000.0) #</span>
    <span class="c1">#     threshold = test[&#39;params&#39;][&#39;threshold&#39;]</span>

    <span class="c1">#     # test snippets</span>
    <span class="c1">#     idx = 0</span>
    <span class="c1">#     while idx &lt; len(test_stream)-n:</span>
    <span class="c1">#         test_run = test_stream[idx:idx+n]</span>
    <span class="c1">#         idx_result = (test_stream[idx:idx+n].max() -</span>
    <span class="c1">#                       test_stream[idx:idx+n].min()) &gt; threshold</span>
    <span class="c1">#         if idx_result:</span>
    <span class="c1">#             result_stream[idx:idx+n] = idx_result</span>
    <span class="c1">#             # idx += n # skip rest of bads</span>
    <span class="c1">#             # continue</span>
    <span class="c1">#         idx += 1</span>
    <span class="c1">#     return(result_stream)</span>

    <span class="c1"># def _ppadif(test,dblock,srate):</span>
    <span class="c1">#     &quot;&quot;&quot; ppadif test handler &quot;&quot;&quot;</span>

    <span class="c1">#     # data type template for this test</span>
    <span class="c1">#     dtypes = {</span>
    <span class="c1">#         &#39;test&#39;: str,</span>
    <span class="c1">#         &#39;tag&#39;: str,</span>
    <span class="c1">#         &#39;stream&#39;: str,</span>
    <span class="c1">#         &#39;params&#39;: dict(</span>
    <span class="c1">#             stream_2 = str, # other data stream name</span>
    <span class="c1">#             threshold = float,  # uV max excursion</span>
    <span class="c1">#             interval = float # ms</span>
    <span class="c1">#         )</span>
    <span class="c1">#     }</span>

    <span class="c1">#     # general sanity check</span>
    <span class="c1">#     _check_test(test, dtypes, dblock)</span>
    <span class="c1">#     test_stream = dblock[test[&#39;stream&#39;]] - \</span>
    <span class="c1">#                   dblock[test[&#39;params&#39;][&#39;stream_2&#39;]]</span>
    <span class="c1">#     result_stream = np.ndarray(shape=(len(test_stream)), dtype=bool)</span>
    <span class="c1">#     result_stream.fill(False)</span>
    <span class="c1">#     n = int((test[&#39;params&#39;][&#39;interval&#39;]*srate)/1000.0) #</span>
    <span class="c1">#     threshold = test[&#39;params&#39;][&#39;threshold&#39;]</span>

    <span class="c1">#     # test snippets</span>
    <span class="c1">#     idx = 0</span>
    <span class="c1">#     while idx &lt; len(test_stream)-n:</span>
    <span class="c1">#         idx_result = (test_stream[idx:idx+n].max() -</span>
    <span class="c1">#                       test_stream[idx:idx+n].min()) &gt; threshold</span>
    <span class="c1">#         if idx_result:</span>
    <span class="c1">#             result_stream[idx:idx+n] = idx_result</span>
    <span class="c1">#             # idx += n # skip rest of bads</span>
    <span class="c1">#             # continue</span>
    <span class="c1">#             idx += 1</span>
    <span class="c1">#     return(result_stream)</span>

    <span class="c1"># def _garv_dblock(hdr, dblock):</span>
    <span class="c1">#     &quot;&quot;&quot; run tests given in hdr[&#39;pygarv&#39;][&#39;tests&#39;] on dblock data streams</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     hdr : dict in proper mkh5 dblock header format</span>
    <span class="c1">#     dblock : np.ndarray in proper mkh5 dblock format</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     pygarv_stream : np.ndarray, shape = (1,len(dblock)), dtype=np.uint64</span>
    <span class="c1">#     non-zero values indicate artifacts, bit-code (2**i) indicates ith test failed</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     if &#39;pygarv&#39; not in hdr.keys():</span>
    <span class="c1">#         raise KeyError(&#39;pygarv not found ... add to YAML .yhdr&#39;)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         pg = hdr[&#39;pygarv&#39;]</span>

    <span class="c1">#     if &#39;tests&#39; not in pg.keys():</span>
    <span class="c1">#         raise KeyError(&#39;tests not found in pygarv dict ... check .yhdr YAML doc name: pygarv&#39;)</span>

    <span class="c1">#     if not isinstance(pg[&#39;tests&#39;], list):</span>
    <span class="c1">#         msg = &quot;pygarv[&#39;tests&#39;] is not a list ... check YAML .yhdr YAML doc name: pygarv&quot;</span>
    <span class="c1">#         raise TypeError(msg)</span>

    <span class="c1">#     # check there is a pygarv method for each named test in the doc</span>
    <span class="c1">#     for i,test in enumerate(pg[&#39;tests&#39;]):</span>
    <span class="c1">#         if &#39;_&#39; + test[&#39;test&#39;] not in pygarv.__dict__.keys():</span>
    <span class="c1">#             msg = (&quot;unknown test name at pygarv[&#39;tests&#39;][{0}]: &quot;</span>
    <span class="c1">#                    &quot;{1}&quot;).format(i, test)</span>
    <span class="c1">#             raise ValueError(msg)</span>

    <span class="c1">#     # check there is enough bit-width to code the number of tests</span>
    <span class="c1">#     # pygarv_dt = np.dtype([(&#39;pygarv&#39;, &#39;uint64&#39;)])</span>
    <span class="c1">#     pygarv_dt = np.dtype(&#39;uint64&#39;)</span>
    <span class="c1">#     n_bits = np.uint(pygarv_dt.itemsize * 8)</span>
    <span class="c1">#     if len(pg[&#39;tests&#39;]) &gt; n_bits:</span>
    <span class="c1">#         msg = (&#39;number of pygarv tests {0} &#39;</span>
    <span class="c1">#                &#39;exceeds maximum {1}&#39;).format(len(pg[&#39;tests&#39;],n_bits))</span>
    <span class="c1">#         raise ValueError(msg)</span>

    <span class="c1">#     # setup to capture results</span>
    <span class="c1">#     # n_bytes = int(np.ceil(len(pg[&#39;tests&#39;])/8))</span>
    <span class="c1">#     pygarv_stream = np.zeros(shape=(len(dblock),), dtype=pygarv_dt)</span>

    <span class="c1">#     # have at it</span>
    <span class="c1">#     srate = hdr[&#39;samplerate&#39;]</span>
    <span class="c1">#     for i,test in enumerate(pg[&#39;tests&#39;]):</span>
    <span class="c1">#         print(&#39;{0} {1} {2}&#39;.format(test[&#39;test&#39;],</span>
    <span class="c1">#                                    test[&#39;stream&#39;],</span>
    <span class="c1">#                                    test[&#39;tag&#39;]))</span>
    <span class="c1">#         func_call = &#39;_{0}(test,dblock,srate)&#39;.format(test[&#39;test&#39;])</span>
    <span class="c1">#         # test_results.append( (test, eval(func_call)) )</span>
    <span class="c1">#     pygarv_stream  = _encode_pygarv_stream(i,</span>
    <span class="c1">#                                            eval(func_call),</span>
    <span class="c1">#                                            pygarv_stream)</span>
    <span class="c1">#     return(pygarv_stream)</span>


<span class="c1"># def _mxflat(test, dblock, srate):</span>
<span class="c1">#     &quot;&quot;&quot; max flat test handler &quot;&quot;&quot;</span>
<span class="c1">#     # data type template for this test</span>
<span class="c1">#     dtypes = {</span>
<span class="c1">#         &#39;test&#39;: str,</span>
<span class="c1">#         &#39;tag&#39;: str,</span>
<span class="c1">#         &#39;stream&#39;: str,</span>
<span class="c1">#         &#39;params&#39;: dict(</span>
<span class="c1">#             threshold = float,  # uV</span>
<span class="c1">#             interval = float )}</span>

<span class="c1">#     # general sanity check</span>
<span class="c1">#     _check_test(test, dtypes, dblock)</span>

<span class="c1">#     test_stream = dblock[test[&#39;stream&#39;]]</span>
<span class="c1">#     result_stream = np.ndarray(shape=(len(test_stream)), dtype=bool)</span>
<span class="c1">#     result_stream.fill(False)</span>

<span class="c1">#     # apply test across stream in rolling window</span>
<span class="c1">#     threshold = test[&#39;params&#39;][&#39;threshold&#39;]</span>
<span class="c1">#     n = int((test[&#39;params&#39;][&#39;interval&#39;]*srate)/1000.0) #</span>
<span class="c1">#     idx = 0</span>
<span class="c1">#     while idx &lt; len(test_stream) - n:</span>
<span class="c1">#         idx_result = (test_stream[idx:idx+n].max() -</span>
<span class="c1">#                       test_stream[idx:idx+n].min()) &lt; threshold</span>
<span class="c1">#         if idx_result:</span>
<span class="c1">#             # mark the flat interval</span>
<span class="c1">#             result_stream[idx:idx+n] = idx_result</span>
<span class="c1">#             # idx += n  # can&#39;t undo bad so fast forward</span>
<span class="c1">#             # continue</span>
<span class="c1">#             idx += 1</span>
<span class="c1">#             return(result_stream)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">argparse</span>  <span class="c1"># successor to optparse</span>

    <span class="c1"># set up parser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;mkh5 artifact tagger&quot;</span><span class="p">)</span>

    <span class="c1"># names</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;mkh5_f&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;mkh5 format data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--yarf&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;myfile.yarf&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;yarf_f&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;.yarf format YAML artifact test file&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args_dict</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>  <span class="c1"># fetch from sys.argv</span>
    <span class="c1"># TO DO ... implement --tests option to dump available tests?</span>

    <span class="k">if</span> <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;yarf_f&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># bare init w/ mkh5 for viewing</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pygarv viewer ...&quot;</span><span class="p">)</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">PyGarv</span><span class="p">(</span><span class="n">mkh5_f</span><span class="o">=</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;mkh5_f&quot;</span><span class="p">])</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">_update_tr_docs_from_mkh5</span><span class="p">()</span>
        <span class="n">mkh5viewer</span><span class="o">.</span><span class="n">launch_app</span><span class="p">(</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;mkh5_f&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># run pygarv to mod the file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pygarv marking artifacts ...&quot;</span><span class="p">)</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">PyGarv</span><span class="p">(</span><span class="n">mkh5_f</span><span class="o">=</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;mkh5_f&quot;</span><span class="p">])</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">_update_tr_docs_from_yaml_f</span><span class="p">(</span><span class="n">yarf_f</span><span class="o">=</span><span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;yarf_f&quot;</span><span class="p">])</span>  <span class="c1"># load yarf tests</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">_update_mkh5</span><span class="p">()</span>  <span class="c1"># actually mod the h5 file</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020 Thomas P. Urbach, Andrey Portnoy, 2013 Nathaniel Smith

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>