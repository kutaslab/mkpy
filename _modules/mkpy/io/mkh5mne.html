

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mkpy.io.mkh5mne &mdash; mkpy 0.2.5.dev5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> mkpy
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction (0.2.5.dev5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation (64-bit linux only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Quick%20Start.html">Quick start with <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../AS_howto.html">A. Stoermannâ€™s online how-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CheatSheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../UserGuide.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ExamplesGallery.html">Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Learning.html">Background reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ReleaseNotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../RolesCredits.html">Roles and credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mkpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mkpy.html">mkpy</a> &raquo;</li>
        
      <li>mkpy.io.mkh5mne</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mkpy.io.mkh5mne</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;import mkpy5 HDF5 data files to MNE Raw and Epochs, savable as .fif files&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">mkpy.mkh5</span> <span class="k">as</span> <span class="nn">mkh5</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">dpath</span>  <span class="c1"># local fork</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">mkpy_version</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne.io.constants</span> <span class="kn">import</span> <span class="n">FIFF</span>
<span class="kn">from</span> <span class="nn">mne.utils.numerics</span> <span class="kn">import</span> <span class="n">object_hash</span>  <span class="c1"># for comparing MNE objects</span>


<span class="c1"># TODO simple logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;mneio_mkh5&quot;</span><span class="p">)</span>  <span class="c1"># all for one, one for all</span>
<span class="n">logger</span><span class="o">.</span><span class="n">propoagate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># in case of multiple imports</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="n">mkpy_version</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># globals</span>

<span class="c1"># info = INFO</span>
<span class="c1"># quiet = WARN</span>
<span class="c1"># all = DEBUG</span>
<span class="n">VERBOSE_LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">]</span>

<span class="n">MNE_STREAM_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span> <span class="s2">&quot;eog&quot;</span><span class="p">,</span> <span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;misc&quot;</span><span class="p">]</span>
<span class="n">MNE_MIN_VER</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># major, minor</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># mkh5 specific</span>

<span class="c1"># requires header info introduced in mkh5 0.2.4</span>
<span class="n">MKH5_MIN_VER</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># major, minor, patch</span>

<span class="n">KWARGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dblock_paths&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional, selects listed dblock_paths</span>
    <span class="s2">&quot;garv_interval&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;fail_on_info&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;fail_on_montage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;ignore_keys&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># optional</span>
<span class="p">}</span>

<span class="c1"># these info keys can vary by mkh5 dblock, exclude from identity tests</span>
<span class="n">IGNORE_INFO_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_id&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_name&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_info&quot;</span><span class="p">]</span>


<span class="c1"># EPOCHS_KWARGS = {</span>
<span class="c1">#     &quot;epochs_name&quot;: None,  # mandatory</span>
<span class="c1">#     &quot;epoch_id&quot;: &quot;epoch_id&quot;,  # mkpy.mkh5 &gt; 0.2.3 default</span>
<span class="c1">#     &quot;time&quot;: &quot;match_time&quot;,  # mkpy.mkh5 &gt; 0.2.3 default</span>
<span class="c1"># }</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># base class for informative YAML header format errors</span>
<span class="k">class</span> <span class="nc">Mkh5HeaderError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;used when mkh5 header is not compatible with building MNE data structures</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message: str</span>
<span class="sd">      printed message</span>

<span class="sd">    dblock_path: str</span>
<span class="sd">      mkh5 dblock_path the header came from</span>

<span class="sd">    bad: dict, optional</span>
<span class="sd">       if present is dumped as a YAML str to show the (sub) dictionary</span>
<span class="sd">       that threw the exception.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">dblock_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dbp_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">dblock_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;in data block: </span><span class="si">{</span><span class="n">dblock_path</span><span class="si">}</span><span class="s2"> header, &quot;</span>
        <span class="p">)</span>
        <span class="n">bad_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">bad</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbp_str</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, check the .yhdr YAML</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">bad_str</span><span class="p">,)</span>


<div class="viewcode-block" id="Mkh5HeaderKeyError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5HeaderKeyError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing a key required for MNE import&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Mkh5HeaderValueError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5HeaderValueError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;value is the wrong type for MNE import&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Mkh5HeaderTypeError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5HeaderTypeError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5HeaderTypeError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;illegal value for MNE import&quot;&quot;&quot;</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># miscellaneous exceptions</span>
<div class="viewcode-block" id="Mkh5FileAccessError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5FileAccessError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5FileAccessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Mkh5InfoUpdateError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5InfoUpdateError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5InfoUpdateError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;report failed info update attempts&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mne_info_key</span><span class="p">,</span> <span class="n">bad_value</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;failed to set mne info[</span><span class="si">{mne_info_key}</span><span class="s2">] = </span><span class="si">{bad_value}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Mkh5DblockPathError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5DblockPathError">[docs]</a><span class="k">class</span> <span class="nc">Mkh5DblockPathError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent datablock</span>

<span class="sd">    h5py also throws an error but the message is generic</span>
<span class="sd">    &quot;object not found&quot; without specifying what object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dbp</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fail_msg</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># mkh5 epochs  table errors</span>
<div class="viewcode-block" id="EpochsMkh5EpochsNameError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.EpochsMkh5EpochsNameError">[docs]</a><span class="k">class</span> <span class="nc">EpochsMkh5EpochsNameError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent epochs table&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> cannot locate epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;check mkh5.get_epoch_table_names()&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<div class="viewcode-block" id="EpochsMkh5ExcludedDataBlockError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.EpochsMkh5ExcludedDataBlockError">[docs]</a><span class="k">class</span> <span class="nc">EpochsMkh5ExcludedDataBlockError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent epochs table&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">missing_dblocks</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> requires data the following &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> dblock_paths, include them them to list of selected&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dblock_paths=[...] or set dblock_paths=None to select all: &quot;</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;[&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dbp</span> <span class="k">for</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="n">missing_dblocks</span><span class="p">])</span>
            <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<div class="viewcode-block" id="EpochsMkh5ColumnNameError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.EpochsMkh5ColumnNameError">[docs]</a><span class="k">class</span> <span class="nc">EpochsMkh5ColumnNameError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;non-existent epochs_id or time column in the epochs table&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> column error </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, check </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">.columns&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<div class="viewcode-block" id="EpochsMkh5NonZeroTimestamps"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.EpochsMkh5NonZeroTimestamps">[docs]</a><span class="k">class</span> <span class="nc">EpochsMkh5NonZeroTimestamps</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised if values in the the specified mkh5 timestamp column vary or differ from the timelock=value&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> time column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> has non-zero timestamps. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;MNE epochs, (tmin, tmax) are defined relative to the timelock event at time=0.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Inspect the epochs table in </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> with mkh5.mkh5.get_epochs_table(</span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to locate the discrepant timestamps. If the mkh5 event table is overgenerating &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;match_time events with non-zero time-stamps, prune the rows with non-zero timesamps &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, and set the epochs with the new event table mkh5.mkh5.set_epochs(event_table).&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Apparatus YAML file</span>


<div class="viewcode-block" id="ApparatusYamlFileError"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.ApparatusYamlFileError">[docs]</a><span class="k">class</span> <span class="nc">ApparatusYamlFileError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;yaml file didn&#39;t open for any reason&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> check file name, path, and permissions&quot;</span><span class="p">,)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># MNE structure exceptions</span>
<div class="viewcode-block" id="Mkh5DblockInfoMismatch"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5DblockInfoMismatch">[docs]</a><span class="k">class</span> <span class="nc">Mkh5DblockInfoMismatch</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised if MNE info structures differ, e.g., across mkh5 dblocks&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_1</span><span class="p">,</span> <span class="n">msg_2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_1</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg_2</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Mkh5DblockMontageMismatch"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.Mkh5DblockMontageMismatch">[docs]</a><span class="k">class</span> <span class="nc">Mkh5DblockMontageMismatch</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised if MNE montage structures differ, e.g., across mkh5 dblocks&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_1</span><span class="p">,</span> <span class="n">msg_2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_1</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg_2</span><span class="p">,)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># private-ish helpers</span>
<span class="k">def</span> <span class="nf">_check_package_versions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; guard the MNE and mkh5 version for compatible header -&gt; info, montage&quot;&quot;&quot;</span>

    <span class="n">ver_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;M&gt;\d+)\.(?P&lt;N&gt;\d+)\.(?P&lt;P&gt;){0,1}.*$&quot;</span><span class="p">)</span>

    <span class="n">mne_ver</span> <span class="o">=</span> <span class="n">ver_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">mne</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mne_ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">mne_ver</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MNE_MIN_VER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mne_ver</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MNE_MIN_VER</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE </span><span class="si">{</span><span class="n">mne</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> must be &gt;= </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MNE_MIN_VER</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">mkh5_ver</span> <span class="o">=</span> <span class="n">ver_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">mkh5</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mkh5_ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;mkpy.mkh5 version </span><span class="si">{</span><span class="n">mkh5</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> must be &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&gt;= </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MKH5_MIN_VER</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_api_params</span><span class="p">(</span><span class="n">_class</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;screen mkh5_f, dblock paths and epoch names prior to processing</span>

<span class="sd">    _obj_clas == Raw, Epochs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _class : RawMkh5</span>

<span class="sd">    mkh5_f : str</span>
<span class="sd">        path to mkh5 file</span>

<span class="sd">    **kwargs</span>
<span class="sd">        see module KEYWARGS</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># mne and mkh5</span>
    <span class="n">_check_package_versions</span><span class="p">()</span>

    <span class="c1"># API feeds parameters to the classes, user actions cannot</span>
    <span class="c1"># make the assertions fail</span>
    <span class="c1"># assert _class in [RawMkh5, EpochsMkh5], \</span>
    <span class="k">assert</span> <span class="n">_class</span> <span class="ow">is</span> <span class="n">RawMkh5</span><span class="p">,</span> <span class="s2">&quot;_check_api_params _class must be RawMkh5&quot;</span>

    <span class="c1"># set the module kwargs for the input class RawMkh5 or EpochsMkh5</span>
    <span class="n">module_kwargs</span> <span class="o">=</span> <span class="n">KWARGS</span>
    <span class="c1"># if _class == EpochsMkh5:</span>
    <span class="c1">#     module_kwargs.update(**EPOCHS_KWARGS)</span>

    <span class="c1"># screen input for illegal keys</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown keyword &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># fill in missing keyword params, if any, with module defaults</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">module_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># now have a full set of module kwargs with input values or defaults</span>

    <span class="c1"># arg: mkh5 file check</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cannot open </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> check file name, path, and permissions&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5FileAccessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># verbose</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VERBOSE_LEVELS</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;verbose=</span><span class="si">{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> level must be: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">VERBOSE_LEVELS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># e.g., dblock_paths=[&quot;group/dblock_0&quot;, &quot;group/dblock_1&quot;, ...]  or all</span>
    <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;set dblock_paths=[...], else very slow&quot;</span>
    <span class="n">dblock_paths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">dblock_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dbp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="n">dblock_paths</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;dblock_paths=</span><span class="si">{</span><span class="n">dblock_paths</span><span class="si">}</span><span class="s2"> must be a list of strings&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># e.g., garv_interval=[-500, 1500, &quot;ms&quot;]</span>
    <span class="n">garv_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;garv_interval&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">garv_interval</span><span class="p">:</span>
        <span class="n">garv_start</span><span class="p">,</span> <span class="n">garv_stop</span><span class="p">,</span> <span class="n">garv_unit</span> <span class="o">=</span> <span class="n">garv_interval</span>
        <span class="k">if</span> <span class="n">garv_unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;garv_unit=</span><span class="si">{</span><span class="n">garv_unit</span><span class="si">}</span><span class="s2"> must be &#39;ms&#39; or &#39;s&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">t_scale</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="k">if</span> <span class="n">garv_unit</span> <span class="o">==</span> <span class="s2">&quot;ms&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="c1"># let python raise TypeError for non-numerical values</span>
        <span class="n">garv_start</span> <span class="o">/=</span> <span class="n">t_scale</span>
        <span class="n">garv_stop</span> <span class="o">/=</span> <span class="n">t_scale</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">garv_start</span> <span class="o">&lt;</span> <span class="n">garv_stop</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;garv_start=</span><span class="si">{</span><span class="n">garv_start</span><span class="si">}</span><span class="s2"> must be &lt; garv_stop=</span><span class="si">{</span><span class="n">garv_stop</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># info and montage toggles</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fail_on_info&quot;</span><span class="p">,</span> <span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2"> must be True or False&quot;</span><span class="p">)</span>

        <span class="c1"># turning off montage checking for epochs is risky</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;setting fail_on_montage=False disables MNE montage &quot;</span>
                <span class="s2">&quot;verification accross mkh5 data blocks, the MNE sensor &quot;</span>
                <span class="s2">&quot;locations may be wrong and MNE epoch conversion may fail&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># optional apparatus yaml</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">apparatus_yaml</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">apparatus_yaml</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ApparatusYamlFileError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignore_keys&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>
        <span class="n">ignore_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignore_keys&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ignore_keys must be a list of strings, not </span><span class="si">{</span><span class="n">ignore_keys</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">fail</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># # DEPRECATE? EpochsMkh5 kwargs</span>
    <span class="c1"># if _class == EpochsMkh5:</span>

    <span class="c1">#     epochs_name = kwargs[&quot;epochs_name&quot;]</span>

    <span class="c1">#     # catches non-strings including epochs_name=None</span>
    <span class="c1">#     if not isinstance(epochs_name, str):</span>
    <span class="c1">#         msg = f&quot;epochs_name={epochs_name} must be a character string&quot;</span>
    <span class="c1">#         raise TypeError(msg)</span>

    <span class="c1">#     # check the epochs table h5 object exists</span>
    <span class="c1">#     if epochs_name not in h5.epochs_names:</span>
    <span class="c1">#         raise EpochsMkh5EpochsNameError(mkh5_f, epochs_name)</span>

    <span class="c1">#     # ok to set column names here</span>
    <span class="c1">#     epochs_table = h5.get_epochs_table(epochs_name)</span>

    <span class="c1">#     # shouldn&#39;t fail unless the the mkh5 file is tampered with</span>
    <span class="c1">#     assert all([dbp in all_dblock_paths for dbp in epochs_table.dblock_path])</span>

    <span class="c1">#     # check epochs_id, time cols exist</span>
    <span class="c1">#     for test_param in [&quot;epoch_id&quot;, &quot;time&quot;]:</span>
    <span class="c1">#         col_name = kwargs[test_param]</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             epochs_table[col_name]</span>
    <span class="c1">#         except Exception:</span>
    <span class="c1">#             raise EpochsMkh5ColumnNameError(mkh5_f, epochs_name, col_name)</span>

    <span class="c1">#     # this value is critical for correctly cacluating the</span>
    <span class="c1">#     # MNE fixed-interval epoch with tmin, tmax</span>
    <span class="c1">#     if not all(epochs_table[kwargs[&quot;time&quot;]] == 0):</span>
    <span class="c1">#         raise EpochsMkh5NonZeroTimestamps(mkh5, epochs_name)</span>

    <span class="c1"># full set of checked kwargs for _class RawMkh5 or EpochsMkh5</span>
    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_is_equal_mne_info</span><span class="p">(</span><span class="n">info_a</span><span class="p">,</span> <span class="n">info_b</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;compare two mne.Info key, value instances for same content</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    info_a, info_b : mne.Info</span>
<span class="sd">       as instantiated, e.g., by mne.create_info(...)</span>

<span class="sd">    exclude : list of str, optional</span>
<span class="sd">       list of mne.Info.keys() to skip when testing, e.g. &quot;meas_id&quot;,</span>
<span class="sd">       &quot;file_id&quot; which change file_id timestamps with .fif saves.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool:</span>
<span class="sd">       True if info structure contets are the same to within</span>
<span class="sd">       floating-point precision, False otherwise.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    verbose=True reports the key, values that differ.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">test_keys_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_a</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">test_keys_b</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_b</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_keys_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_keys_b</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;info_a and info_b have different keys&quot;</span><span class="p">)</span>

    <span class="c1"># collect bad keys for verbose reporting</span>
    <span class="n">good_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># whitelist the values that test the same</span>
    <span class="n">bad_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># blacklist mismatches</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">test_keys_a</span><span class="p">:</span>
        <span class="n">val_a</span> <span class="o">=</span> <span class="n">info_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">val_b</span> <span class="o">=</span> <span class="n">info_b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># most info values hash test fine</span>
        <span class="k">if</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_a</span><span class="p">)</span> <span class="o">==</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_b</span><span class="p">):</span>
            <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># dig and chan need special handling</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;dig&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val_a</span> <span class="o">==</span> <span class="n">val_b</span>
                <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]:</span>
            <span class="c1"># assert all vals are equal or close,</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chdx</span><span class="p">,</span> <span class="n">ch_a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_a</span><span class="p">):</span>
                    <span class="n">ch_b</span> <span class="o">=</span> <span class="n">val_b</span><span class="p">[</span><span class="n">chdx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key_aa</span><span class="p">,</span> <span class="n">val_aa</span> <span class="ow">in</span> <span class="n">ch_a</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">val_bb</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">[</span><span class="n">key_aa</span><span class="p">]</span>
                        <span class="c1">#  np.allclose b.c. .fif save float precision may</span>
                        <span class="c1"># tinker with info[&quot;chs&quot;][i][&quot;loc&quot;] values</span>
                        <span class="k">assert</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_bb</span><span class="p">)</span> <span class="o">==</span> <span class="n">object_hash</span><span class="p">(</span>
                            <span class="n">val_aa</span>
                        <span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val_aa</span><span class="p">,</span> <span class="n">val_bb</span><span class="p">)</span>
                <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># print(f&quot;good_keys {good_keys} excluded {exclude}&quot;)</span>
    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">good_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_keys_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_keys_b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bad_keys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;info_a[&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;]: </span><span class="si">{</span><span class="n">info_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;info_b[&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;]: </span><span class="si">{</span><span class="n">info_b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_is_equal_mne_montage</span><span class="p">(</span><span class="n">montage_a</span><span class="p">,</span> <span class="n">montage_b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compare two mne montages for identity&quot;&quot;&quot;</span>

    <span class="c1"># fall through for msgs when verbose=True</span>
    <span class="n">attrs_a</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">montage_a</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">attrs_b</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">montage_b</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs_a</span> <span class="o">==</span> <span class="n">attrs_b</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;montage attributes differ: </span><span class="si">{</span><span class="n">attrs_a</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">attrs_b</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># report the mismatches</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_a</span><span class="p">:</span>
        <span class="n">val_a</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">montage_a</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">val_b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">montage_b</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_a</span> <span class="o">!=</span> <span class="n">val_b</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mismatch </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">val_a</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">val_b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_check_info_montage_across_dblocks</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check hdr, dblocks in mkh5_f return the same MNE info and montage</span>

<span class="sd">    The default behavior for info mismatches is to issue a warning</span>
<span class="sd">    since discrepant structures arise whenever multiple crws are</span>
<span class="sd">    combined in a single mkh5 file, e.g., for separate cal files, split</span>
<span class="sd">    sessions, and multi-subject experiment files.</span>

<span class="sd">    The default behavior for montage mismatches is to fail since there</span>
<span class="sd">    are very few cases in which it is reasonable to pool data data</span>
<span class="sd">    recorded from different montages in a single analysis. Montages</span>
<span class="sd">    that very across datablocks in an mkh5 file are most likely</span>
<span class="sd">    attributable to using discrepant .yhdr apparatus maps when the</span>
<span class="sd">    mkh5 file was converted from .crw/.log. In this case the remedy is</span>
<span class="sd">    to correct the .yhdr files and rebuild the mkh5 file.  Montage</span>
<span class="sd">    differences make MNE spatial visualization and data analysis</span>
<span class="sd">    unreliable and montage failures should be allowed with extreme</span>
<span class="sd">    caution in unusual circumstances.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_f: str</span>
<span class="sd">        file path to mkpy.mkh5 file</span>
<span class="sd">    ignore_keys : list of str {[]}</span>
<span class="sd">        differences between the values of these info keys are ignored even</span>
<span class="sd">        when fail_on_info=True, see IGNORE_INFO_KEYS.</span>
<span class="sd">    dblock_paths: {list of str, None}, optional</span>
<span class="sd">        as returned by mkh5.mkh5(mkh5_f).dblock_paths</span>
<span class="sd">        do not check the keys in the list, the default values</span>
<span class="sd">        typically vary across mkh5 dblocks</span>
<span class="sd">    apparatus_yaml: str</span>
<span class="sd">        file path to a YAML file containing exactly one mkpy.mkh5</span>
<span class="sd">        apparatus format YAML doc, such as a .yhdr</span>
<span class="sd">    fail_on_info: bool {False}, optional</span>
<span class="sd">        whether to fail on mismatching MNE info structures,</span>
<span class="sd">        default=False</span>
<span class="sd">    fail_on_montage: bool {True}, optional</span>
<span class="sd">        whether to fail on mismatching MNE montage structures,</span>
<span class="sd">        default=True</span>
<span class="sd">    verbose: str {&quot;info&quot;, &quot;critical&quot;, &quot;error&quot;, &quot;warning&quot;, &quot;debug&quot;, &quot;notset&quot;}</span>
<span class="sd">        level of python logging reporting</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># clunky but clear ...</span>
    <span class="n">dblock_paths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span>
    <span class="n">apparatus_yaml</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span>
    <span class="n">fail_on_info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_info&quot;</span><span class="p">]</span>
    <span class="n">fail_on_montage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fail_on_info</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>  <span class="c1"># fail informatively</span>

    <span class="n">h5</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>

    <span class="c1"># enforce explicit dblock_paths kwarg</span>
    <span class="k">assert</span> <span class="n">dblock_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;set dblock_paths kwarg, else too slow&quot;</span>

    <span class="c1"># check pairwise against first</span>
    <span class="n">dbp_i</span> <span class="o">=</span> <span class="n">dblock_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hdr_i</span><span class="p">,</span> <span class="n">dblock_i</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp_i</span><span class="p">)</span>
    <span class="n">info_i</span><span class="p">,</span> <span class="n">montage_i</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span>
        <span class="n">hdr_i</span><span class="p">,</span> <span class="n">dblock_i</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">dbp_j</span> <span class="ow">in</span> <span class="n">dblock_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking info, montage </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">hdr_j</span><span class="p">,</span> <span class="n">dblock_j</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp_j</span><span class="p">)</span>
        <span class="n">info_j</span><span class="p">,</span> <span class="n">montage_j</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span>
            <span class="n">hdr_j</span><span class="p">,</span> <span class="n">dblock_j</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span>
        <span class="p">)</span>
        <span class="c1"># info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_equal_mne_info</span><span class="p">(</span><span class="n">info_i</span><span class="p">,</span> <span class="n">info_j</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fail_on_info</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Mkh5DblockInfoMismatch</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info_i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_j</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE info differs: </span><span class="si">{</span><span class="n">dbp_i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">info_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">info_j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># montage</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_equal_mne_montage</span><span class="p">(</span><span class="n">montage_i</span><span class="p">,</span> <span class="n">montage_j</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fail_on_montage</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Mkh5DblockMontageMismatch</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">montage_j</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE montages differ: </span><span class="si">{</span><span class="n">dbp_i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="RawMkh5"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.RawMkh5">[docs]</a><span class="k">class</span> <span class="nc">RawMkh5</span><span class="p">(</span><span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BaseRaw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raw MNE compatible object from mkpy.mkh5 HDF5 data file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_f : str</span>
<span class="sd">        file path to existing mkpy.mkh5 data file 0.2.4+</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    We maintain dblock -&gt; RawArray and let MNE handle the</span>
<span class="sd">    bookeeping for knitting RawArrays together. Not future</span>
<span class="sd">    proof but perhaps more future resistant.</span>

<span class="sd">&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mkh5_f</span><span class="p">,</span>
        <span class="n">garv_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dblock_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fail_on_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fail_on_montage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="o">=</span><span class="n">IGNORE_INFO_KEYS</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">dblock_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking up data block paths, larger files take longer ...&quot;</span><span class="p">)</span>
            <span class="n">dblock_paths</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">dblock_paths</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

        <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">_check_api_params</span><span class="p">(</span>
            <span class="n">RawMkh5</span><span class="p">,</span>
            <span class="n">mkh5_f</span><span class="p">,</span>
            <span class="n">dblock_paths</span><span class="o">=</span><span class="n">dblock_paths</span><span class="p">,</span>
            <span class="n">garv_interval</span><span class="o">=</span><span class="n">garv_interval</span><span class="p">,</span>
            <span class="n">fail_on_info</span><span class="o">=</span><span class="n">fail_on_info</span><span class="p">,</span>
            <span class="n">fail_on_montage</span><span class="o">=</span><span class="n">fail_on_montage</span><span class="p">,</span>
            <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">ignore_keys</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_check_info_montage_across_dblocks</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="n">raw_dblocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mne_ditis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">raw_samp_n</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># track accumulated samples across data blocks</span>
        <span class="k">for</span> <span class="n">dbpi</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dblock_paths</span><span class="p">):</span>

            <span class="c1"># raw_dblock is an instance of mne.Raw, db_epts is a dic with keys in</span>
            <span class="c1"># epoch_names and vals = the mkh5 epochs table dataframe row sliced</span>
            <span class="c1"># for this data block path.</span>
            <span class="n">raw_dblock</span><span class="p">,</span> <span class="n">db_epts</span> <span class="o">=</span> <span class="n">_dblock_to_raw</span><span class="p">(</span>
                <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dbp</span><span class="p">,</span> <span class="n">garv_interval</span><span class="p">,</span> <span class="n">apparatus_yaml</span>
            <span class="p">)</span>
            <span class="c1"># the data</span>
            <span class="n">raw_dblocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)</span>

            <span class="c1"># reassemble mkh5 epochs_tables</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">db_epts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">diti</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># pd.DataFrame.copy()</span>

                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">diti</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dbp</span><span class="p">)</span>
                <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;mne_dblock_path_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbpi</span>

                <span class="c1"># compute sample index into the mne.Raw data stream from the</span>
                <span class="c1"># the length thus far + dblock_tick offset (0-base)</span>
                <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;mne_raw_ticks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_samp_n</span> <span class="o">+</span> <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mne_ditis</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># start a new table w/ mne raw ticks counting from 0</span>
                    <span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">diti</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># continue an existing table</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">diti</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diti</span><span class="p">)</span>
            <span class="n">raw_samp_n</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)</span>

        <span class="c1"># assemble</span>
        <span class="n">mne_raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">concatenate_raws</span><span class="p">(</span><span class="n">raw_dblocks</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># convert epochs table dataframes to dicts for JSONification</span>
        <span class="k">for</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">epochs_table</span> <span class="ow">in</span> <span class="n">mne_ditis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mne_ditis</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochs_table</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># really belongs attached to the raw, e.g., raw._ditis map of ditis</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;mkh5_epoch_tables&quot;</span><span class="p">:</span> <span class="n">mne_ditis</span><span class="p">})</span>

        <span class="c1"># event and eeg datastreams numpy array</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">filenames</span><span class="o">=</span><span class="p">[</span><span class="n">mkh5_f</span><span class="p">],</span>
            <span class="c1"># orig_format=&#39;single&#39;,</span>
        <span class="p">)</span>

        <span class="c1"># collect boundaries, log_evcodes, and optional garv intervals</span>
        <span class="c1"># marked by concatenate_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>

        <span class="c1"># or average?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeg_reference</span><span class="p">(</span>
            <span class="n">ref_channels</span><span class="o">=</span><span class="p">[],</span> <span class="n">projection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span>  <span class="c1"># &quot;average&quot;</span>
        <span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># file loader for optional apparatus yaml</span>
<span class="k">def</span> <span class="nf">_load_apparatus_yaml</span><span class="p">(</span><span class="n">apparatus_yaml_f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;slurp apparatus info and return the dict or die</span>

<span class="sd">    The file is screened for a unique YAML doc with name: apparatus</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    apparatus_yaml_f: str</span>
<span class="sd">        filepath to yaml</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">       contains name: apparatus, contents are validated as for</span>
<span class="sd">       native mkh5 header apparatus dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">apparatus_yaml_f</span><span class="p">)</span> <span class="k">as</span> <span class="n">apparatus_stream</span><span class="p">:</span>
        <span class="n">yaml_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load_all</span><span class="p">(</span><span class="n">apparatus_stream</span><span class="p">))</span>
        <span class="n">apparatus_hdrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">yaml_doc</span>
            <span class="k">for</span> <span class="n">yaml_doc</span> <span class="ow">in</span> <span class="n">yaml_docs</span>
            <span class="k">if</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">yaml_doc</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;apparatus&quot;</span><span class="p">}</span>
        <span class="p">]</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apparatus_hdrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;no apparatus document&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apparatus_hdrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;multiple apparatus documents&quot;</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; in </span><span class="si">{</span><span class="n">apparatus_yaml_f</span><span class="si">}</span><span class="s2">, there must be exactly one &quot;</span>
                <span class="s2">&quot;YAML doc with name: apparatus&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">yaml_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># .yhdr header functions used by RawMkh5 and EpochsMkh5</span>
<span class="k">def</span> <span class="nf">_validate_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check the mkh5 header key: vals for _parse_header_for_mne</span>

<span class="sd">    Exception messages report the data block, missing keys and</span>
<span class="sd">    wrong values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hdr : dict</span>
<span class="sd">       mkpy.mkh5 dblock header as returned by mkh5.get_dblock()</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Mkh5HeaderKeyError</span>
<span class="sd">       if header is missing a key needed for MNE import</span>
<span class="sd">    Mkh5HeaderValueError</span>
<span class="sd">       if value is wrong for MNE import</span>
<span class="sd">     Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Required Keys</span>

<span class="sd">      FIXME</span>
<span class="sd">       The header must have</span>
<span class="sd">         h5_dataset: &lt;str&gt; samplerate: &lt;int|float&gt; and and apparatus: &lt;map&gt;</span>
<span class="sd">       The apparatus must have these maps: common_ref: &lt;str&gt;, space: &lt;map&gt;, fiducials: &lt;map&gt;, streams, sensors</span>
<span class="sd">       The apparatus streams must have mne_type: &lt;str&gt; pos: &lt;str&gt; neg: &lt;str&gt;</span>
<span class="sd">       The apparatus sensors must have x: &lt;float&gt; y: &lt;float&gt; z: &lt;float&gt;</span>

<span class="sd">     Required Values</span>
<span class="sd">       The h5_dataset string must be a conforming /*/dblock_N mkh5 data block HDF5 path.</span>
<span class="sd">       The sample rate must be an inter or float.</span>
<span class="sd">       The apparatus streams mne_type must be a legal MNE channel</span>
<span class="sd">      type: eeg, eog, stim, misc, ...</span>
<span class="sd">       The apparatus streams pos (= sensor/electrode on +pinout of</span>
<span class="sd">      bioamp) must be one of the apparatus sensor keys to provide</span>
<span class="sd">      the 3D coordinates.</span>
<span class="sd">       The apparatus sensor coordinates must be numeric.</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># these key: vals are built in by mkh5, check anyway</span>
    <span class="k">if</span> <span class="s2">&quot;h5_dataset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;header is missing required key: h5_dataset&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">dblock_path_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^/(\w+/)+(dblock_\d+)</span><span class="si">{1}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dblock_path_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;header h5_dataset is not a mkpy.mkh5 data block path &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;/*/dblock: </span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># used for error messages</span>
    <span class="n">dblock_path</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">]</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># header must have a samplerate</span>
    <span class="k">if</span> <span class="s2">&quot;samplerate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;header has no samplerate key&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;header samplerate must be numeric (integer or float)&quot;</span>
        <span class="c1"># sub_hdr = {&quot;samplerate&quot;: hdr[&quot;samplerate&quot;]}</span>
        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;hdr&quot;</span><span class="p">,</span> <span class="s2">&quot;samplerate&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="n">sfreq</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">]</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># these key: vals are user specified YAML, anything can happen.</span>

    <span class="c1"># there must be an apparatus map</span>
    <span class="k">if</span> <span class="s2">&quot;apparatus&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus map not found&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># apparatus must have stream, sensor, fiducial, common_ref  maps</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">,</span> <span class="s2">&quot;sensors&quot;</span><span class="p">,</span> <span class="s2">&quot;fiducials&quot;</span><span class="p">,</span> <span class="s2">&quot;common_ref&quot;</span><span class="p">,</span> <span class="s2">&quot;space&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> map not found&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">space</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;ras&quot;</span><span class="p">}</span>
    <span class="n">hdr_space</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;apparatus/space&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr_space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus space map must include </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hdr_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus space map must include </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># collect sensor/electrode labels, these vary by experiment</span>
    <span class="n">hdr_sensors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;sensors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># common reference electrode must be among known sensors</span>
    <span class="k">if</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;common_ref&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr_sensors</span><span class="p">:</span>
        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;/apparatus/common_ref&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;apparatus common_ref value must&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;be one of these: &lt;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr_sensors</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># check string values</span>
    <span class="n">HDR_MNE_STREAM_KEY_VALS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mne_type&quot;</span><span class="p">:</span> <span class="n">MNE_STREAM_TYPES</span><span class="p">,</span>  <span class="c1"># eeg, eog, stim, misc, ...</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">hdr_sensors</span><span class="p">,</span>  <span class="c1"># these provide the 3D coordinates</span>
        <span class="s2">&quot;neg&quot;</span><span class="p">:</span> <span class="n">hdr_sensors</span><span class="p">,</span>  <span class="c1"># these provide the 3D coordinates</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">stream</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apparatus/streams/</span><span class="si">{</span><span class="n">stream</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># check the mne_type, pos, neg keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">HDR_MNE_STREAM_KEY_VALS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus stream </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found&quot;</span>
                <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

        <span class="c1"># check the values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">HDR_MNE_STREAM_KEY_VALS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;apparatus stream </span><span class="si">{</span><span class="n">stream</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> value must&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;be one of these: &lt;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># fiducial keys are lpa, rpa, nasion</span>
    <span class="n">FID_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lpa&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">,</span> <span class="s2">&quot;nasion&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">fid_key</span> <span class="ow">in</span> <span class="n">FID_KEYS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fid_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;fiducials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;apparatus/fiducials&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;apparatus fiducials (lpa, rpa, nasion) location &quot;</span>
                <span class="s2">&quot;</span><span class="si">{fid_key}</span><span class="s2"> not found&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># sensors and fiducials  must have 3D x, y, z keys and numeric values</span>
    <span class="k">for</span> <span class="n">key_3d</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sensors&quot;</span><span class="p">,</span> <span class="s2">&quot;fiducials&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="n">key_3d</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># sub_hdr = {&quot;apparatus&quot;: {key_3d: {key: val}}}</span>
            <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apparatus/</span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> 3D x,y,z &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;coordinate axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> not found&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> coordinate &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> must be a numeric value&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return header info formatted for MNE dig montage and info</span>

<span class="sd">    The user-specified hdr[&quot;apparatus&quot;][&quot;streams][&quot;mne_type&quot;] values from the</span>
<span class="sd">    the YAML .yhdr are used, all the rest of the data block columns are</span>
<span class="sd">    assigned MNE type &quot;misc&quot;</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    hdr : dict</span>
<span class="sd">       as returned hdr, dblock = ``mkh5.get_dblock()``</span>

<span class="sd">    dblock : np.ndarray</span>
<span class="sd">       as returned hdr, dblock = ``mkh5.get_dblock()``</span>

<span class="sd">    apparatus_yaml : {None, str}, optional</span>
<span class="sd">       filepath to YAML file alternate stream and sensor information.</span>
<span class="sd">       Format requirements are the same as for the mkh5 header</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results: dict</span>
<span class="sd">        keys, values for MNE montage, create_info, and</span>
<span class="sd">         set_eeg_reference methods `sfreq`, `set_ref_ch_type`,</span>
<span class="sd">         `set_ref_channels`, `ch_labels`, `ch_types`, `dig_ch_pos`</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Validation is done in _validate_hdr_for_mne, this just collects</span>
<span class="sd">    and formats the header data.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># cm distance units are guarded in _validate_hdr_for_mne</span>
    <span class="n">YHDR_RAS_UNIT</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># apparatus streams are user YAML w/ mne_type, typically</span>
    <span class="c1"># a subset of the hdr[&quot;streams&quot;] which includes clock ticks,</span>
    <span class="c1"># and events</span>

    <span class="c1"># optionally update native mkh5 hdr apparatus</span>
    <span class="k">if</span> <span class="n">apparatus_yaml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_load_apparatus_yaml</span><span class="p">(</span><span class="n">apparatus_yaml</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Overriding </span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with sensor locations&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; from </span><span class="si">{</span><span class="n">apparatus_yaml</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">_validate_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="n">apparatus_streams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;streams&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>

    <span class="c1"># sensors (=electrodes) are physical objects in 3-space</span>
    <span class="n">apparatus_sensors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;sensors&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">)</span>

    <span class="c1"># sinnce eeg data streams don&#39;t have a &quot;location&quot; use</span>
    <span class="c1"># coordinates from the positive pinout electrode</span>
    <span class="n">apparatus_streams</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apparatus_sensors</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">)</span>

    <span class="c1"># collect the fiducials</span>
    <span class="n">apparatus_fiducials</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;fiducials&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;fiducial&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># collect the mkpy.mkh5 built-in data block hdr[&quot;streams&quot;],</span>
    <span class="n">hdr_streams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span>
    <span class="p">)</span>

    <span class="c1"># mkh5 built-in hdr[&quot;streams&quot;] align 1-1 with</span>
    <span class="c1"># the dblock data 1-D columns unless tampered with</span>
    <span class="c1"># assert tuple(hdr_streams.index) == dblock.dtype.names</span>

    <span class="c1"># merge in the apparatus stream data</span>
    <span class="n">hdr_streams</span> <span class="o">=</span> <span class="n">hdr_streams</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apparatus_streams</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>

    <span class="c1"># update known dblock streams to mne_types</span>
    <span class="n">hdr_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;raw_evcodes&quot;</span><span class="p">,</span> <span class="s2">&quot;log_evcodes&quot;</span><span class="p">,</span> <span class="s2">&quot;log_ccodes&quot;</span><span class="p">],</span> <span class="s2">&quot;mne_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stim&quot;</span>
    <span class="n">hdr_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">hdr_streams</span><span class="p">[</span><span class="s2">&quot;mne_type&quot;</span><span class="p">]),</span> <span class="s2">&quot;mne_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;misc&quot;</span>

    <span class="c1"># 3D sensor coordinate cm  dicts -&gt; in MNE key: [R, A, S, ... ] m format</span>
    <span class="c1"># fiducial landmarks in MNE label: [x, y, z] format</span>
    <span class="n">fiducials</span> <span class="o">=</span> <span class="n">apparatus_fiducials</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">YHDR_RAS_UNIT</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># for mne.channels.make_dig_montage</span>
    <span class="n">dig_ch_pos</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">YHDR_RAS_UNIT</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># for info[&quot;chs&quot;][i][&quot;loc&quot;] = array, shape(12,)</span>
    <span class="c1"># first 3 are positive sensor, next 3 are reference (negative)</span>
    <span class="c1"># but MNE DigMontage chokes on mixed common ref (A1) and biploar</span>
    <span class="c1"># so skip the reference location</span>
    <span class="n">info_ch_locs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># e.g., A1 for common reference, lhz for bipolar HEOG.</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="c1"># neg = apparatus_streams.loc[ch, &quot;neg&quot;]   # not used</span>
        <span class="n">pos_locs</span> <span class="o">=</span> <span class="n">apparatus_sensors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">info_ch_locs</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="c1"># [pos_locs, ref_locs, np.zeros((6, ))] # the truth</span>
                <span class="p">[</span><span class="n">pos_locs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,))]</span>  <span class="c1"># what works w/ MNE</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">YHDR_RAS_UNIT</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">sfreq</span><span class="o">=</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">],</span>
        <span class="n">set_ref_ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span>
        <span class="n">set_ref_channels</span><span class="o">=</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;common_ref&quot;</span><span class="p">],</span>
        <span class="n">ch_labels</span><span class="o">=</span><span class="n">hdr_streams</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">ch_types</span><span class="o">=</span><span class="n">hdr_streams</span><span class="o">.</span><span class="n">mne_type</span><span class="p">,</span>
        <span class="n">dig_ch_pos</span><span class="o">=</span><span class="n">dig_ch_pos</span><span class="p">,</span>
        <span class="n">info_ch_locs</span><span class="o">=</span><span class="n">info_ch_locs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fiducials</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_patch_dblock_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_mne</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tune up MNE info with additional mkpy hdr data</span>

<span class="sd">    Most MNE internal values are already set to correct</span>
<span class="sd">    values by create_info and ch_types.</span>

<span class="sd">    ch_info[&quot;cal&quot;] is the critical the scaling factor, so that RawArray</span>
<span class="sd">    data * ch_info[&quot;cal&quot;] is on the FIFF.FIFF_UNIT_V scale, i.e., 1e-6</span>
<span class="sd">    for the calibrated mkpy.mkh5 to microvolts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># info[&quot;proj_name&quot;] = hdr[&quot;expdesc&quot;]</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;his_id&quot;</span><span class="p">:</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]}</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;device_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]}</span>

    <span class="c1"># dev note:</span>
    <span class="c1"># the mne.io.get_new_fileid(), thefile_id == meas_id looks like this</span>
    <span class="c1"># {</span>
    <span class="c1">#     &#39;machid&#39;: array([808661043, 808661043], dtype=int32),</span>
    <span class="c1">#     &#39;version&#39;: 65540 (FIFFC_VERSION),</span>
    <span class="c1">#     &#39;secs&#39;: 1601769754,</span>
    <span class="c1">#     &#39;usecs&#39;: 514806</span>
    <span class="c1"># }</span>

    <span class="c1"># from mkh5 os.stat_result</span>
    <span class="n">dtime</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;eeg_file_stat&quot;</span><span class="p">][</span><span class="s2">&quot;st_ctime&quot;</span><span class="p">]</span>

    <span class="c1"># seed MNE info fields w/ default and update w/ mkh5 datetimes</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">get_new_file_id</span><span class="p">()</span>
    <span class="n">file_id</span><span class="p">[</span><span class="s2">&quot;secs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span>
    <span class="n">file_id</span><span class="p">[</span><span class="s2">&quot;usecs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">dtime</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10e6</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;meas_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;meas_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_id</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;meas_id&quot;</span><span class="p">]</span>

    <span class="c1"># CRITICAL: set scaling factor for microvolt data</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ch_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]):</span>
        <span class="n">ch_name</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">]</span>
        <span class="n">is_eeg</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFFV_EEG_CH</span>
        <span class="n">is_eog</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFFV_EOG_CH</span>
        <span class="k">if</span> <span class="n">is_eeg</span> <span class="ow">or</span> <span class="n">is_eog</span><span class="p">:</span>

            <span class="c1"># update ch locs from parsed hdr[&quot;apparatus&quot;][&quot;sensor&quot;]</span>
            <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;info_ch_locs&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">]</span>

            <span class="c1"># from create_info</span>
            <span class="k">assert</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span>

            <span class="c1"># CRITICAL this scales mkh5 calibrated uV to MNE V</span>
            <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;cal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>

            <span class="c1"># mkh5 data blocks may or may not be calibrated</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="s2">&quot;calibrated&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="ow">and</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">][</span><span class="s2">&quot;calibrated&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;mkh5 data </span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;is not calibrated, scale is unknown&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">info</span>


<span class="c1"># def _check_header_across_dblocks(mkh5_f):</span>
<span class="c1">#     &quot;&quot;&quot;return headers checked for same streams and apparatus across data blocks</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     mkh5_f : str</span>
<span class="c1">#         path to an mkh5 file</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     hdrs : dict</span>
<span class="c1">#         The keys are `dblock_path` (str) as returned in the list of</span>
<span class="c1">#         `mkh5.dblock_paths`. The values are `hdr` (dict) as returned</span>
<span class="c1">#         by hdr, dblock = mkh5.get_dblock().</span>


<span class="c1">#     Raises</span>
<span class="c1">#     ------</span>
<span class="c1">#     Mkh5HeaderError</span>

<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     h5 = mkh5.mkh5(mkh5_f)</span>
<span class="c1">#     dblock_paths = h5.dblock_paths</span>
<span class="c1">#     hdrs = []</span>
<span class="c1">#     mismatch = None</span>
<span class="c1">#     for dblock_path in dblock_paths:</span>
<span class="c1">#         hdr, _ = h5.get_dblock(dblock_path)</span>
<span class="c1">#         _validate_hdr_for_mne(hdr)</span>

<span class="c1">#         # identity is transitive, checking ith vs. first suffices</span>
<span class="c1">#         if len(hdrs) &gt; 0:</span>
<span class="c1">#             if not hdr[&quot;streams&quot;].keys() == hdrs[0][&quot;streams&quot;].keys():</span>
<span class="c1">#                 mismatch = &quot;stream&quot;</span>
<span class="c1">#             if not hdr[&quot;apparatus&quot;] == hdrs[0][&quot;apparatus&quot;]:</span>
<span class="c1">#                 mismatch = &quot;apparatus&quot;</span>
<span class="c1">#             if mismatch:</span>
<span class="c1">#                 msg = (</span>
<span class="c1">#                     f&quot;data block header mismatch header[&#39;{mismatch}&#39;] &quot;</span>
<span class="c1">#                     f&quot;{dblock_paths[0]} {dblock_path}&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#                 raise Mkh5HeaderError(msg)</span>
<span class="c1">#         hdrs.append(hdr)</span>
<span class="c1">#     return dict(zip(dblock_paths, hdrs))</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># general data wrangling</span>
<span class="k">def</span> <span class="nf">_dblock_to_raw</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">garv_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert one mkh5 datablock+header into one mne.RawArray</span>

<span class="sd">    Ingest one mkh5 format data block and return an mne.RawArray</span>
<span class="sd">    populated with enough data and channel information to use mne.viz</span>
<span class="sd">    and the mne.Epochs, mne.Evoked EEG pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dblock_path : str</span>
<span class="sd">       HDF5 slash path to an mkh5 data block which an h5py.Dataset</span>
<span class="sd">    garv_interval: iterable of two numbers</span>
<span class="sd">       interval in milliseconds relative to a log_evcode event at time==0</span>
<span class="sd">    apparatus_yaml: str, optional</span>
<span class="sd">       filepath to YAML apparatus file with stream and sensor space info</span>
<span class="sd">       to override native mkh5 hdr[&quot;apparatus&quot;] if any. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mne.RawArray</span>
<span class="sd">        with channel locations from apparatus_yaml and mkh5 epochs tables</span>
<span class="sd">        JSONified and tucked into the Info[&quot;description&quot;]</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The raw_dblock returned from this can be stacked with</span>
<span class="sd">    mne.concatenate_raws() though MNE behavior is to use first</span>
<span class="sd">    info and just stack the datablocks. epochs metadata is</span>
<span class="sd">    collected and returned per block so the complete record</span>
<span class="sd">    can be tucked into the (one) info object when the dblocks</span>
<span class="sd">    are stacked. </span>

<span class="sd">    The  raw.set_eeg_reference(ref_channels=[]) at the end to block</span>
<span class="sd">    subsequent mne&#39;s default automatic average rereferencing later in</span>
<span class="sd">    the pipeline (sheesh).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h5</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dblock_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Mkh5DblockPathError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="n">info</span><span class="p">,</span> <span class="n">montage</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span>
    <span class="p">)</span>

    <span class="c1"># mne wants homogenous n_chans x nsamps, so stim, misc ints coerced</span>
    <span class="c1"># to float ... sigh.</span>
    <span class="n">mne_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;f8&quot;</span><span class="p">)</span>

    <span class="c1"># slice out and scale mkh5 recorded data to mne standards</span>
    <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dblock</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">stream</span>
        <span class="n">mne_data</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="o">*</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">][</span><span class="n">jdx</span><span class="p">][</span><span class="s2">&quot;cal&quot;</span><span class="p">]</span>

    <span class="c1"># create the raw object</span>
    <span class="n">raw_dblock</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">mne_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_montage</span><span class="p">(</span><span class="n">montage</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># add an MNE data column for each epochs_table in the mkh5 file</span>
    <span class="c1">#   - for each one, slice the timelock events at match_time == 0</span>
    <span class="c1">#   - copy the time-locked event code to the epochs column and</span>
    <span class="c1">#     the rest of the epochs tables columns to metadata.</span>

    <span class="n">epochs_table_names</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">get_epochs_table_names</span><span class="p">()</span>
    <span class="n">epochs_table_descr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># returned for mkh5 epoching from MNE Raw</span>

    <span class="n">log_evcodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">raw_dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span>  <span class="c1"># for checking</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epochs_table_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">etn</span> <span class="ow">in</span> <span class="n">epochs_table_names</span><span class="p">:</span>

            <span class="c1"># fetch the epochs_table and slice for this mkh5 data block</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dblock_path</span><span class="si">}</span><span class="s2"> setting mkh5 epochs table </span><span class="si">{</span><span class="n">etn</span><span class="si">}</span><span class="s2"> events and metadata&quot;</span><span class="p">)</span>
            <span class="n">epochs_table</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_epochs_table</span><span class="p">(</span><span class="n">etn</span><span class="p">)</span>
            <span class="n">etn_dblock</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">epochs_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;dblock_path == @dblock_path and match_time==0&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># CRITICAL: The mkh5 epoch table indexes HDF5 data by</span>
            <span class="c1"># dblock_path, dblock_tick (row offset), the row sort</span>
            <span class="c1"># order is undefined. MNE squawks if event array</span>
            <span class="c1"># sample indexes are not monotonically increasing.</span>
            <span class="n">etn_dblock</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># capture epochs table as data frame for later</span>
            <span class="n">epochs_table_descr</span><span class="p">[</span><span class="n">etn</span><span class="p">]</span> <span class="o">=</span> <span class="n">etn_dblock</span>

            <span class="c1"># container for the new column of event codes</span>
            <span class="n">etn_evcodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">raw_dblock</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span>  <span class="c1"># yes, (1, len) b.c. MNE wants chan x time</span>

            <span class="c1"># CRITICAL: copy over log_evcodes at just the epoch event ticks</span>
            <span class="n">etn_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">log_evcodes</span>

            <span class="c1"># true by construction of mkh5 epochs. However ...</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">log_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">etn_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># clone the log_evcodes to get their MNE info attributes</span>
            <span class="n">etn_event_channel</span> <span class="o">=</span> <span class="n">raw_dblock</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">pick</span><span class="p">([</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">])</span>

            <span class="c1"># rename and hack in the correct scanno, logno in case it matters</span>
            <span class="n">mne</span><span class="o">.</span><span class="n">rename_channels</span><span class="p">(</span><span class="n">etn_event_channel</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">:</span> <span class="n">etn</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scanno&quot;</span><span class="p">,</span> <span class="s2">&quot;logno&quot;</span><span class="p">]:</span>
                <span class="n">etn_event_channel</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="c1"># set the event code data values append the channel and confirm</span>
            <span class="c1"># MNE agrees when asked in its native tongue.</span>
            <span class="n">etn_event_channel</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">etn_evcodes</span>
            <span class="n">raw_dblock</span><span class="o">.</span><span class="n">add_channels</span><span class="p">([</span><span class="n">etn_event_channel</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">raw_dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">raw_dblock</span><span class="p">[</span><span class="n">etn</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># seed the MNE annotations with the data block path at time == 0</span>
    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span>
        <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">dblock_path</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># add log_evocdes garv annotations, if any. validated in _check_api_params</span>
    <span class="k">if</span> <span class="n">garv_interval</span><span class="p">:</span>
        <span class="n">bad_garvs</span> <span class="o">=</span> <span class="n">get_garv_bads</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">,</span> <span class="s2">&quot;log_evcodes&quot;</span><span class="p">,</span> <span class="n">garv_interval</span><span class="p">)</span>
        <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">raw_dblock</span><span class="o">.</span><span class="n">annotations</span> <span class="o">+</span> <span class="n">bad_garvs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">raw_dblock</span><span class="p">,</span> <span class="n">epochs_table_descr</span>


<span class="k">def</span> <span class="nf">_hdr_dblock_to_info_montage</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;populate MNE structures with mkh5 data&quot;&quot;&quot;</span>

    <span class="n">hdr_mne</span> <span class="o">=</span> <span class="n">_parse_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;ch_labels&quot;</span><span class="p">],</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">],</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;ch_types&quot;</span><span class="p">])</span>

    <span class="n">montage</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">make_dig_montage</span><span class="p">(</span>
        <span class="n">ch_pos</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;dig_ch_pos&quot;</span><span class="p">],</span>
        <span class="n">nasion</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;nasion&quot;</span><span class="p">],</span>
        <span class="n">lpa</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;lpa&quot;</span><span class="p">],</span>
        <span class="n">rpa</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;rpa&quot;</span><span class="p">],</span>
        <span class="n">coord_frame</span><span class="o">=</span><span class="s2">&quot;head&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">_patch_dblock_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_mne</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">montage</span>


<span class="k">def</span> <span class="nf">_check_mne_raw_mkh5_epochs</span><span class="p">(</span><span class="n">raw_mkh5</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>

    <span class="n">hint</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot; Check that raw_mkh5 = read_raw_mkh5(your_file.h5, ...) and your mkh5 file &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;was created with myh5.set_epochs(&#39;</span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">&#39;, event_table, ...) and a &quot;</span>
        <span class="s2">&quot;valid mkh5 format event_table.&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_epochs_tables</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_mkh5</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])[</span>
            <span class="s2">&quot;mkh5_epochs_tables&quot;</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;could not load raw_mkh5.info[&#39;description&#39;] epoch tables JSON data&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">epochs_name</span> <span class="ow">in</span> <span class="n">dbept</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dbept</span> <span class="ow">in</span> <span class="n">json_epochs_tables</span><span class="p">]):</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;raw_mkh5.info does not have any data for </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> epochs. &quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">epochs_name</span> <span class="ow">in</span> <span class="n">dbept</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dbept</span> <span class="ow">in</span> <span class="n">json_epochs_tables</span><span class="p">]):</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;raw_mkh5.info </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> data is missing for one or more data blocks. &quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">epochs_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_mkh5</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">]:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;event channel </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> not found in raw_mkh5.info[&#39;ch_names&#39;], &quot;</span>
            <span class="s2">&quot;no epoch event information. &quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">json_epochs_tables</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># API</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="read_raw_mkh5"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.read_raw_mkh5">[docs]</a><span class="k">def</span> <span class="nf">read_raw_mkh5</span><span class="p">(</span>
    <span class="n">mkh5_file</span><span class="p">,</span>
    <span class="n">garv_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dblock_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fail_on_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fail_on_montage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Read an mkh5 data file into MNE raw format</span>

<span class="sd">    The mkh5 EEG data, events are converted to mne.BaseRaw for use</span>
<span class="sd">    with native MNE methods. The mkh5 timelock events and tags in the</span>
<span class="sd">    epochs tables are added to the raw data and mne.Info for use as</span>
<span class="sd">    MNE events and metadata with mne.Epochs.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_file: str</span>
<span class="sd">        File path to a mkpy.mkh5 HDF5 file</span>

<span class="sd">    dblock_paths : {None, list of str}, optional</span>
<span class="sd">        Selects dblock_paths and order to concatenate into the</span>
<span class="sd">        mne.Raw.  The default is to use all data blocks in the order</span>
<span class="sd">        returned by ``mkh5.dblock_paths``.</span>

<span class="sd">    garv_interval : list [pre, post, {&quot;ms&quot; | &quot;s&quot;}], optional</span>

<span class="sd">        If present, all events on the ``log_evcodes`` data channel are</span>
<span class="sd">        bracketed with an MNE annotation in the time interval between</span>
<span class="sd">        pre to post seconds relative to the event with description</span>
<span class="sd">        BAD_garv_N where N is the integer log_flag code.</span>

<span class="sd">    fail_on_info : bool {False}, optional</span>
<span class="sd">        If True, this enforces strict mne.Info identity across the</span>
<span class="sd">        mkh5 data blocks being concatenated. If False (default), some</span>
<span class="sd">        deviations between mne.Info for the mkh5 data blocks are</span>
<span class="sd">        allowed, e.g., for pooling multiple subject files into an</span>
<span class="sd">        experiment or separate cals for a single subject.</span>

<span class="sd">    fail on montage : bool {True}, optional</span>
<span class="sd">       If True (default), the mne.Montage created from the mkh5 header</span>
<span class="sd">       data streams and channel locations must be the same for all the</span>
<span class="sd">       data blocks. If False, the montage may vary across mkh5 data</span>
<span class="sd">       blocks; behavior in this case is unpredictable.</span>

<span class="sd">    verbose : NotImplemented</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RawMkh5</span>
<span class="sd">        subclassed from mne.BaseRaw for use as native MNE.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions</span>
<span class="sd">        if data block paths or apparatus map information is</span>
<span class="sd">        misspecified or the info and montage test flags are set and fail.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    EEG and events. The mkh5 data block columns are converted to</span>
<span class="sd">        mne channels and concatenated into a single mne Raw in the</span>
<span class="sd">        order given by `dblock_paths`. The default is to convert the</span>
<span class="sd">        entire mkh5 file in `mkh5.dblock_paths` order.</span>

<span class="sd">    Epochs. The mkh5 epochs table timelocking events are indexed to</span>
<span class="sd">        the mne.Raw data samples and the epoch tables stored as a JSON</span>
<span class="sd">        string in mne.Info[&quot;description&quot;]. The complete epochs table</span>
<span class="sd">        is recovered by JSON loading the ``mne.Info[&quot;description&quot;]`` and</span>
<span class="sd">        converting the `epochs_name` dictionary to a</span>
<span class="sd">        pandas.DataFrame. This yields a well-formed</span>
<span class="sd">        mne.Epochs.metadata for the events on the `epochs_name` stim</span>
<span class="sd">        channel.</span>

<span class="sd">    TODO: The mkh5 epochs data, i.e., time-lock events, discrete time</span>
<span class="sd">        intervals, and mixed data-type tags would do better as an</span>
<span class="sd">        attribute of mne.BaseRaw, e.g., mne.Raw._ditidata. Discrete</span>
<span class="sd">        time intervals indexed for (onset, hop, duration) with</span>
<span class="sd">        mixed-type tags subsume the spaghetti of MNE events, epochs,</span>
<span class="sd">        and epochs metadata, annotations and the discrete time model</span>
<span class="sd">        avoids cumulative rounding error issues of floating-point</span>
<span class="sd">        times.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">RawMkh5</span><span class="p">(</span>
        <span class="n">mkh5_file</span><span class="p">,</span>
        <span class="n">garv_interval</span><span class="o">=</span><span class="n">garv_interval</span><span class="p">,</span>
        <span class="n">dblock_paths</span><span class="o">=</span><span class="n">dblock_paths</span><span class="p">,</span>
        <span class="n">fail_on_info</span><span class="o">=</span><span class="n">fail_on_info</span><span class="p">,</span>
        <span class="n">fail_on_montage</span><span class="o">=</span><span class="n">fail_on_montage</span><span class="p">,</span>
        <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_garv_bads"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_garv_bads">[docs]</a><span class="k">def</span> <span class="nf">get_garv_bads</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">event_channel</span><span class="p">,</span> <span class="n">garv_interval</span><span class="p">,</span> <span class="n">garv_channel</span><span class="o">=</span><span class="s2">&quot;log_flags&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;bracket events with mne BAD_garv annotations</span>

<span class="sd">    This timelocks the annotation to all events on event channel that</span>
<span class="sd">    have a non-zero codes on the log_flags column, e.g., as given by</span>
<span class="sd">    as given by running avg -x -a subNN.arf to set log_flags in</span>
<span class="sd">    subNN.log.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">        mne.Raw data object converted from mkh5</span>
<span class="sd">    event_channel : str</span>
<span class="sd">        name of the mne channel with events to bracket with BAD_garv annotations</span>
<span class="sd">    garv_interval : list of [start, stop, unit]</span>
<span class="sd">         start and stop are human readable numeric times relative to</span>
<span class="sd">         the event, unit is &quot;ms&quot; or &quot;s&quot;</span>
<span class="sd">    garv_channel : str, optional</span>
<span class="sd">         name of the channel to check for non-zero codes at time-lock</span>
<span class="sd">         events. The default=&quot;log_flags&quot; is where avg -x puts garv rejects,</span>
<span class="sd">         other routines may use other channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mne.Annotations</span>
<span class="sd">        formatted as ``BAD_garv_int`` for triggering mne&#39;s drop by</span>
<span class="sd">        annotation mechanism.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># modicum of validation</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">garv_start</span><span class="p">,</span> <span class="n">garv_stop</span><span class="p">,</span> <span class="n">garv_unit</span> <span class="o">=</span> <span class="n">garv_interval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">garv_start</span> <span class="o">&lt;</span> <span class="n">garv_stop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad interval&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">garv_unit</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">garv_unit</span> <span class="o">==</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span>
            <span class="n">garv_start</span> <span class="o">/=</span> <span class="mf">1000.0</span>
            <span class="n">garv_stop</span> <span class="o">/=</span> <span class="mf">1000.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad units&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;garv_interval=[start, stop, units] with numeric start &lt; stop &quot;</span>
            <span class="s2">&quot;and units s or ms&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">garv_duration</span> <span class="o">=</span> <span class="n">garv_stop</span> <span class="o">-</span> <span class="n">garv_start</span>

    <span class="c1"># epoch event channel column</span>
    <span class="n">event_ch</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">event_channel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># artifact channel column</span>
    <span class="n">garv_ch</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">garv_channel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># lookup where in the recording the event is &gt; 0 and log_flag &gt; 0</span>
    <span class="n">bad_garv_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">event_ch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">garv_ch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># lower bound of annotation is time=0, upper bound is max time</span>
    <span class="n">min_t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_ch</span><span class="p">)</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span>

    <span class="c1"># trim onset underruns and duration overruns, else</span>
    <span class="n">onsets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">min_t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bad_garv_ticks</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">garv_start</span>
    <span class="p">]</span>

    <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">garv_duration</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_t</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">onsets</span><span class="p">)</span> <span class="o">+</span> <span class="n">garv_duration</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># build the integer garv code into the description</span>
    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;BAD_garv_</span><span class="si">{</span><span class="n">garv_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bad_garv_ticks</span><span class="p">]</span>

    <span class="c1"># convert to mne format annotations</span>
    <span class="n">bad_garvs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span>
        <span class="n">onset</span><span class="o">=</span><span class="n">onsets</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">descriptions</span><span class="p">,</span>
        <span class="n">orig_time</span><span class="o">=</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">orig_time</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">bad_garvs</span></div>


<div class="viewcode-block" id="get_epochs_metadata"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_epochs_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_epochs_metadata</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;retrieve mkh5 epochs table dataframe from mne.Raw.info[&quot;description&quot;]</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">       converted from a mkpy.mkh5 file that contains at least one</span>
<span class="sd">       named epochs table.</span>

<span class="sd">    epochs_name : str</span>
<span class="sd">       name of the epochs_table</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        mne.Epochs.metadata format, one row per epoch corresponding to</span>
<span class="sd">        the time-locking event at time=0.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
        <span class="n">mkh5_epochs</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[</span><span class="s2">&quot;mkh5_epoch_tables&quot;</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">mkh5_epochs</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span><span class="si">}</span><span class="s2"> ... could load </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> from mne.Info[&#39;description&#39;], &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;check it is in mkh5.get_epochs_table_names() before converting mkh5 &quot;</span>
            <span class="s2">&quot;to MNE raw format.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_epochs"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_epochs">[docs]</a><span class="k">def</span> <span class="nf">get_epochs</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">metadata_columns</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;retrieve mkh5 epochs table dataframe from mne.Raw.info[&quot;description&quot;]</span>

<span class="sd">    The mne.Epoch interval [tmin, tmax] matches the tmin_ms, tmax_ms</span>
<span class="sd">    interval mkh5.set_epochs(epochs_name, events, tmin_ms, tmax_ms).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">       The raw must have been converted from a mkpy.mkh5 file that</span>
<span class="sd">       contains at least one named epochs table.</span>

<span class="sd">    epochs_name : str</span>
<span class="sd">       Name of the epochs_table to get.</span>

<span class="sd">    metadata_columns: list of str, optional</span>
<span class="sd">       Specify which metadata columns to include with the epochs,</span>
<span class="sd">       default is all.</span>

<span class="sd">    **kwargs</span>
<span class="sd">       kwargs passed to mne.Epochs()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        mne.Epochs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_epochs_metadata</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">)</span>

    <span class="c1"># epoch interval start, stop in seconds, relative to</span>
    <span class="c1"># timelocking event at mne_raw_ticks</span>
    <span class="n">tmins</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;diti_hop&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">]</span>
    <span class="n">tmaxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;diti_len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">tmins</span>

    <span class="c1"># true by construction of mkh5 epochs or die</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmins</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmaxs</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="p">),</span> <span class="s2">&quot;irregular mkh5 epoch diti_hop, diti_len&quot;</span>

    <span class="n">tmin</span> <span class="o">=</span> <span class="n">tmins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">tmaxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata_columns</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span><span class="p">(</span>
        <span class="n">mne_raw</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020 Thomas P. Urbach, Andrey Portnoy, 2013 Nathaniel Smith

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>