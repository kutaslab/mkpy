<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mkpy.io.mkh5mne &mdash; mkpy  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> mkpy
          </a>
              <div class="version">
                0.2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation  (64-bit linux only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples_gallery/mkh5/mkh5_quickstart.html">mkh5 Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../AS_howto.html">A. Stoermannâ€™s Gists online</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ExamplesGallery.html">Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../UserGuide.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CheatSheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Learning.html">Background reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ReleaseNotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../RolesCredits.html">Roles and credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mkpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../mkpy.html">mkpy</a> &raquo;</li>
      <li>mkpy.io.mkh5mne</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mkpy.io.mkh5mne</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;import mkpy5 HDF5 data files to MNE Raw and Epochs, savable as .fif files&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">mkpy.mkh5</span> <span class="k">as</span> <span class="nn">mkh5</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">dpath</span>  <span class="c1"># local fork of dpath</span>
<span class="kn">from</span> <span class="nn">mkpy</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">mkpy_version</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne.io.constants</span> <span class="kn">import</span> <span class="n">FIFF</span>
<span class="kn">from</span> <span class="nn">mne.utils.numerics</span> <span class="kn">import</span> <span class="n">object_hash</span>  <span class="c1"># for comparing MNE objects</span>


<span class="c1"># TODO simple logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;mneio_mkh5&quot;</span><span class="p">)</span>  <span class="c1"># all for one, one for all</span>
<span class="n">logger</span><span class="o">.</span><span class="n">propoagate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># in case of multiple imports</span>

<span class="n">__MKH5MNE_VERSION__</span> <span class="o">=</span> <span class="n">mkpy_version</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># globals</span>

<span class="c1"># info = INFO</span>
<span class="c1"># quiet = WARN</span>
<span class="c1"># all = DEBUG</span>
<span class="n">VERBOSE_LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">]</span>

<span class="n">MNE_STREAM_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span> <span class="s2">&quot;eog&quot;</span><span class="p">,</span> <span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;misc&quot;</span><span class="p">]</span>
<span class="n">MNE_MIN_VER</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># major, minor</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># mkh5 specific</span>

<span class="c1"># requires header info introduced in mkh5 0.2.4</span>
<span class="n">MKH5_MIN_VER</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># major, minor, patch</span>
<span class="n">MKH5_EEG_UNIT</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># mkh5 is calibrated to microvolts</span>

<span class="n">MKH5_STIM_CHANNELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;raw_evcodes&quot;</span><span class="p">,</span> <span class="s2">&quot;log_evcodes&quot;</span><span class="p">,</span> <span class="s2">&quot;log_ccodes&quot;</span><span class="p">,</span> <span class="s2">&quot;log_flags&quot;</span><span class="p">,</span> <span class="s2">&quot;pygarv&quot;</span><span class="p">]</span>

<span class="n">GARV_ANNOTATION_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;event_channel&quot;</span><span class="p">,</span> <span class="s2">&quot;tmin&quot;</span><span class="p">,</span> <span class="s2">&quot;tmax&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span>

<span class="n">KWARGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dblock_paths&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional, selects listed dblock_paths</span>
    <span class="s2">&quot;garv_annotations&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;fail_on_info&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;fail_on_montage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>  <span class="c1"># optional</span>
    <span class="s2">&quot;ignore_keys&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># optional</span>
<span class="p">}</span>

<span class="c1"># these info keys can vary by mkh5 dblock, exclude from identity tests</span>
<span class="n">IGNORE_INFO_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_id&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_name&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_info&quot;</span><span class="p">]</span>

<span class="c1"># for apparatus header</span>
<span class="n">FIDUCIAL_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lpa&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">,</span> <span class="s2">&quot;nasion&quot;</span><span class="p">]</span>

<span class="c1"># EPOCHS_KWARGS = {</span>
<span class="c1">#     &quot;epochs_name&quot;: None,  # mandatory</span>
<span class="c1">#     &quot;epoch_id&quot;: &quot;epoch_id&quot;,  # mkpy.mkh5 &gt; 0.2.3 default</span>
<span class="c1">#     &quot;time&quot;: &quot;match_time&quot;,  # mkpy.mkh5 &gt; 0.2.3 default</span>
<span class="c1"># }</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># base class for informative YAML header format errors</span>
<span class="k">class</span> <span class="nc">Mkh5HeaderError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;used when mkh5 header is not compatible with building MNE data structures</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message: str</span>
<span class="sd">      printed message</span>

<span class="sd">    dblock_path: str</span>
<span class="sd">      mkh5 dblock_path the header came from</span>

<span class="sd">    bad: dict, optional</span>
<span class="sd">       if present is dumped as a YAML str to show the (sub) dictionary</span>
<span class="sd">       that threw the exception.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">dblock_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dbp_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">dblock_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;in data block: </span><span class="si">{</span><span class="n">dblock_path</span><span class="si">}</span><span class="s2"> header, &quot;</span>
        <span class="p">)</span>
        <span class="n">bad_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">bad</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">message</span> <span class="o">+</span> <span class="n">dbp_str</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, check the .yhdr YAML</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">bad_str</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing a key required for MNE import</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;value is the wrong type for MNE import</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Mkh5HeaderTypeError</span><span class="p">(</span><span class="n">Mkh5HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;illegal value for MNE import</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># miscellaneous exceptions</span>
<span class="k">class</span> <span class="nc">Mkh5FileAccessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;file error</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Mkh5InfoUpdateError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;report failed info update attempts</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mne_info_key</span><span class="p">,</span> <span class="n">bad_value</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;failed to set mne info[</span><span class="si">{mne_info_key}</span><span class="s2">] = </span><span class="si">{bad_value}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Mkh5DblockPathError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent datablock</span>

<span class="sd">    h5py also throws an error but the message is generic</span>
<span class="sd">    &quot;object not found&quot; without specifying what object.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dbp</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fail_msg</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># mkh5 epochs  table errors</span>
<span class="k">class</span> <span class="nc">EpochsMkh5EpochsNameError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent epochs table</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> cannot locate epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;check mkh5.get_epoch_table_names()&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">EpochsMkh5ExcludedDataBlockError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tried to access a non-existent mkh5 data block</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">missing_dblocks</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> requires data the following &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> dblock_paths, include them them to list of selected&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dblock_paths=[...] or set dblock_paths=None to select all: &quot;</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;[&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbp</span> <span class="k">for</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="n">missing_dblocks</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">EpochsMkh5ColumnNameError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;non-existent epochs_id or time column in the epochs table</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> column error </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, check&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">.columns&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">EpochsMkh5NonZeroTimestamps</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;values in mkh5 timestamp column vary or differ from the timelock=value</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> time column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> has&quot;</span>
            <span class="s2">&quot;non-zero timestamps. MNE epochs, (tmin, tmax) are defined relative&quot;</span>
            <span class="s2">&quot;to the timelock event at time=0. Inspect the epochs table in&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> with mkh5.mkh5.get_epochs_table(</span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="s2">&quot; to locate the discrepant timestamps. If the mkh5 event table&quot;</span>
            <span class="s2">&quot; is overgenerating match_time events with non-zero time-stamps,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; prune the rows with non-zero timesamps in </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">, and set&quot;</span>
            <span class="s2">&quot;the epochs with the new event table mkh5.mkh5.set_epochs(event_table).&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Apparatus YAML file</span>
<span class="k">class</span> <span class="nc">ApparatusYamlFileError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;yaml file didn&#39;t open for any reason</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> check file name, path, and permissions&quot;</span><span class="p">,)</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># MNE structure exceptions</span>
<span class="k">class</span> <span class="nc">Mkh5DblockInfoMismatch</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised if MNE info structures differ, e.g., across mkh5 dblocks</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_1</span><span class="p">,</span> <span class="n">msg_2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_1</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg_2</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Mkh5DblockMontageMismatch</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raised if MNE montage structures differ, e.g., across mkh5 dblocks</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_1</span><span class="p">,</span> <span class="n">msg_2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_1</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg_2</span><span class="p">,)</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># private-ish helpers</span>
<span class="k">def</span> <span class="nf">_check_package_versions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;guard the MNE and mkh5 version for compatible header -&gt; info, montage&quot;&quot;&quot;</span>

    <span class="n">ver_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;M&gt;\d+)\.(?P&lt;N&gt;\d+)\.(?P&lt;P&gt;){0,1}.*$&quot;</span><span class="p">)</span>

    <span class="n">mne_ver</span> <span class="o">=</span> <span class="n">ver_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">mne</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mne_ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">mne_ver</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MNE_MIN_VER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mne_ver</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MNE_MIN_VER</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE </span><span class="si">{</span><span class="n">mne</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> must be &gt;= </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MNE_MIN_VER</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">mkh5_ver</span> <span class="o">=</span> <span class="n">ver_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">mkh5</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mkh5_ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">mkh5_ver</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MKH5_MIN_VER</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;mkpy.mkh5 version </span><span class="si">{</span><span class="n">mkh5</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> must be &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&gt;= </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MKH5_MIN_VER</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_mkh5_event_channel</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check channel is stim or misc with integer-like events&quot;&quot;&quot;</span>

    <span class="n">event_channel_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">chan_idxs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">event_channel_types</span><span class="p">)</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">])[</span><span class="n">chan_idxs</span><span class="p">]:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> must be type: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">event_channel_types</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">mne_raw</span><span class="p">[</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">==</span> <span class="n">mne_raw</span><span class="p">[</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> data does look like integer event codes&quot;</span>
        <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="kn">from</span> <span class="nn">exc</span>


<span class="k">def</span> <span class="nf">_check_api_params</span><span class="p">(</span><span class="n">_class</span><span class="p">,</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;screen mkh5_f, dblock paths and epoch names prior to processing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _class : Mkh5Raw</span>

<span class="sd">    mkh5_f : str</span>
<span class="sd">        path to mkh5 file</span>

<span class="sd">    **kwargs</span>
<span class="sd">        see module KEYWARGS</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># mne and mkh5</span>
    <span class="n">_check_package_versions</span><span class="p">()</span>

    <span class="c1"># API feeds parameters to the classes, user actions cannot</span>
    <span class="c1"># make the assertions fail</span>
    <span class="c1"># assert _class in [Mkh5Raw, EpochsMkh5], \</span>
    <span class="k">assert</span> <span class="n">_class</span> <span class="ow">is</span> <span class="n">Mkh5Raw</span><span class="p">,</span> <span class="s2">&quot;_check_api_params _class must be Mkh5Raw&quot;</span>

    <span class="c1"># set the module kwargs for the input class Mkh5Raw # or EpochsMkh5</span>
    <span class="n">module_kwargs</span> <span class="o">=</span> <span class="n">KWARGS</span>
    <span class="c1"># if _class == EpochsMkh5:</span>
    <span class="c1">#     module_kwargs.update(**EPOCHS_KWARGS)</span>

    <span class="c1"># screen input for illegal keys</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown keyword &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># fill in missing keyword params, if any, with module defaults</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">module_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># now have a full set of module kwargs with input values or defaults</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;mkh5 must be a path to an mkpy.mkh5 HDF5 file&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># verbose</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VERBOSE_LEVELS</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;verbose=</span><span class="si">{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> level must be: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">VERBOSE_LEVELS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># arg: mkh5 file and dblock check</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> not found, check file path and name&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5FileAccessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># this must work</span>
    <span class="n">h5_data</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>

    <span class="c1"># e.g., dblock_paths=[&quot;group/dblock_0&quot;, &quot;group/dblock_1&quot;, ...]  or all</span>
    <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;set dblock_paths=[...], else very slow&quot;</span>
    <span class="n">kw_dblock_paths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw_dblock_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dbp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="n">kw_dblock_paths</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;dblock_paths=</span><span class="si">{</span><span class="n">kw_dblock_paths</span><span class="si">}</span><span class="s2"> must be a list of strings&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">h5_dblock_paths</span> <span class="o">=</span> <span class="n">h5_data</span><span class="o">.</span><span class="n">dblock_paths</span>
    <span class="k">for</span> <span class="n">kw_dbp</span> <span class="ow">in</span> <span class="n">kw_dblock_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kw_dbp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5_dblock_paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kw_dbp</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">mkh5_f</span><span class="si">}</span><span class="s2"> ... check for typos and initial /&quot;</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># garv annotations</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;garv_annotations&quot;</span><span class="p">]:</span>
        <span class="n">garv_anns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;garv_annotations&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">garv_anns</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;garv_annotations must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">garv_anns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">GARV_ANNOTATION_KEYS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;garv_annotations keys must be </span><span class="si">{</span><span class="n">GARV_ANNOTATION_KEYS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">garv_anns</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;garv annotation units must be &#39;ms&#39; or &#39;s&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">t_scale</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="k">if</span> <span class="n">garv_anns</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ms&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="c1"># let python raise TypeError for non-numerical values</span>
        <span class="n">garv_start</span> <span class="o">=</span> <span class="n">garv_anns</span><span class="p">[</span><span class="s2">&quot;tmin&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">t_scale</span>
        <span class="n">garv_stop</span> <span class="o">=</span> <span class="n">garv_anns</span><span class="p">[</span><span class="s2">&quot;tmax&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">t_scale</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">garv_start</span> <span class="o">&lt;</span> <span class="n">garv_stop</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;garv interval must have the start &lt; stop&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># info and montage toggles</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fail_on_info&quot;</span><span class="p">,</span> <span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2"> must be True or False&quot;</span><span class="p">)</span>

        <span class="c1"># turning off montage checking for epochs is risky</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;setting fail_on_montage=False disables MNE montage &quot;</span>
                <span class="s2">&quot;verification accross mkh5 data blocks, the MNE sensor &quot;</span>
                <span class="s2">&quot;locations may be wrong and MNE epoch conversion may fail&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># optional apparatus yaml</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">apparatus_yaml</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">apparatus_yaml</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ApparatusYamlFileError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignore_keys&quot;</span><span class="p">]:</span>
        <span class="n">ignore_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignore_keys&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ignore_keys must be a list of strings, not </span><span class="si">{</span><span class="n">ignore_keys</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">fail</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># # DEPRECATE? EpochsMkh5 kwargs</span>
    <span class="c1"># if _class == EpochsMkh5:</span>

    <span class="c1">#     epochs_name = kwargs[&quot;epochs_name&quot;]</span>

    <span class="c1">#     # catches non-strings including epochs_name=None</span>
    <span class="c1">#     if not isinstance(epochs_name, str):</span>
    <span class="c1">#         msg = f&quot;epochs_name={epochs_name} must be a character string&quot;</span>
    <span class="c1">#         raise TypeError(msg)</span>

    <span class="c1">#     # check the epochs table h5 object exists</span>
    <span class="c1">#     if epochs_name not in h5.epochs_names:</span>
    <span class="c1">#         raise EpochsMkh5EpochsNameError(mkh5_f, epochs_name)</span>

    <span class="c1">#     # ok to set column names here</span>
    <span class="c1">#     epochs_table = h5.get_epochs_table(epochs_name)</span>

    <span class="c1">#     # shouldn&#39;t fail unless the the mkh5 file is tampered with</span>
    <span class="c1">#     assert all([dbp in all_dblock_paths for dbp in epochs_table.dblock_path])</span>

    <span class="c1">#     # check epochs_id, time cols exist</span>
    <span class="c1">#     for test_param in [&quot;epoch_id&quot;, &quot;time&quot;]:</span>
    <span class="c1">#         col_name = kwargs[test_param]</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             epochs_table[col_name]</span>
    <span class="c1">#         except Exception:</span>
    <span class="c1">#             raise EpochsMkh5ColumnNameError(mkh5_f, epochs_name, col_name)</span>

    <span class="c1">#     # this value is critical for correctly cacluating the</span>
    <span class="c1">#     # MNE fixed-interval epoch with tmin, tmax</span>
    <span class="c1">#     if not all(epochs_table[kwargs[&quot;time&quot;]] == 0):</span>
    <span class="c1">#         raise EpochsMkh5NonZeroTimestamps(mkh5, epochs_name)</span>

    <span class="c1"># full set of checked kwargs for _class Mkh5Raw or EpochsMkh5</span>
    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_is_equal_mne_info</span><span class="p">(</span><span class="n">info_a</span><span class="p">,</span> <span class="n">info_b</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;compare two mne.Info key, value instances for same content</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    info_a, info_b : mne.Info</span>
<span class="sd">       as instantiated, e.g., by mne.create_info(...)</span>

<span class="sd">    exclude : list of str, optional</span>
<span class="sd">       list of mne.Info.keys() to skip when testing, e.g. &quot;meas_id&quot;,</span>
<span class="sd">       &quot;file_id&quot; which change file_id timestamps with .fif saves.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool:</span>
<span class="sd">       True if info structure contets are the same to within</span>
<span class="sd">       floating-point precision, False otherwise.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    verbose=True reports the key, values that differ.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">test_keys_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_a</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">test_keys_b</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_b</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_keys_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_keys_b</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;info_a and info_b have different keys&quot;</span><span class="p">)</span>

    <span class="c1"># collect bad keys for verbose reporting</span>
    <span class="n">good_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># whitelist the values that test the same</span>
    <span class="n">bad_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># blacklist mismatches</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">test_keys_a</span><span class="p">:</span>
        <span class="n">val_a</span> <span class="o">=</span> <span class="n">info_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">val_b</span> <span class="o">=</span> <span class="n">info_b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># most info values hash test fine</span>
        <span class="k">if</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_a</span><span class="p">)</span> <span class="o">==</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_b</span><span class="p">):</span>
            <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># dig and chan need special handling</span>
        <span class="c1"># and now custom_ref_applied as of MNE 0.23 which is a mne named type</span>
        <span class="c1"># when created in the mne.Raw.info but comes back as type int</span>
        <span class="c1"># with mne.read_raw_fif so == is OK but object_hash fails</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dig&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_ref_applied&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val_a</span> <span class="o">==</span> <span class="n">val_b</span>
                <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;chs&quot;</span><span class="p">:</span>
            <span class="c1"># assert all vals are equal or close,</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chdx</span><span class="p">,</span> <span class="n">ch_a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_a</span><span class="p">):</span>
                    <span class="n">ch_b</span> <span class="o">=</span> <span class="n">val_b</span><span class="p">[</span><span class="n">chdx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key_aa</span><span class="p">,</span> <span class="n">val_aa</span> <span class="ow">in</span> <span class="n">ch_a</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">val_bb</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">[</span><span class="n">key_aa</span><span class="p">]</span>
                        <span class="c1">#  np.allclose b.c. .fif save float precision may</span>
                        <span class="c1"># tinker with info[&quot;chs&quot;][i][&quot;loc&quot;] values</span>
                        <span class="k">assert</span> <span class="n">object_hash</span><span class="p">(</span><span class="n">val_bb</span><span class="p">)</span> <span class="o">==</span> <span class="n">object_hash</span><span class="p">(</span>
                            <span class="n">val_aa</span>
                        <span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val_aa</span><span class="p">,</span> <span class="n">val_bb</span><span class="p">)</span>
                <span class="n">good_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># print(f&quot;good_keys {good_keys} excluded {exclude}&quot;)</span>
    <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">good_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_keys_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_keys_b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bad_keys</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;info_a[&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;]: </span><span class="si">{</span><span class="n">info_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;info_b[&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;]: </span><span class="si">{</span><span class="n">info_b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_is_equal_mne_montage</span><span class="p">(</span><span class="n">montage_a</span><span class="p">,</span> <span class="n">montage_b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;compare two mne montages for identity&quot;&quot;&quot;</span>

    <span class="c1"># fall through for msgs when verbose=True</span>
    <span class="n">attrs_a</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">montage_a</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">attrs_b</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">montage_b</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs_a</span> <span class="o">==</span> <span class="n">attrs_b</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;montage attributes differ: </span><span class="si">{</span><span class="n">attrs_a</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">attrs_b</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># report the mismatches</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_a</span><span class="p">:</span>
        <span class="n">val_a</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">montage_a</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">val_b</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">montage_b</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_a</span> <span class="o">!=</span> <span class="n">val_b</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mismatch </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">val_a</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">val_b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_check_info_montage_across_dblocks</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check hdr, dblocks in mkh5_f return the same MNE info and montage</span>

<span class="sd">    The default behavior for info mismatches is to issue a warning</span>
<span class="sd">    since discrepant structures arise whenever multiple crws are</span>
<span class="sd">    combined in a single mkh5 file, e.g., for separate cal files, split</span>
<span class="sd">    sessions, and multi-subject experiment files.</span>

<span class="sd">    The default behavior for montage mismatches is to fail since there</span>
<span class="sd">    are very few cases in which it is reasonable to pool data data</span>
<span class="sd">    recorded from different montages in a single analysis. Montages</span>
<span class="sd">    that very across datablocks in an mkh5 file are most likely</span>
<span class="sd">    attributable to using discrepant .yhdr apparatus maps when the</span>
<span class="sd">    mkh5 file was converted from .crw/.log. In this case the remedy is</span>
<span class="sd">    to correct the .yhdr files and rebuild the mkh5 file.  Montage</span>
<span class="sd">    differences make MNE spatial visualization and data analysis</span>
<span class="sd">    unreliable and montage failures should be allowed with extreme</span>
<span class="sd">    caution in unusual circumstances.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_f: str</span>
<span class="sd">        file path to mkpy.mkh5 file</span>
<span class="sd">    ignore_keys : list of str or None (default)</span>
<span class="sd">        differences between the values of these info keys are ignored even</span>
<span class="sd">        when fail_on_info=True, see IGNORE_INFO_KEYS. Default None</span>
<span class="sd">    dblock_paths: {list of str, None}, optional</span>
<span class="sd">        as returned by mkh5.mkh5(mkh5_f).dblock_paths</span>
<span class="sd">        do not check the keys in the list, the default values</span>
<span class="sd">        typically vary across mkh5 dblocks</span>
<span class="sd">    apparatus_yaml: str</span>
<span class="sd">        file path to a YAML file containing exactly one mkpy.mkh5</span>
<span class="sd">        apparatus format YAML doc, such as a .yhdr</span>
<span class="sd">    fail_on_info: bool {False}, optional</span>
<span class="sd">        whether to fail on mismatching MNE info structures,</span>
<span class="sd">        default=False</span>
<span class="sd">    fail_on_montage: bool {True}, optional</span>
<span class="sd">        whether to fail on mismatching MNE montage structures,</span>
<span class="sd">        default=True</span>
<span class="sd">    verbose: str {&quot;info&quot;, &quot;critical&quot;, &quot;error&quot;, &quot;warning&quot;, &quot;debug&quot;, &quot;notset&quot;}</span>
<span class="sd">        level of python logging reporting</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignore_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># clunky but clear ...</span>
    <span class="n">dblock_paths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dblock_paths&quot;</span><span class="p">]</span>
    <span class="n">apparatus_yaml</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;apparatus_yaml&quot;</span><span class="p">]</span>
    <span class="n">fail_on_info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_info&quot;</span><span class="p">]</span>
    <span class="n">fail_on_montage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fail_on_montage&quot;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fail_on_info</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>  <span class="c1"># fail informatively</span>

    <span class="n">h5data</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>

    <span class="c1"># enforce explicit dblock_paths kwarg</span>
    <span class="k">assert</span> <span class="n">dblock_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;set dblock_paths kwarg, else too slow&quot;</span>

    <span class="c1"># check pairwise against first</span>
    <span class="n">dbp_i</span> <span class="o">=</span> <span class="n">dblock_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hdr_i</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">h5data</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp_i</span><span class="p">)</span>
    <span class="n">info_i</span><span class="p">,</span> <span class="n">montage_i</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span>
        <span class="n">hdr_i</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">dbp_j</span> <span class="ow">in</span> <span class="n">dblock_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checking info, montage </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">hdr_j</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">h5data</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp_j</span><span class="p">)</span>
        <span class="n">info_j</span><span class="p">,</span> <span class="n">montage_j</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span>
            <span class="n">hdr_j</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span>
        <span class="p">)</span>
        <span class="c1"># info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_equal_mne_info</span><span class="p">(</span><span class="n">info_i</span><span class="p">,</span> <span class="n">info_j</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fail_on_info</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Mkh5DblockInfoMismatch</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info_i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_j</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE info differs: </span><span class="si">{</span><span class="n">dbp_i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">info_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">info_j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># montage</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_equal_mne_montage</span><span class="p">(</span><span class="n">montage_i</span><span class="p">,</span> <span class="n">montage_j</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fail_on_montage</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Mkh5DblockMontageMismatch</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">montage_j</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MNE montages differ: </span><span class="si">{</span><span class="n">dbp_i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dbp_j</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">montage_j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_mkh5_mne_epochs_table</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">epochs_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check mkh5 event_table event code data agrees with mne.Raw channel data&quot;&quot;&quot;</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">epochs_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;mne.Raw event channel </span><span class="si">{epochs_name}</span><span class="s2"> not found, make sure&quot;</span>
            <span class="s2">&quot; it is an epochs table name in the mkh5 file&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">epochs_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{epochs_name}</span><span class="s2"> is not an mne stim channel type, make sure this&quot;</span>
            <span class="s2">&quot; mne.Raw was converted from mkh5 with mkh5mne.read_raw()&quot;</span>
        <span class="p">)</span>

    <span class="c1"># mkpy epochs allow one-many event tags, MNE metadata</span>
    <span class="c1"># must be 1-1 with mne.Raw[&quot;event_channel} events: [sample, 0, event]</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="n">epochs_table</span><span class="p">[</span><span class="n">epochs_table</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="s2">&quot;mne_raw_tick&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;mkh5 epochs </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> cannot be used as&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; mne.Epoch.metadata, duplicate mne_raw_tick: </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># check channel data at mne tick agrees with epoch table</span>
    <span class="n">check_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">epochs_table</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">check_cols</span><span class="p">:</span>
        <span class="n">mne_col</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">epochs_table</span><span class="p">[</span><span class="s2">&quot;mne_raw_tick&quot;</span><span class="p">]]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">epochs_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">epochs_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mne_col</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;mkh5 epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">[&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;] does not match&quot;</span>
                <span class="s2">&quot; mne.Raw data at these mne_raw_tick:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;epochs_table[</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; mne.Raw[</span><span class="si">{</span><span class="n">col</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;mne_raw_tick&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="nb">int</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;mne_raw_tick&#39;</span><span class="p">])]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># non-zero events on the named &quot;event&quot; channel must be 1-1</span>
    <span class="c1"># with tagged events from mkh5 in the same-named epochs table</span>
    <span class="n">mne_raw_epoch_events</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">mkh5_epoch_events</span> <span class="o">=</span> <span class="n">epochs_table</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span>
    <span class="n">n_raw_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mne_raw_epoch_events</span><span class="p">)</span>
    <span class="n">n_epoch_table_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mkh5_epoch_events</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">mne_raw_epoch_events</span> <span class="o">==</span> <span class="n">mkh5_epoch_events</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The sequence of non-zero log_evcodes on channel&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; mne.Raw[</span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">] (n=</span><span class="si">{</span><span class="n">n_raw_events</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; must match the sequence of log_evcodes in the&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; mkpy epochs table </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="n">n_epoch_table_events</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Mkh5Raw</span><span class="p">(</span><span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BaseRaw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raw MNE compatible object from mkpy.mkh5 HDF5 data file</span>

<span class="sd">    This class is not meant to be instantiated directly, use</span>
<span class="sd">    :py:func:`mkh5mne.from_mkh5` and see those docs.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mkh5_f</span><span class="p">,</span>
        <span class="n">garv_annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dblock_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fail_on_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fail_on_montage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_keys</span> <span class="o">=</span> <span class="n">IGNORE_INFO_KEYS</span>

        <span class="k">if</span> <span class="n">dblock_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;looking up data block paths, larger files take longer ...&quot;</span><span class="p">)</span>
            <span class="n">dblock_paths</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">dblock_paths</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

        <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">_check_api_params</span><span class="p">(</span>
            <span class="n">Mkh5Raw</span><span class="p">,</span>
            <span class="n">mkh5_f</span><span class="p">,</span>
            <span class="n">dblock_paths</span><span class="o">=</span><span class="n">dblock_paths</span><span class="p">,</span>
            <span class="n">garv_annotations</span><span class="o">=</span><span class="n">garv_annotations</span><span class="p">,</span>
            <span class="n">fail_on_info</span><span class="o">=</span><span class="n">fail_on_info</span><span class="p">,</span>
            <span class="n">fail_on_montage</span><span class="o">=</span><span class="n">fail_on_montage</span><span class="p">,</span>
            <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">ignore_keys</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_check_info_montage_across_dblocks</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># mkh5 block are converted to self contained mne.RawArray and MNE</span>
        <span class="c1"># does the bookeeping for concatenting the RawArrays. Not future</span>
        <span class="c1"># proof but perhaps more future resistant.</span>
        <span class="n">raw_dblocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mne_ditis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">raw_samp_n</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># track accumulated samples across data blocks</span>
        <span class="k">for</span> <span class="n">dbpi</span><span class="p">,</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dblock_paths</span><span class="p">):</span>

            <span class="c1"># raw_dblock is an instance of mne.Raw, db_epts is a dic with keys in</span>
            <span class="c1"># epoch_names and vals = the mkh5 epochs table dataframe row sliced</span>
            <span class="c1"># for this data block path.</span>
            <span class="n">raw_dblock</span><span class="p">,</span> <span class="n">db_epts</span> <span class="o">=</span> <span class="n">_dblock_to_raw</span><span class="p">(</span>
                <span class="n">mkh5_f</span><span class="p">,</span>
                <span class="n">dbp</span><span class="p">,</span>
                <span class="n">garv_annotations</span><span class="o">=</span><span class="n">garv_annotations</span><span class="p">,</span>
                <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># the data</span>
            <span class="n">raw_dblocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)</span>

            <span class="c1"># reassemble mkh5 epochs_tables</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">db_epts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">diti</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># pd.DataFrame.copy()</span>

                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">diti</span><span class="p">[</span><span class="s2">&quot;dblock_path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dbp</span><span class="p">)</span>
                <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;mne_dblock_path_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbpi</span>

                <span class="c1"># compute sample index into the mne.Raw data stream from the</span>
                <span class="c1"># the length thus far + dblock_tick offset (0-base)</span>
                <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;mne_raw_tick&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_samp_n</span> <span class="o">+</span> <span class="n">diti</span><span class="p">[</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mne_ditis</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># start a new table w/ mne raw ticks counting from 0</span>
                    <span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">diti</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># continue an existing table</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">diti</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="c1"># mne_ditis[key] = mne_ditis[key].append(diti)  # append is deprecated</span>
                    <span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mne_ditis</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">diti</span><span class="p">])</span>

            <span class="n">raw_samp_n</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)</span>

        <span class="c1"># assemble RawArrays</span>
        <span class="n">mne_raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">concatenate_raws</span><span class="p">(</span><span class="n">raw_dblocks</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># convert epochs table dataframes to dicts for JSONification</span>
        <span class="k">for</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">epochs_table</span> <span class="ow">in</span> <span class="n">mne_ditis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">_check_mkh5_mne_epochs_table</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">epochs_table</span><span class="p">)</span>
            <span class="n">mne_ditis</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochs_table</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># look up mkh5 file format version</span>
        <span class="n">mkh5_f_version</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dbp</span> <span class="ow">in</span> <span class="n">dblock_paths</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dbp</span><span class="p">,</span> <span class="n">dblock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mkh5_f_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;mkh5_version&quot;</span><span class="p">])</span>

        <span class="c1"># should be OK unless tampered with</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mkh5_f_version</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;mkh5 file versions cannot vary across dblocks&quot;</span>

        <span class="c1"># epochs_table tagged event info really belongs attached to</span>
        <span class="c1"># the raw, e.g., raw._ditis map of ditis but mne.Raw doesn&#39;t</span>
        <span class="c1"># allow it.</span>

        <span class="c1"># info[&quot;description&quot;] = json.dumps({&quot;mkh5_epoch_tables&quot;: mne_ditis})</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mkh5_epoch_tables&quot;</span><span class="p">:</span> <span class="n">mne_ditis</span><span class="p">,</span>
                <span class="s2">&quot;mkh5_file_version&quot;</span><span class="p">:</span> <span class="n">mkh5_f_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;mkh5mne_version&quot;</span><span class="p">:</span> <span class="n">__MKH5MNE_VERSION__</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># event and eeg datastreams numpy array</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">filenames</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)],</span>
            <span class="c1"># orig_format=&#39;single&#39;,</span>
        <span class="p">)</span>

        <span class="c1"># collect boundaries, log_evcodes, and optional garv intervals</span>
        <span class="c1"># marked by concatenate_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>

        <span class="c1"># or average?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeg_reference</span><span class="p">(</span>
            <span class="n">ref_channels</span><span class="o">=</span><span class="p">[],</span> <span class="n">projection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span>  <span class="c1"># &quot;average&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_segment_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we know how to save as fif, hand off reading to MNE&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_read_segment_file() ... save Mkh5Raw as a .fif and &quot;</span>
            <span class="s2">&quot;  read with mne.io.Raw()&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># file loader for optional apparatus yaml</span>
<span class="k">def</span> <span class="nf">_load_apparatus_yaml</span><span class="p">(</span><span class="n">apparatus_yaml_f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;slurp apparatus info and return the dict or die</span>

<span class="sd">    The file is screened for a unique YAML doc with name: apparatus</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    apparatus_yaml_f: str</span>
<span class="sd">        filepath to yaml</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">       contains name: apparatus, contents are validated as for</span>
<span class="sd">       native mkh5 header apparatus dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">apparatus_yaml_f</span><span class="p">)</span> <span class="k">as</span> <span class="n">apparatus_stream</span><span class="p">:</span>
        <span class="n">yaml_docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load_all</span><span class="p">(</span><span class="n">apparatus_stream</span><span class="p">))</span>
        <span class="n">apparatus_hdrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">yaml_doc</span>
            <span class="k">for</span> <span class="n">yaml_doc</span> <span class="ow">in</span> <span class="n">yaml_docs</span>
            <span class="k">if</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">yaml_doc</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;apparatus&quot;</span><span class="p">}</span>
        <span class="p">]</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apparatus_hdrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no apparatus document&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apparatus_hdrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;multiple apparatus documents&quot;</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; in </span><span class="si">{</span><span class="n">apparatus_yaml_f</span><span class="si">}</span><span class="s2">, there must be exactly one &quot;</span>
                <span class="s2">&quot;YAML doc with name: apparatus&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">yaml_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># .yhdr header functions used by Mkh5Raw and EpochsMkh5</span>
<span class="k">def</span> <span class="nf">_validate_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check the mkh5 header key: vals for _parse_header_for_mne</span>

<span class="sd">    Exception messages report the data block, missing keys and</span>
<span class="sd">    wrong values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hdr : dict</span>
<span class="sd">       mkpy.mkh5 dblock header as returned by mkh5.get_dblock()</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Mkh5HeaderKeyError</span>
<span class="sd">       if header is missing a key needed for MNE import</span>
<span class="sd">    Mkh5HeaderValueError</span>
<span class="sd">       if value is wrong for MNE import</span>
<span class="sd">     Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Required Keys</span>

<span class="sd">       The header must have</span>
<span class="sd">         h5_dataset: &lt;str&gt;</span>
<span class="sd">         samplerate: &lt;int|float&gt;</span>
<span class="sd">         and apparatus: &lt;map&gt;</span>

<span class="sd">       The apparatus must have these maps:</span>
<span class="sd">          common_ref: str</span>
<span class="sd">          space: map</span>
<span class="sd">          fiducials: map</span>
<span class="sd">          streams: map</span>
<span class="sd">          sensors: map</span>
<span class="sd">       The apparatus streams must have mne_type: &lt;str&gt; pos: &lt;str&gt; neg: &lt;str&gt;</span>
<span class="sd">       The apparatus sensors must have x: &lt;float&gt; y: &lt;float&gt; z: &lt;float&gt;</span>

<span class="sd">     Required Values</span>
<span class="sd">       The h5_dataset string must be a conforming dblock_N mkh5 data block HDF5 path.</span>
<span class="sd">       The sample rate must be an inter or float.</span>
<span class="sd">       The apparatus streams mne_type must be a legal MNE channel</span>
<span class="sd">      type: eeg, eog, stim, misc, ...</span>
<span class="sd">       The apparatus streams pos (= sensor/electrode on +pinout of</span>
<span class="sd">      bioamp) must be one of the apparatus sensor keys to provide</span>
<span class="sd">      the 3D coordinates.</span>
<span class="sd">       The apparatus sensor coordinates must be numeric.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># these key: vals are built in by mkh5, check anyway</span>
    <span class="k">if</span> <span class="s2">&quot;h5_dataset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;header is missing required key: h5_dataset&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">dblock_path_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\S+/(dblock_\d+)</span><span class="si">{1}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dblock_path_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;header[&#39;h5_dataset&#39;] does not look like a dblock path: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># used for error messages</span>
    <span class="n">dblock_path</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;h5_dataset&quot;</span><span class="p">]</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># header must have a samplerate</span>
    <span class="k">if</span> <span class="s2">&quot;samplerate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;header has no samplerate key&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;header samplerate must be numeric (integer or float)&quot;</span>
        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;hdr&quot;</span><span class="p">,</span> <span class="s2">&quot;samplerate&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># sfreq = hdr[&quot;samplerate&quot;]</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># these key: vals are user specified YAML, anything can happen.</span>

    <span class="c1"># there must be an apparatus map</span>
    <span class="k">if</span> <span class="s2">&quot;apparatus&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;apparatus map not found&quot;</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># apparatus must have stream, sensor, fiducial, common_ref  maps</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">,</span> <span class="s2">&quot;sensors&quot;</span><span class="p">,</span> <span class="s2">&quot;fiducials&quot;</span><span class="p">,</span> <span class="s2">&quot;common_ref&quot;</span><span class="p">,</span> <span class="s2">&quot;space&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> map not found&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">space</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">,</span>
        <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;ras&quot;</span><span class="p">,</span>
        <span class="s2">&quot;distance_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="s2">&quot;mm&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">hdr_space</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;apparatus/space&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr_space</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus space map must include </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

        <span class="c1"># check units for scaling to MNE meters:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;distance_unit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hdr_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus space map </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> must be one of these: </span><span class="si">{</span><span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">hdr_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus space map must include </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">hdr_space</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># collect sensor/electrode labels, these vary by experiment</span>
    <span class="n">hdr_sensors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;sensors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># common reference electrode must be among known sensors</span>
    <span class="k">if</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;common_ref&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr_sensors</span><span class="p">:</span>
        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;/apparatus/common_ref&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;apparatus common_ref value must&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;be one of these: &lt;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr_sensors</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># check string values</span>
    <span class="n">hdr_mne_stream_key_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mne_type&quot;</span><span class="p">:</span> <span class="n">MNE_STREAM_TYPES</span><span class="p">,</span>  <span class="c1"># eeg, eog, stim, misc, ...</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">hdr_sensors</span><span class="p">,</span>  <span class="c1"># these provide the 3D coordinates</span>
        <span class="s2">&quot;neg&quot;</span><span class="p">:</span> <span class="n">hdr_sensors</span><span class="p">,</span>  <span class="c1"># these provide the 3D coordinates</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">stream</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;streams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apparatus/streams/</span><span class="si">{</span><span class="n">stream</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># check the mne_type, pos, neg keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hdr_mne_stream_key_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;apparatus stream </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found&quot;</span>
                <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

        <span class="c1"># check the values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">hdr_mne_stream_key_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;apparatus stream </span><span class="si">{</span><span class="n">stream</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> value must&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;be one of these: &lt;</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># fiducial keys are lpa, rpa, nasion</span>
    <span class="k">for</span> <span class="n">fid_key</span> <span class="ow">in</span> <span class="n">FIDUCIAL_KEYS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fid_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;fiducials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="s2">&quot;apparatus/fiducials&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;apparatus fiducials (lpa, rpa, nasion) location &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fid_key</span><span class="si">}</span><span class="s2"> not found&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># sensors and fiducials  must have 3D x, y, z keys and numeric values</span>
    <span class="k">for</span> <span class="n">key_3d</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sensors&quot;</span><span class="p">,</span> <span class="s2">&quot;fiducials&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="n">key_3d</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># sub_hdr = {&quot;apparatus&quot;: {key_3d: {key: val}}}</span>
            <span class="n">sub_hdr</span> <span class="o">=</span> <span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;apparatus/</span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> 3D x,y,z &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;coordinate axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> not found&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">Mkh5HeaderKeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;apparatus </span><span class="si">{</span><span class="n">key_3d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> coordinate &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> must be a numeric value&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">Mkh5HeaderValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">,</span> <span class="n">sub_hdr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert mkh5 header info for use in MNE dig montage and info</span>

<span class="sd">    The user-specified hdr[&quot;apparatus&quot;][&quot;streams][&quot;mne_type&quot;] values from the</span>
<span class="sd">    the YAML .yhdr are used, all the rest of the data block columns are</span>
<span class="sd">    assigned MNE type &quot;misc&quot;.</span>

<span class="sd">    All 3D cartesian soordinates are scaled to MNE-native meters based</span>
<span class="sd">    on header units: m, cm, mm.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    hdr : dict</span>
<span class="sd">       as returned hdr, dblock = ``mkh5.get_dblock()``</span>

<span class="sd">    dblock : np.ndarray</span>
<span class="sd">       as returned hdr, dblock = ``mkh5.get_dblock()``</span>

<span class="sd">    apparatus_yaml : {None, str}, optional</span>
<span class="sd">       filepath to YAML file alternate stream and sensor information.</span>
<span class="sd">       Format requirements are the same as for the mkh5 header</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results: dict</span>
<span class="sd">        keys, values for MNE montage, create_info, and</span>
<span class="sd">         set_eeg_reference methods `sfreq`, `set_ref_ch_type`,</span>
<span class="sd">         `set_ref_channels`, `ch_labels`, `ch_types`, `dig_ch_pos`</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Validation is done in _validate_hdr_for_mne, this just collects</span>
<span class="sd">    and formats the header data.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># apparatus streams are user YAML w/ mne_type, typically</span>
    <span class="c1"># a subset of the hdr[&quot;streams&quot;] which includes clock ticks,</span>
    <span class="c1"># and events</span>

    <span class="c1"># optionally update native mkh5 hdr apparatus</span>
    <span class="k">if</span> <span class="n">apparatus_yaml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_load_apparatus_yaml</span><span class="p">(</span><span class="n">apparatus_yaml</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Overriding </span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with sensor locations&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; from </span><span class="si">{</span><span class="n">apparatus_yaml</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">_validate_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="n">apparatus_streams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;streams&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>

    <span class="c1"># sensors (=electrodes) are physical objects in 3-space</span>
    <span class="n">apparatus_sensors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;sensors&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">)</span>

    <span class="c1"># since eeg data streams don&#39;t have a &quot;location&quot; use</span>
    <span class="c1"># coordinates from the positive pinout electrode</span>
    <span class="n">apparatus_streams</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apparatus_sensors</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">)</span>

    <span class="c1"># collect the fiducials</span>
    <span class="n">apparatus_fiducials</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;fiducials&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;fiducial&quot;</span><span class="p">)</span>

    <span class="c1"># collect the coordinate space</span>
    <span class="n">space</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;space&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>

    <span class="c1"># m, cm, mm units are guarded in _validate_hdr_for_mne</span>
    <span class="n">yhdr_units_scaled_by</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;space&quot;</span><span class="p">][</span><span class="s2">&quot;distance_unit&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
        <span class="n">yhdr_units_scaled_by</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;cm&quot;</span><span class="p">:</span>
        <span class="n">yhdr_units_scaled_by</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;mm&quot;</span><span class="p">:</span>
        <span class="n">yhdr_units_scaled_by</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">assert</span> <span class="n">yhdr_units_scaled_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;bad distance unit in apparatus space map&quot;</span>
    <span class="n">space</span><span class="p">[</span><span class="s2">&quot;space&quot;</span><span class="p">][</span><span class="s2">&quot;yhdr_units_scaled_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhdr_units_scaled_by</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># collect the mkpy.mkh5 built-in data block hdr[&quot;streams&quot;],</span>
    <span class="n">hdr_streams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span>
    <span class="p">)</span>

    <span class="c1"># mkh5 built-in hdr[&quot;streams&quot;] align 1-1 with</span>
    <span class="c1"># the dblock data 1-D columns unless tampered with</span>
    <span class="c1"># assert tuple(hdr_streams.index) == dblock.dtype.names</span>

    <span class="c1"># merge in the apparatus stream data</span>
    <span class="n">hdr_streams</span> <span class="o">=</span> <span class="n">hdr_streams</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apparatus_streams</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>

    <span class="c1"># update known mkh5 dblock streams to mne_types</span>
    <span class="n">hdr_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">MKH5_STIM_CHANNELS</span><span class="p">,</span> <span class="s2">&quot;mne_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stim&quot;</span>
    <span class="n">hdr_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">hdr_streams</span><span class="p">[</span><span class="s2">&quot;mne_type&quot;</span><span class="p">]),</span> <span class="s2">&quot;mne_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;misc&quot;</span>

    <span class="c1"># 3D sensor coordinate dicts -&gt; in MNE key: [R, A, S, ... ] in MNE-native meters</span>
    <span class="c1"># fiducial landmarks in MNE label: [x, y, z] in MNE-native meters</span>
    <span class="n">fiducials</span> <span class="o">=</span> <span class="n">apparatus_fiducials</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">yhdr_units_scaled_by</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># for mne.channels.make_dig_montage</span>
    <span class="n">dig_ch_pos</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">yhdr_units_scaled_by</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># for info[&quot;chs&quot;][i][&quot;loc&quot;] = array, shape(12,)</span>
    <span class="c1"># first 3 are positive sensor, next 3 are reference (negative)</span>
    <span class="c1"># but MNE DigMontage chokes on mixed common ref (A1) and biploar</span>
    <span class="c1"># so skip the reference location.</span>

    <span class="c1"># 3D coordinates are MNE-native meters</span>
    <span class="n">info_ch_locs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">chan</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># e.g., A1 for common reference, lhz for bipolar HEOG.</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">apparatus_streams</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="c1"># neg = apparatus_streams.loc[ch, &quot;neg&quot;]   # not used</span>
        <span class="n">pos_locs</span> <span class="o">=</span> <span class="n">apparatus_sensors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">info_ch_locs</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="c1"># [pos_locs, ref_locs, np.zeros((6, ))] # the truth</span>
                <span class="p">[</span><span class="n">pos_locs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,))]</span>  <span class="c1"># what works w/ MNE</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">yhdr_units_scaled_by</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">sfreq</span><span class="o">=</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;samplerate&quot;</span><span class="p">],</span>
        <span class="n">set_ref_ch_type</span><span class="o">=</span><span class="s2">&quot;eeg&quot;</span><span class="p">,</span>
        <span class="n">set_ref_channels</span><span class="o">=</span><span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;apparatus&quot;</span><span class="p">][</span><span class="s2">&quot;common_ref&quot;</span><span class="p">],</span>
        <span class="n">ch_labels</span><span class="o">=</span><span class="n">hdr_streams</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">ch_types</span><span class="o">=</span><span class="n">hdr_streams</span><span class="o">.</span><span class="n">mne_type</span><span class="p">,</span>
        <span class="n">dig_ch_pos</span><span class="o">=</span><span class="n">dig_ch_pos</span><span class="p">,</span>
        <span class="n">info_ch_locs</span><span class="o">=</span><span class="n">info_ch_locs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fiducials</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_patch_dblock_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_mne</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;tune up MNE info with additional mkpy hdr data</span>

<span class="sd">    Most MNE internal values are already set to correct</span>
<span class="sd">    values by create_info and ch_types.</span>

<span class="sd">    global MKH5_EEG_UNIT is the critical EEG scaling factor, so that RawArray</span>
<span class="sd">    data * MKH5_EEG_UNIT set in dblock conversion from native mkh5 uV to the</span>
<span class="sd">    FIFF.FIFF_UNIT_V channel scale set here in the MNE channel info</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># info[&quot;proj_name&quot;] = hdr[&quot;expdesc&quot;]</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;his_id&quot;</span><span class="p">:</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]}</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;device_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]}</span>

    <span class="c1"># dev note:</span>
    <span class="c1"># the mne.io.get_new_fileid(), thefile_id == meas_id looks like this</span>
    <span class="c1"># {</span>
    <span class="c1">#     &#39;machid&#39;: array([808661043, 808661043], dtype=int32),</span>
    <span class="c1">#     &#39;version&#39;: 65540 (FIFFC_VERSION),</span>
    <span class="c1">#     &#39;secs&#39;: 1601769754,</span>
    <span class="c1">#     &#39;usecs&#39;: 514806</span>
    <span class="c1"># }</span>

    <span class="c1"># from mkh5 os.stat_result</span>

    <span class="n">dtime</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;eeg_file_stat&quot;</span><span class="p">][</span><span class="s2">&quot;st_ctime&quot;</span><span class="p">]</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;meas_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="c1"># seed MNE info fields w/ default and update w/ mkh5 datetimes</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">get_new_file_id</span><span class="p">()</span>
    <span class="n">file_id</span><span class="p">[</span><span class="s2">&quot;secs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span>
    <span class="n">file_id</span><span class="p">[</span><span class="s2">&quot;usecs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">dtime</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10e6</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_id</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;meas_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_id</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># CRITICAL: set scaling factor for microvolt data</span>
    <span class="k">for</span> <span class="n">ch_info</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]:</span>
        <span class="n">ch_name</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">]</span>
        <span class="n">is_eeg</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFFV_EEG_CH</span>
        <span class="n">is_eog</span> <span class="o">=</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFFV_EOG_CH</span>
        <span class="k">if</span> <span class="n">is_eeg</span> <span class="ow">or</span> <span class="n">is_eog</span><span class="p">:</span>

            <span class="c1"># update ch locs from parsed hdr[&quot;apparatus&quot;][&quot;sensor&quot;]</span>
            <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;info_ch_locs&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">]</span>

            <span class="c1"># CRITICAL, must be true when MKH5_EEG_UNITS = 1e-6</span>
            <span class="k">assert</span> <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span>

            <span class="c1"># mkh5 data blocks may or may not be calibrated</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="s2">&quot;calibrated&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="ow">and</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">][</span><span class="s2">&quot;calibrated&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;mkh5 data </span><span class="si">{</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;h5_dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2"> is not calibrate&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;setting default mne.info[</span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s2">][&#39;cal&#39;] = 1.0&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;cal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># log A/D cal factor the MNE way</span>
                <span class="n">ch_info</span><span class="p">[</span><span class="s2">&quot;cal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">ch_name</span><span class="p">][</span><span class="s2">&quot;cals&quot;</span><span class="p">][</span><span class="s2">&quot;scale_by&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">info</span>


<span class="c1"># def _check_header_across_dblocks(mkh5_f):</span>
<span class="c1">#     &quot;&quot;&quot;return headers checked for same streams and apparatus across data blocks</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     mkh5_f : str</span>
<span class="c1">#         path to an mkh5 file</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     hdrs : dict</span>
<span class="c1">#         The keys are `dblock_path` (str) as returned in the list of</span>
<span class="c1">#         `mkh5.dblock_paths`. The values are `hdr` (dict) as returned</span>
<span class="c1">#         by hdr, dblock = mkh5.get_dblock().</span>


<span class="c1">#     Raises</span>
<span class="c1">#     ------</span>
<span class="c1">#     Mkh5HeaderError</span>

<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     h5 = mkh5.mkh5(mkh5_f)</span>
<span class="c1">#     dblock_paths = h5.dblock_paths</span>
<span class="c1">#     hdrs = []</span>
<span class="c1">#     mismatch = None</span>
<span class="c1">#     for dblock_path in dblock_paths:</span>
<span class="c1">#         hdr, _ = h5.get_dblock(dblock_path)</span>
<span class="c1">#         _validate_hdr_for_mne(hdr)</span>

<span class="c1">#         # identity is transitive, checking ith vs. first suffices</span>
<span class="c1">#         if len(hdrs) &gt; 0:</span>
<span class="c1">#             if not hdr[&quot;streams&quot;].keys() == hdrs[0][&quot;streams&quot;].keys():</span>
<span class="c1">#                 mismatch = &quot;stream&quot;</span>
<span class="c1">#             if not hdr[&quot;apparatus&quot;] == hdrs[0][&quot;apparatus&quot;]:</span>
<span class="c1">#                 mismatch = &quot;apparatus&quot;</span>
<span class="c1">#             if mismatch:</span>
<span class="c1">#                 msg = (</span>
<span class="c1">#                     f&quot;data block header mismatch header[&#39;{mismatch}&#39;] &quot;</span>
<span class="c1">#                     f&quot;{dblock_paths[0]} {dblock_path}&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#                 raise Mkh5HeaderError(msg)</span>
<span class="c1">#         hdrs.append(hdr)</span>
<span class="c1">#     return dict(zip(dblock_paths, hdrs))</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># general data wrangling</span>
<span class="k">def</span> <span class="nf">_dblock_to_raw</span><span class="p">(</span>
    <span class="n">mkh5_f</span><span class="p">,</span>
    <span class="n">dblock_path</span><span class="p">,</span>
    <span class="n">garv_annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert one mkh5 datablock+header into one mne.RawArray</span>

<span class="sd">    Ingest one mkh5 format data block and return an mne.RawArray</span>
<span class="sd">    populated with enough data and channel information to use mne.viz</span>
<span class="sd">    and the mne.Epochs, mne.Evoked EEG pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dblock_path : str</span>
<span class="sd">       HDF5 slash path to an mkh5 data block which an h5py.Dataset</span>
<span class="sd">    garv_annotations: None or dict</span>
<span class="sd">       event_channel: str, channel name with events to annotate</span>
<span class="sd">       start, stop: float relative to time lock event</span>
<span class="sd">       unit: &quot;ms&quot; or &quot;s&quot;</span>
<span class="sd">    apparatus_yaml: str, optional</span>
<span class="sd">       filepath to YAML apparatus file with stream and sensor space info</span>
<span class="sd">       to override native mkh5 hdr[&quot;apparatus&quot;] if any.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mne.RawArray</span>
<span class="sd">        with channel locations from apparatus_yaml and mkh5 epochs tables</span>
<span class="sd">        JSONified and tucked into the Info[&quot;description&quot;]</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The raw_dblock returned from this can be stacked with</span>
<span class="sd">    mne.concatenate_raws() though MNE behavior is to use first</span>
<span class="sd">    info and just stack the datablocks. epochs metadata is</span>
<span class="sd">    collected and returned per block so the complete record</span>
<span class="sd">    can be tucked into the (one) info object when the dblocks</span>
<span class="sd">    are stacked.</span>

<span class="sd">    The  raw.set_eeg_reference(ref_channels=[]) at the end to block</span>
<span class="sd">    subsequent mne&#39;s default automatic average rereferencing later in</span>
<span class="sd">    the pipeline (sheesh).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h5data</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">dblock_path</span> <span class="ow">in</span> <span class="n">h5data</span><span class="o">.</span><span class="n">dblock_paths</span><span class="p">,</span> <span class="s2">&quot;please report this bug&quot;</span>
        <span class="n">hdr</span><span class="p">,</span> <span class="n">dblock</span> <span class="o">=</span> <span class="n">h5data</span><span class="o">.</span><span class="n">get_dblock</span><span class="p">(</span><span class="n">dblock_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Mkh5DblockPathError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">mkh5_f</span><span class="p">,</span> <span class="n">dblock_path</span><span class="p">)</span>

    <span class="n">info</span><span class="p">,</span> <span class="n">montage</span> <span class="o">=</span> <span class="n">_hdr_dblock_to_info_montage</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">)</span>

    <span class="c1"># mne wants homogenous n_chans x nsamps, so stim, misc ints coerced</span>
    <span class="c1"># to float ... sigh.</span>
    <span class="n">mne_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dblock</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;f8&quot;</span><span class="p">)</span>

    <span class="c1"># slice out and scale mkh5 native uV to mne FIFFV_UNIT_V</span>
    <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dblock</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
        <span class="c1"># true by construction unless tampered with</span>
        <span class="k">assert</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">stream</span>
        <span class="k">assert</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">stream</span><span class="p">][</span><span class="s2">&quot;jdx&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">jdx</span>

        <span class="c1"># CRITICAL ... mkh5 EEG are native uV, MNE are V</span>
        <span class="k">if</span> <span class="s2">&quot;dig_chan&quot;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;streams&quot;</span><span class="p">][</span><span class="n">stream</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]:</span>
            <span class="n">mne_data</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="o">*</span> <span class="n">MKH5_EEG_UNIT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mne_data</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dblock</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span>

    <span class="c1"># create the raw object</span>
    <span class="n">raw_dblock</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">mne_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_montage</span><span class="p">(</span><span class="n">montage</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># add an MNE data column for each epochs_table in the mkh5 file</span>
    <span class="c1">#   - for each one, slice the timelock events at match_time == 0</span>
    <span class="c1">#   - copy the time-locked event code to the epochs column and</span>
    <span class="c1">#     the rest of the epochs tables columns to metadata.</span>

    <span class="n">epochs_table_names</span> <span class="o">=</span> <span class="n">mkh5</span><span class="o">.</span><span class="n">mkh5</span><span class="p">(</span><span class="n">mkh5_f</span><span class="p">)</span><span class="o">.</span><span class="n">get_epochs_table_names</span><span class="p">()</span>
    <span class="n">epochs_table_descr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># returned for mkh5 epoching from MNE Raw</span>

    <span class="n">log_evcodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">raw_dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">]</span>  <span class="c1"># for checking</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epochs_table_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">etn</span> <span class="ow">in</span> <span class="n">epochs_table_names</span><span class="p">:</span>

            <span class="c1"># fetch the epochs_table and slice for this mkh5 data block</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dblock_path</span><span class="si">}</span><span class="s2"> setting mkh5 epochs table </span><span class="si">{</span><span class="n">etn</span><span class="si">}</span><span class="s2"> events and metadata&quot;</span><span class="p">)</span>
            <span class="n">epochs_table</span> <span class="o">=</span> <span class="n">h5data</span><span class="o">.</span><span class="n">get_epochs_table</span><span class="p">(</span><span class="n">etn</span><span class="p">)</span>
            <span class="n">etn_dblock</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">epochs_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;dblock_path == @dblock_path and match_time==0&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># CRITICAL: The mkh5 epoch table indexes HDF5 data by</span>
            <span class="c1"># dblock_path, dblock_tick (row offset), the row sort</span>
            <span class="c1"># order is undefined. MNE squawks if event array</span>
            <span class="c1"># sample indexes are not monotonically increasing.</span>
            <span class="n">etn_dblock</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;dblock_ticks&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># capture epochs table as data frame for later</span>
            <span class="n">epochs_table_descr</span><span class="p">[</span><span class="n">etn</span><span class="p">]</span> <span class="o">=</span> <span class="n">etn_dblock</span>

            <span class="c1"># container for the new column of event codes</span>
            <span class="n">etn_evcodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">raw_dblock</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span>  <span class="c1"># yes, (1, len) b.c. MNE wants chan x time</span>

            <span class="c1"># CRITICAL: copy over log_evcodes at just the epoch event ticks</span>
            <span class="n">etn_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">log_evcodes</span>

            <span class="c1"># true by construction of mkh5 except MNE is dtype float</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">log_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">etn_evcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># clone the log_evcodes to get their MNE info attributes</span>
            <span class="n">etn_event_channel</span> <span class="o">=</span> <span class="n">raw_dblock</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">pick</span><span class="p">([</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">])</span>

            <span class="c1"># rename and hack in the correct scanno, logno in case it matters</span>
            <span class="n">mne</span><span class="o">.</span><span class="n">rename_channels</span><span class="p">(</span><span class="n">etn_event_channel</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">:</span> <span class="n">etn</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scanno&quot;</span><span class="p">,</span> <span class="s2">&quot;logno&quot;</span><span class="p">]:</span>
                <span class="n">etn_event_channel</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="c1"># set the event code data values append the channel and confirm</span>
            <span class="c1"># MNE agrees when asked in its native tongue.</span>
            <span class="n">etn_event_channel</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">etn_evcodes</span>
            <span class="n">raw_dblock</span><span class="o">.</span><span class="n">add_channels</span><span class="p">([</span><span class="n">etn_event_channel</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">raw_dblock</span><span class="p">[</span><span class="s2">&quot;log_evcodes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">raw_dblock</span><span class="p">[</span><span class="n">etn</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">etn_dblock</span><span class="o">.</span><span class="n">dblock_ticks</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># seed the MNE annotations with the data block path at time == 0</span>
    <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span>
        <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">dblock_path</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># add log_evocdes garv annotations, if any. validated in _check_api_params</span>
    <span class="k">if</span> <span class="n">garv_annotations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;annotating garv artifacts </span><span class="si">{</span><span class="n">garv_annotations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bad_garvs</span> <span class="o">=</span> <span class="n">get_garv_bads</span><span class="p">(</span><span class="n">raw_dblock</span><span class="p">,</span> <span class="o">**</span><span class="n">garv_annotations</span><span class="p">)</span>
        <span class="n">raw_dblock</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">raw_dblock</span><span class="o">.</span><span class="n">annotations</span> <span class="o">+</span> <span class="n">bad_garvs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">raw_dblock</span><span class="p">,</span> <span class="n">epochs_table_descr</span>


<span class="k">def</span> <span class="nf">_hdr_dblock_to_info_montage</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;populate MNE structures with mkh5 data&quot;&quot;&quot;</span>

    <span class="n">hdr_mne</span> <span class="o">=</span> <span class="n">_parse_hdr_for_mne</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">apparatus_yaml</span><span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;ch_labels&quot;</span><span class="p">],</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">],</span> <span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;ch_types&quot;</span><span class="p">])</span>

    <span class="n">montage</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">make_dig_montage</span><span class="p">(</span>
        <span class="n">ch_pos</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;dig_ch_pos&quot;</span><span class="p">],</span>
        <span class="n">nasion</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;nasion&quot;</span><span class="p">],</span>
        <span class="n">lpa</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;lpa&quot;</span><span class="p">],</span>
        <span class="n">rpa</span><span class="o">=</span><span class="n">hdr_mne</span><span class="p">[</span><span class="s2">&quot;rpa&quot;</span><span class="p">],</span>
        <span class="n">coord_frame</span><span class="o">=</span><span class="s2">&quot;head&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># MNE began locking Info attrs sometime between 0.23 and 1.0</span>
    <span class="k">with</span> <span class="n">info</span><span class="o">.</span><span class="n">_unlock</span><span class="p">():</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">_patch_dblock_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_mne</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">montage</span>


<span class="k">def</span> <span class="nf">_check_mne_raw_mkh5_epochs</span><span class="p">(</span><span class="n">raw_mkh5</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;this checks epochs in the mkh5&quot;&quot;&quot;</span>

    <span class="n">hint</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot; Check that raw_mkh5 = read_raw_mkh5(your_file.h5, ...) and your mkh5 file &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;was created with myh5.set_epochs(&#39;</span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2">&#39;, event_table, ...) and a &quot;</span>
        <span class="s2">&quot;valid mkh5 format event_table.&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_epochs_tables</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_mkh5</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])[</span>
            <span class="s2">&quot;mkh5_epochs_tables&quot;</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;could not load raw_mkh5.info[&#39;description&#39;] epoch tables JSON data&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">epochs_name</span> <span class="ow">in</span> <span class="n">dbept</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dbept</span> <span class="ow">in</span> <span class="n">json_epochs_tables</span><span class="p">]):</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;raw_mkh5.info does not have any data for </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> epochs. &quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">epochs_name</span> <span class="ow">in</span> <span class="n">dbept</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dbept</span> <span class="ow">in</span> <span class="n">json_epochs_tables</span><span class="p">]):</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;raw_mkh5.info </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> data is missing for one or more data blocks. &quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">epochs_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_mkh5</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">]:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;event channel </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> not found in raw_mkh5.info[&#39;ch_names&#39;], &quot;</span>
            <span class="s2">&quot;no epoch event information. &quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">json_epochs_tables</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># API</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="find_mkh5_events"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.find_mkh5_events">[docs]</a><span class="k">def</span> <span class="nf">find_mkh5_events</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replacement for mne.find_events for mkh5 integer event code channels</span>

<span class="sd">    Finds single-sample positive and negative integer event codes and returns</span>
<span class="sd">    them without modification unlike `mne.find_events()` which switches</span>
<span class="sd">    the sign of negative event codes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : Mkh5Raw or mne.io.Raw object</span>
<span class="sd">        data with the stim channel to search</span>

<span class="sd">    channel_name : str</span>
<span class="sd">       name of the channel to search for non-zero codes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    event_array : np.array</span>
<span class="sd">       Three column MNE format where event_array[idx, :] = [sample, 0, code]</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">       If `channel_name` does not exist.</span>
<span class="sd">    TypeError</span>
<span class="sd">        If `channel_name` is not an MNE &#39;stim&#39; type channel.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; mne_raw = mkh5mne(&quot;sub01.h5&quot;)</span>
<span class="sd">    &gt;&gt;&gt; mne_events = mkh5mne.find_mkh5_events(mne_raw, &quot;p3&quot;)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;channel </span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="n">stim_chan_idxs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ch_names&quot;</span><span class="p">])[</span><span class="n">stim_chan_idxs</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2"> is not a stim or misc channel according to mne.Info&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># _name is MNE stim channel added by from_mkh5()</span>
    <span class="n">event_stream</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="p">[</span><span class="n">channel_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">event_stream</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="n">event_stream</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)),</span> <span class="n">codes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="read_raw_mkh5"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.read_raw_mkh5">[docs]</a><span class="k">def</span> <span class="nf">read_raw_mkh5</span><span class="p">(</span>
    <span class="n">mkh5_file</span><span class="p">,</span>
    <span class="n">garv_annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dblock_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fail_on_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fail_on_montage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read an mkh5 data file into MNE raw format</span>

<span class="sd">    .. deprecated:: 0.2.6</span>
<span class="sd">       Use :func:`from_mkh5`</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;mkh5mne.read_raw_mkh5() is deprecated and will be removed in a future release,&quot;</span>
        <span class="s2">&quot; use mkh5mn3.from_mkh5() instead&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">from_mkh5</span><span class="p">(</span>
        <span class="n">mkh5_file</span><span class="p">,</span>
        <span class="n">garv_annotations</span><span class="o">=</span><span class="n">garv_annotations</span><span class="p">,</span>
        <span class="n">dblock_paths</span><span class="o">=</span><span class="n">dblock_paths</span><span class="p">,</span>
        <span class="n">fail_on_info</span><span class="o">=</span><span class="n">fail_on_info</span><span class="p">,</span>
        <span class="n">fail_on_montage</span><span class="o">=</span><span class="n">fail_on_montage</span><span class="p">,</span>
        <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="from_mkh5"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.from_mkh5">[docs]</a><span class="k">def</span> <span class="nf">from_mkh5</span><span class="p">(</span>
    <span class="n">mkh5_f</span><span class="p">,</span>
    <span class="n">garv_annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dblock_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apparatus_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fail_on_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">fail_on_montage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Read an mkh5 data file into MNE raw format</span>

<span class="sd">    The mkh5 EEG data, events are converted to mne.BaseRaw for use</span>
<span class="sd">    with native MNE methods. The mkh5 timelock events and tags in the</span>
<span class="sd">    epochs tables are added to the raw data and mne.Info for use as</span>
<span class="sd">    MNE events and metadata with mne.Epochs.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mkh5_f: str</span>
<span class="sd">        File path to a mkpy.mkh5 HDF5 file</span>

<span class="sd">    garv_annotations: None | dict, optional</span>
<span class="sd">        event_channel: (str)  # channel name with events to annotate</span>
<span class="sd">        tmin, tmax: (float)  # relative to time lock event</span>
<span class="sd">        units: &quot;ms&quot; or &quot;s&quot;. Defaults to None.</span>

<span class="sd">    dblock_paths : None | list of mkh5 datablock paths, optional</span>
<span class="sd">        The listed datablock paths will be concatenated in order into the</span>
<span class="sd">        mne.Raw. Defaults to None, in which case all the data blocks in mkh5 file</span>
<span class="sd">        are concatenated in the order returned by :py:meth:`.mkh5.dblock_paths`.</span>

<span class="sd">    apparatus_yaml : None | str, optional</span>
<span class="sd">        If a path to a well-formed mkh5 apparatus map YAML file, it</span>
<span class="sd">        is used instead of the map in the mkh5 dblock header, if any.</span>
<span class="sd">        Defaults to None.</span>

<span class="sd">    fail_on_info : bool, optional</span>
<span class="sd">        If True, this enforces strict mne.Info identity across the</span>
<span class="sd">        mkh5 data blocks being concatenated. If False (default), some</span>
<span class="sd">        deviations between mne.Info for the mkh5 data blocks are</span>
<span class="sd">        allowed, e.g., for pooling multiple subject files into an</span>
<span class="sd">        experiment or separate cals for a single subject. Defaults to False.</span>

<span class="sd">    fail on montage : bool, optional</span>
<span class="sd">       If True, the mne.Montage created from the mkh5 header</span>
<span class="sd">       data streams and channel locations must be the same for all the</span>
<span class="sd">       data blocks. If False, mkh5mne allows the MNE montage to vary across mkh5 data</span>
<span class="sd">       blocks and leaves you to deal with whatever :py:meth:`mne.concatenate_raws` does</span>
<span class="sd">       in this case. Defaults to True</span>

<span class="sd">    verbose : NotImplemented</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Mkh5Raw</span>
<span class="sd">        subclassed from mne.BaseRaw for use as native MNE.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions</span>
<span class="sd">        if data block paths or apparatus map information is</span>
<span class="sd">        misspecified or the info and montage test flags are set and fail.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    EEG and events.</span>
<span class="sd">        The mkh5 data block columns are converted to mne</span>
<span class="sd">        channels and concatenated into a single mne Raw in the order</span>
<span class="sd">        given by `dblock_paths`. The default is to convert the entire</span>
<span class="sd">        mkh5 file in `mkh5.dblock_paths` order.</span>

<span class="sd">    Epochs.</span>
<span class="sd">        The mkh5 epochs table time locking events are indexed to the</span>
<span class="sd">        mne.Raw data samples and the epoch tables stored as a JSON</span>
<span class="sd">        string in the `description` field of :py:class&quot;`mne.Info`. The</span>
<span class="sd">        named mkh5 format epochs table is recovered by converting the</span>
<span class="sd">        JSON to a pandas.DataFrame which is well-formed</span>
<span class="sd">        mne.Epochs.metadata for the events on the `epochs_name` stim</span>
<span class="sd">        channel.</span>


<span class="sd">    Examples</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; mne_raw = mkh5mne(&quot;sub01.h5&quot;)</span>

<span class="sd">    &gt;&gt;&gt; mne_raw = mkh5mne.from_mkh5(</span>
<span class="sd">            &quot;sub01.h5&quot;,</span>
<span class="sd">            garv_annotations=dict(</span>
<span class="sd">                event_channel=&quot;log_evcodes&quot;, tmin=-500, tmax=500, units=&quot;ms&quot;</span>
<span class="sd">            )</span>
<span class="sd">       )</span>

<span class="sd">    &gt;&gt;&gt; mne_raw = mkh5mne(</span>
<span class="sd">            &quot;sub01.h5&quot;,</span>
<span class="sd">            dblock_paths=[&quot;sub01/dblock_0&quot;, &quot;sub01/dblock_1&quot;]  # first two dblocks only</span>
<span class="sd">        )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">Mkh5Raw</span><span class="p">(</span>
        <span class="n">mkh5_f</span><span class="p">,</span>
        <span class="n">garv_annotations</span><span class="o">=</span><span class="n">garv_annotations</span><span class="p">,</span>
        <span class="n">dblock_paths</span><span class="o">=</span><span class="n">dblock_paths</span><span class="p">,</span>
        <span class="n">apparatus_yaml</span><span class="o">=</span><span class="n">apparatus_yaml</span><span class="p">,</span>
        <span class="n">fail_on_info</span><span class="o">=</span><span class="n">fail_on_info</span><span class="p">,</span>
        <span class="n">fail_on_montage</span><span class="o">=</span><span class="n">fail_on_montage</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_garv_bads"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_garv_bads">[docs]</a><span class="k">def</span> <span class="nf">get_garv_bads</span><span class="p">(</span>
    <span class="n">mne_raw</span><span class="p">,</span>
    <span class="n">event_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">garv_channel</span><span class="o">=</span><span class="s2">&quot;log_flags&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;create mne BAD_garv annotations spanning events on a stim event channel</span>

<span class="sd">    This time locks the annotation to non-zero events on event_channel that</span>
<span class="sd">    have a non-zero codes on the log_flags column, e.g., as given by</span>
<span class="sd">    as given by running avg -x -a subNN.arf to set log_flags in</span>
<span class="sd">    subNN.log.</span>

<span class="sd">    The annotations may be attached to an mne.Raw for triggering artifact</span>
<span class="sd">    exclusion during epoching.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">        mne.Raw data object converted from mkh5</span>
<span class="sd">    event_channel : str</span>
<span class="sd">        name of the mne channel with events to annotate with BAD_garv</span>
<span class="sd">    tmin, tmax: float</span>
<span class="sd">        interval to annotate, relative to time lock event, e.g., -500, 1000</span>
<span class="sd">    unit: {&quot;ms&quot;, &quot;s&quot;}</span>
<span class="sd">        for the interval units as milliseconds or seconds</span>
<span class="sd">    garv_channel : str, optional</span>
<span class="sd">         name of the channel to check for non-zero codes at time-lock</span>
<span class="sd">         events. The default=&quot;log_flags&quot; is where avg -x puts garv rejects,</span>
<span class="sd">         other routines may use other channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mne.Annotations</span>
<span class="sd">        formatted as ``BAD_garv_N`` where N is the non-zero log_flag value</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt;  mkh5mn3.get_garv_bads(</span>
<span class="sd">             mne_raw,</span>
<span class="sd">             event_channel=&quot;p3_events&quot;,</span>
<span class="sd">             tmin=-500,</span>
<span class="sd">             tmax=1000,</span>
<span class="sd">             units=&quot;ms&quot;</span>
<span class="sd">         )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># modicum of validation</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_check_mkh5_event_channel</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">event_channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad garv interval, &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span>
            <span class="n">tmin</span> <span class="o">/=</span> <span class="mf">1000.0</span>
            <span class="n">tmax</span> <span class="o">/=</span> <span class="mf">1000.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad units, &quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;garv bads event_channel must be be a stim channel in the raw,&quot;</span>
            <span class="s2">&quot; garv interval must be tmin &lt; tmax with units &#39;ms&#39; or &#39;s&#39;&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">fail</span>

    <span class="n">garv_duration</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span>

    <span class="c1"># epoch event channel column</span>
    <span class="n">event_ch</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">event_channel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># artifact channel column</span>
    <span class="n">garv_ch</span> <span class="o">=</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">garv_channel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># lookup where in the recording the event artifact flag != 0 and log_flag != 0</span>
    <span class="n">bad_garv_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">event_ch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">garv_ch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># lower bound of annotation is time=0, upper bound is max time</span>
    <span class="n">min_t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_ch</span><span class="p">)</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span>

    <span class="c1"># trim onset underruns and duration overruns, else</span>
    <span class="n">onsets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">min_t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bad_garv_ticks</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">tmin</span><span class="p">]</span>

    <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">garv_duration</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_t</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">onsets</span><span class="p">)</span> <span class="o">+</span> <span class="n">garv_duration</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># build the integer garv code into the description</span>
    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;BAD_garv_</span><span class="si">{</span><span class="n">garv_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bad_garv_ticks</span><span class="p">]</span>

    <span class="c1"># convert to mne format annotations</span>
    <span class="n">bad_garvs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span>
        <span class="n">onset</span><span class="o">=</span><span class="n">onsets</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">descriptions</span><span class="p">,</span>
        <span class="n">orig_time</span><span class="o">=</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">orig_time</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">bad_garvs</span></div>


<div class="viewcode-block" id="get_epochs_metadata"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_epochs_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_epochs_metadata</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;retrieve mkh5 epochs table dataframe from mne.Raw.info[&quot;description&quot;]</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">       converted from a mkpy.mkh5 file that contains at least one</span>
<span class="sd">       named epochs table.</span>

<span class="sd">    epochs_name : str</span>
<span class="sd">       name of the epochs_table</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        mne.Epochs.metadata format, one row per epoch corresponding to</span>
<span class="sd">        the time-locking event at time=0.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># lots can go wrong, fail if anything does</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
        <span class="n">mkh5_epochs</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[</span><span class="s2">&quot;mkh5_epoch_tables&quot;</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">mkh5_epochs</span><span class="p">[</span><span class="n">epochs_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fail</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span><span class="si">}</span><span class="s2"> ... could not load </span><span class="si">{</span><span class="n">epochs_name</span><span class="si">}</span><span class="s2"> from &quot;</span>
            <span class="s2">&quot; mne.Info[&#39;description&#39;], check it is in mkh5.get_epochs_table_names()&quot;</span>
            <span class="s2">&quot; before converting mkh5 to MNE.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mne_raw_tick&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_epochs"><a class="viewcode-back" href="../../../api_source/mkpy.io.mkh5mne.html#mkpy.io.mkh5mne.get_epochs">[docs]</a><span class="k">def</span> <span class="nf">get_epochs</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">metadata_columns</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;retrieve mkh5 epochs table dataframe from mne.Raw.info[&quot;description&quot;]</span>

<span class="sd">    The mne.Epoch interval [tmin, tmax] matches the tmin_ms, tmax_ms</span>
<span class="sd">    interval mkh5.set_epochs(epochs_name, events, tmin_ms, tmax_ms).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mne_raw : mne.Raw</span>
<span class="sd">       The raw must have been converted from a mkpy.mkh5 file that</span>
<span class="sd">       contains at least one named epochs table.</span>

<span class="sd">    epochs_name : str</span>
<span class="sd">       Name of the epochs_table to get.</span>

<span class="sd">    metadata_columns: &quot;all&quot; or list of str, optional</span>
<span class="sd">       Specify which metadata columns to include with the epochs,</span>
<span class="sd">       default is all.</span>

<span class="sd">    **kwargs</span>
<span class="sd">       kwargs passed to mne.Epochs()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        mne.Epochs</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_epochs_metadata</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">)</span>
    <span class="n">_check_mkh5_mne_epochs_table</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">metadata_columns</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;metadata_columns must be a list of metadata column names&quot;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> is not a metadata data column&quot;</span>
    <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># epoch interval start, stop in seconds, relative to</span>
    <span class="c1"># timelocking event at mne_raw_tick</span>
    <span class="n">tmins</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;diti_hop&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">]</span>
    <span class="n">tmaxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;diti_len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mne_raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;sfreq&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">tmins</span>

    <span class="c1"># true by construction of mkh5 epochs or die</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmins</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmaxs</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="p">),</span> <span class="s2">&quot;irregular mkh5 epoch diti_hop, diti_len&quot;</span>

    <span class="n">tmin</span> <span class="o">=</span> <span class="n">tmins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">tmaxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">metadata_columns</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata_columns</span><span class="p">]</span>

    <span class="c1"># native MNE event lookup</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">find_mkh5_events</span><span class="p">(</span><span class="n">mne_raw</span><span class="p">,</span> <span class="n">epochs_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span><span class="p">(</span>
        <span class="n">mne_raw</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021 Thomas P. Urbach, Andrey Portnoy, 2013 Nathaniel Smith.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>